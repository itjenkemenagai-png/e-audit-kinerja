<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Audit Kinerja - Itjen Kemenag</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .menu-item.active { background-color: #1D4ED8; color: white; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .grouped-row-cell { vertical-align: top; padding-top: 1rem; }
        #print-preview-content, #lha-content { font-family: 'Times New Roman', Times, serif; color: black; }
        .spinner { border: 2px solid #f3f3f3; border-top: 2px solid #6366f1; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .disabled-ui { opacity: 0.5; pointer-events: none; }
        .status-indicator { transition: all 0.3s ease; }
        .lha-table { width: 100%; border-collapse: collapse; }
        .lha-table td, .lha-table th { border: 1px solid black; padding: 4px 8px; font-size: 12pt; }
        /* --- KODE BARU UNTUK TAMPILAN KERTAS A4 --- */
        .page-container {
            background-color: #e5e7eb; /* Abu-abu muda untuk latar belakang */
            padding: 2rem;
            display: flex;
            justify-content: center;
        }
        .a4-paper {
    width: 21cm;
    min-height: 29.7cm;
    padding: 2cm 1.5cm; 
    background: white;
    box-shadow: 0 0 10px rgba(0,0,0,0.15);
    page-break-after: always; 
    text-align: justify; /* <-- TAMBAHKAN BARIS INI --> */
}
        /* --- AKHIR KODE BARU --- */
        
        .searchable-dropdown { position: relative; }
        .searchable-dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1010;
            border: 1px solid #d1d5db;
            background-color: white;
            max-height: 200px;
            overflow-y: auto;
            border-radius: 0 0 0.375rem 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .searchable-dropdown-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
        }
        .searchable-dropdown-item:hover {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="modal" style="display: none; background-color: rgba(0,0,0,0.7);">
        <div class="flex flex-col items-center justify-center text-white">
            <div class="spinner" style="width: 50px; height: 50px; border-width: 4px;"></div>
            <p id="loading-text" class="mt-4 text-lg">Memuat data...</p>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="modal" style="display: flex;">
        <div class="modal-content bg-white w-11/12 md:max-w-md mx-auto rounded-lg shadow-xl p-8">
            <h2 class="text-2xl font-bold mb-6 text-center">Login e-Audit Kinerja</h2>
            <form id="login-form">
                <div class="space-y-4">
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                        <input type="text" id="username" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="password" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                </div>
                <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
                <div class="mt-6">
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Login
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Unsaved Changes Modal -->
    <div id="unsaved-changes-modal" class="modal">
        <div class="modal-content bg-white w-11/12 md:max-w-md mx-auto rounded-lg shadow-xl p-8">
            <h2 class="text-xl font-bold mb-4">Peringatan</h2>
            <p class="text-gray-600 mb-6">Anda memiliki perubahan yang belum disimpan. Apa yang ingin Anda lakukan?</p>
            <div class="flex justify-end space-x-4">
                <button id="btn-discard-changes" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Abaikan & Pindah</button>
                <button id="btn-cancel-navigation" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Batal</button>
                <button id="btn-save-and-navigate" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Simpan & Pindah</button>
            </div>
        </div>
    </div>


    <!-- MODIFIKASI: Welcome Modal diubah menjadi lebih lebar (landscape) -->
    <div id="welcome-modal" class="modal" style="display: none;">
        <div class="modal-content bg-white w-11/12 md:max-w-4xl mx-auto rounded-lg shadow-xl p-8">
            <h2 id="welcome-title" class="text-2xl font-bold mb-2 text-center">Selamat Datang di Aplikasi e-Audit Kinerja</h2>
            <p class="text-center text-gray-600 mb-8 border-b pb-6">Silakan mulai audit baru atau muat data audit yang sudah ada.</p>
            
            <div class="md:grid md:grid-cols-2 md:gap-x-12">
                <!-- Kolom Kiri: Audit -->
                <div class="space-y-6">
                    <div>
                        <h3 class="text-lg font-semibold mb-3">Muat Data Audit</h3>
                        <div class="flex items-center space-x-2">
                            <select id="select-existing-audit" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <option value="">-- Pilih Audit --</option>
                            </select>
                            <button id="btn-load-audit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 whitespace-nowrap">Muat Data</button>
                        </div>
                    </div>

                    <div id="new-audit-section" class="border-t pt-6">
                        <h3 class="text-lg font-semibold mb-3">Mulai Audit Baru</h3>
                        <div class="space-y-4">
                             <div>
                                <label for="select-new-satker" class="block text-sm font-medium text-gray-700">Pilih Satuan Kerja</label>
                                <select id="select-new-satker" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">-- Memuat Satuan Kerja --</option>
                                </select>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="text" id="input-new-st" placeholder="Masukkan Nomor Surat Tugas Baru" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <button id="btn-new-audit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 whitespace-nowrap">Mulai Baru</button>
                            </div>
                        </div>
                         <p id="welcome-error" class="text-red-500 text-sm mt-2"></p>
                    </div>
                </div>

                <!-- Kolom Kanan: Ubah Password -->
                <div class="mt-6 md:mt-0 md:border-l md:pl-12">
                     <h3 class="text-lg font-semibold mb-3">Ubah Password</h3>
                     <form id="change-password-form" class="space-y-4">
                         <div>
                             <label for="old-password" class="block text-sm font-medium text-gray-700">Password Lama</label>
                             <input type="password" id="old-password" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                         </div>
                         <div>
                             <label for="new-password" class="block text-sm font-medium text-gray-700">Password Baru</label>
                             <input type="password" id="new-password" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                         </div>
                         <div>
                             <label for="confirm-password" class="block text-sm font-medium text-gray-700">Konfirmasi Password Baru</label>
                             <input type="password" id="confirm-password" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                         </div>
                         <p id="password-change-status" class="text-sm mt-2"></p>
                         <div class="text-right">
                             <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Ubah Password</button>
                         </div>
                     </form>
                </div>
            </div>
        </div>
    </div>

    <div id="main-app-container" class="flex flex-col md:flex-row h-screen" style="display: none;">
        <!-- Sidebar Navigation -->
        <aside class="w-full md:w-64 bg-gray-800 text-white flex-shrink-0 md:overflow-y-auto">
            <div class="p-6 text-center border-b border-gray-700">
                <h1 class="text-2xl font-bold">e-Audit Kinerja</h1>
                <p class="text-sm text-gray-400">Kemenag RI</p>
            </div>
            <nav class="p-4 flex flex-col justify-between h-[calc(100vh-105px)]">
                <ul>
                    <!-- Sisipkan kode ini di dalam <ul> di <aside> -->
<li>
    <a href="#" data-menu="menu-dashboard" class="menu-item flex items-center px-4 py-3 rounded-md hover:bg-gray-700 transition" onclick="showMenu('menu-dashboard', this)">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
            <path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z" />
            <path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z" />
        </svg>
        Dashboard
    </a>
</li>
                    <li><a href="#" data-menu="menu1" class="menu-item active flex items-center px-4 py-3 rounded-md hover:bg-gray-700 transition" onclick="showMenu('menu1', this)">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>
                        Data Umum Audit</a></li>
                    <li><a href="#" data-menu="menu2" class="menu-item flex items-center px-4 py-3 rounded-md hover:bg-gray-700 transition" onclick="showMenu('menu2', this)">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                        Data Tim Audit</a></li>
                    <li><a href="#" data-menu="menu3" class="menu-item flex items-center px-4 py-3 rounded-md hover:bg-gray-700 transition" onclick="showMenu('menu3', this)">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z" /></svg>
                        Pembagian Tugas</a></li>
                    <li><a href="#" data-menu="menu4" class="menu-item flex items-center px-4 py-3 rounded-md hover:bg-gray-700 transition" onclick="showMenu('menu4', this)">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                        Kertas Kerja</a></li>
                    <li><a href="#" data-menu="menu5" class="menu-item flex items-center px-4 py-3 rounded-md hover:bg-gray-700 transition" onclick="showMenu('menu5', this)">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
                        Notisi Audit</a></li>
                    <li><a href="#" data-menu="menu6" class="menu-item flex items-center px-4 py-3 rounded-md hover:bg-gray-700 transition" onclick="showMenu('menu6', this)">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 110 2h-3a1 1 0 01-1-1v-2a1 1 0 00-1-1H9a1 1 0 00-1 1v2a1 1 0 01-1 1H4a1 1 0 110-2V4zm2 1h6a1 1 0 011 1v3a1 1 0 01-1 1H7a1 1 0 01-1-1V6a1 1 0 011-1zm1 9a1 1 0 100 2h4a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
                        LHA</a></li>
                </ul>
                <!-- Tombol Sign Out Baru -->
                <div>
                    <button onclick="handleSignOut()" class="w-full flex items-center px-4 py-3 rounded-md bg-red-600 hover:bg-red-700 text-white transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" />
                        </svg>
                        Sign Out
                    </button>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6 md:p-10 overflow-y-auto">
            <!-- Menu 1: Data Umum Audit -->
            <div id="menu1" class="menu-content">
                <div class="flex justify-between items-center mb-6 border-b pb-2">
                    <h2 class="text-3xl font-bold">1. Data Umum Audit</h2>
                    <div class="flex items-center space-x-4">
                        <span id="save-status" class="text-sm text-gray-500 italic status-indicator"></span>
                        <button onclick="saveCurrentState(false)" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z" /></svg>
                            Simpan
                        </button>
                    </div>
                </div>
                <div class="bg-white p-8 rounded-lg shadow-md">
                    <form id="form-data-umum" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="nama_audit" class="block text-sm font-medium text-gray-700">Nama Audit</label>
                            <input type="text" id="nama_audit" class="input-data-umum mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="unit_kerja" class="block text-sm font-medium text-gray-700">Unit Kerja</label>
                            <input type="text" id="unit_kerja" class="input-data-umum mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="satuan_kerja" class="block text-sm font-medium text-gray-700">Satuan Kerja</label>
                            <select id="satuan_kerja" class="input-data-umum mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm" disabled>
                                <option value="">-- Pilih Satuan Kerja --</option>
                            </select>
                        </div>
                        <div>
                            <label for="nama_satuan_kerja" class="block text-sm font-medium text-gray-700">Nama Satuan Kerja</label>
                            <input type="text" id="nama_satuan_kerja" class="input-data-umum mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        
                        <!-- Detail Pimpinan Satuan Kerja -->
                        <div class="md:col-span-2 border-t pt-6 mt-4">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Detail Pimpinan Satuan Kerja</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="md:col-span-2">
                                    <label for="alamat" class="block text-sm font-medium text-gray-700">Alamat</label>
                                    <input type="text" id="alamat" class="input-data-umum mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label for="nama_pimpinan" class="block text-sm font-medium text-gray-700">Nama Pimpinan</label>
                                    <input type="text" id="nama_pimpinan" class="input-data-umum mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label for="nip_pimpinan" class="block text-sm font-medium text-gray-700">NIP</label>
                                    <input type="text" id="nip_pimpinan" class="input-data-umum mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label for="pangkat_golongan" class="block text-sm font-medium text-gray-700">Pangkat/Golongan</label>
                                    <input type="text" id="pangkat_golongan" class="input-data-umum mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label for="jabatan_pimpinan" class="block text-sm font-medium text-gray-700">Jabatan</label>
                                    <input type="text" id="jabatan_pimpinan" class="input-data-umum mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                        </div>

                        <div class="md:col-span-2">
                            <label for="waktu_audit_mulai" class="block text-sm font-medium text-gray-700">Waktu Audit</label>
                            <div class="mt-1 flex items-center space-x-2">
                                <input type="date" id="waktu_audit_mulai" class="input-data-umum block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <span class="text-gray-500">sampai</span>
                                <input type="date" id="waktu_audit_selesai" class="input-data-umum block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>

                        <div class="md:col-span-2">
                            <label for="periode_audit_mulai" class="block text-sm font-medium text-gray-700">Periode Audit</label>
                            <div class="mt-1 flex items-center space-x-2">
                                <input type="date" id="periode_audit_mulai" class="input-data-umum block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <span class="text-gray-500">sampai</span>
                                <input type="date" id="periode_audit_selesai" class="input-data-umum block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        
                        <div>
                            <label for="no_st" class="block text-sm font-medium text-gray-700">Nomor Surat Tugas</label>
                            <input type="text" id="no_st" class="input-data-umum mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm" readonly>
                        </div>
                        <div>
                            <label for="tgl_st" class="block text-sm font-medium text-gray-700">Tanggal Surat Tugas</label>
                            <input type="date" id="tgl_st" class="input-data-umum mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        
                        <div class="md:col-span-2 border-t pt-6 mt-4">
                             <h3 class="text-lg font-medium text-gray-900 mb-4">Bobot Tahap Kinerja Audit</h3>
                             <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                                 <div>
                                     <label for="bobot_perencanaan" class="block text-sm font-medium text-gray-700">Tahap Perencanaan</label>
                                     <input type="number" id="bobot_perencanaan" value="15" class="input-data-umum stage-weight-input mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                 </div>
                                 <div>
                                     <label for="bobot_pelaksanaan" class="block text-sm font-medium text-gray-700">Tahap Pelaksanaan</label>
                                     <input type="number" id="bobot_pelaksanaan" value="65" class="input-data-umum stage-weight-input mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                 </div>
                                 <div>
                                     <label for="bobot_evaluasi" class="block text-sm font-medium text-gray-700">Tahap Evaluasi & Pelaporan</label>
                                     <input type="number" id="bobot_evaluasi" value="10" class="input-data-umum stage-weight-input mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                 </div>
                                 <div>
                                     <label for="bobot_pencapaian" class="block text-sm font-medium text-gray-700">Tahap Pencapaian Hasil</label>
                                     <input type="number" id="bobot_pencapaian" value="10" class="input-data-umum stage-weight-input mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                 </div>
                             </div>
                        </div>

                        <!-- Rekapitulasi Hasil Audit -->
                        <div class="md:col-span-2 border-t pt-6 mt-4">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Rekapitulasi Hasil Audit</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full border border-gray-300 text-center">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 border border-gray-300 font-medium text-gray-600">Tahapan/Penilaian</th>
                                            <th class="px-4 py-2 border border-gray-300 font-medium text-gray-600">Tahap Perencanaan</th>
                                            <th class="px-4 py-2 border border-gray-300 font-medium text-gray-600">Tahap Pelaksanaan</th>
                                            <th class="px-4 py-2 border border-gray-300 font-medium text-gray-600">Tahap Evaluasi & Pelaporan</th>
                                            <th class="px-4 py-2 border border-gray-300 font-medium text-gray-600">Tahap Pencapaian Hasil</th>
                                            <th class="px-4 py-2 border border-gray-300 font-medium text-gray-600">TOTAL</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="px-4 py-2 border border-gray-300 font-medium text-left">Bobot</td>
                                            <td id="rekap-bobot-perencanaan" class="px-4 py-2 border border-gray-300">0</td>
                                            <td id="rekap-bobot-pelaksanaan" class="px-4 py-2 border border-gray-300">0</td>
                                            <td id="rekap-bobot-evaluasi" class="px-4 py-2 border border-gray-300">0</td>
                                            <td id="rekap-bobot-pencapaian" class="px-4 py-2 border border-gray-300">0</td>
                                            <td id="rekap-bobot-total" class="px-4 py-2 border border-gray-300 font-bold">0</td>
                                        </tr>
                                        <tr>
                                            <td class="px-4 py-2 border border-gray-300 font-medium text-left">Hasil</td>
                                            <td id="rekap-hasil-perencanaan" class="px-4 py-2 border border-gray-300">0,00</td>
                                            <td id="rekap-hasil-pelaksanaan" class="px-4 py-2 border border-gray-300">0,00</td>
                                            <td id="rekap-hasil-evaluasi" class="px-4 py-2 border border-gray-300">0,00</td>
                                            <td id="rekap-hasil-pencapaian" class="px-4 py-2 border border-gray-300">0,00</td>
                                            <td id="rekap-hasil-total" class="px-4 py-2 border border-gray-300 font-bold">0,00</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-4 flex items-stretch space-x-4">
                                <div class="w-1/2 p-4 border border-gray-300 rounded-lg flex items-center justify-center">
                                    <p class="text-lg font-medium">SKOR KINERJA</p>
                                    <p id="skor-kinerja" class="ml-4 text-4xl font-bold text-gray-800">0</p>
                                </div>
                                <div id="kategori-container" class="w-1/2 p-4 border border-gray-300 rounded-lg flex items-center justify-center bg-gray-100">
                                    <p id="kategori-kinerja" class="text-4xl font-bold text-gray-500">-</p>
                                </div>
                            </div>
                        </div>

                        <!-- Skor 3E -->
                        <div class="md:col-span-2 border-t pt-6 mt-4">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Skor 3E (Ekonomis, Efisien, Efektif)</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full border border-gray-300 text-center">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 border border-gray-300 font-medium text-gray-600 text-left">Aspek</th>
                                            <th class="px-4 py-2 border border-gray-300 font-medium text-gray-600">Hasil</th>
                                            <th class="px-4 py-2 border border-gray-300 font-medium text-gray-600">Bobot</th>
                                            <th class="px-4 py-2 border border-gray-300 font-medium text-gray-600">SKOR</th>
                                            <th class="px-4 py-2 border border-gray-300 font-medium text-gray-600">Kualitas Kinerja</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabel-skor-3e">
                                        <!-- Data diisi oleh JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Rekapitulasi Temuan Keuangan -->
                        <div class="md:col-span-2 border-t pt-6 mt-4">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Rekapitulasi Temuan Keuangan</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full border border-gray-300 text-center">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 border border-gray-300 font-medium text-gray-600">Anggaran Diaudit</th>
                                            <th class="px-4 py-2 border border-gray-300 font-medium text-gray-600">Temuan Keuangan</th>
                                            <th class="px-4 py-2 border border-gray-300 font-medium text-gray-600">Tindak Lanjut</th>
                                            <th class="px-4 py-2 border border-gray-300 font-medium text-gray-600">Saldo</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td id="rekap-anggaran-diaudit" class="px-4 py-2 border border-gray-300">Rp 0</td>
                                            <td id="rekap-temuan-keuangan" class="px-4 py-2 border border-gray-300">Rp 0</td>
                                            <td id="rekap-tindak-lanjut" class="px-4 py-2 border border-gray-300">Rp 0</td>
                                            <td id="rekap-saldo" class="px-4 py-2 border border-gray-300 font-bold">Rp 0</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Statistik Progres Audit -->
                        <div class="md:col-span-2 border-t pt-6 mt-4">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Statistik Progres Audit</h3>
                            <div class="space-y-6">
                                <div>
                                    <h4 class="text-md font-semibold text-gray-700 mb-2">Berdasarkan Tahap</h4>
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full border border-gray-300 text-center">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th class="px-4 py-2 border border-gray-300 font-medium text-gray-600 text-left">Tahap</th>
                                                    <th class="px-4 py-2 border border-gray-300 font-medium text-gray-600">Jumlah KKA</th>
                                                    <th class="px-4 py-2 border border-gray-300 font-medium text-gray-600">Belum Diaudit</th>
                                                    <th class="px-4 py-2 border border-gray-300 font-medium text-gray-600">Sedang Audit</th>
                                                    <th class="px-4 py-2 border border-gray-300 font-medium text-gray-600">Selesai</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tabel-progres-tahap">
                                                <!-- Data diisi oleh JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="text-md font-semibold text-gray-700 mb-2">Berdasarkan Auditor</h4>
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full border border-gray-300 text-center">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th class="px-4 py-2 border border-gray-300 font-medium text-gray-600 text-left">Auditor</th>
                                                    <th class="px-4 py-2 border border-gray-300 font-medium text-gray-600">Jumlah KKA</th>
                                                    <th class="px-4 py-2 border border-gray-300 font-medium text-gray-600">Belum Diaudit</th>
                                                    <th class="px-4 py-2 border border-gray-300 font-medium text-gray-600">Sedang Audit</th>
                                                    <th class="px-4 py-2 border border-gray-300 font-medium text-gray-600">Selesai</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tabel-progres-auditor">
                                                <!-- Data diisi oleh JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </form>
                </div>
            </div>

            <!-- Menu 2: Data Tim Audit -->
            <div id="menu2" class="menu-content hidden">
                <div class="flex justify-between items-center mb-6 border-b pb-2">
                    <h2 class="text-3xl font-bold">2. Data Tim Audit</h2>
                     <div class="flex items-center space-x-4">
                        <span id="save-status-menu2" class="text-sm text-gray-500 italic status-indicator"></span>
                        <button onclick="saveCurrentState(false)" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z" /></svg>
                            Simpan
                        </button>
                    </div>
                </div>
                <div class="bg-white p-8 rounded-lg shadow-md mb-6">
                    <h3 class="text-xl font-semibold mb-4">Input Anggota Tim</h3>
                    <form id="form-tim-audit" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div class="md:col-span-2 searchable-dropdown">
                            <label for="nama_auditor_search" class="block text-sm font-medium text-gray-700">Nama</label>
                            <input type="text" id="nama_auditor_search" autocomplete="off" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Ketik untuk mencari nama..." required>
                            <input type="hidden" id="nama_auditor">
                            <div id="nama_auditor_list" class="searchable-dropdown-list hidden"></div>
                        </div>
                        <div>
                            <label for="nip_auditor" class="block text-sm font-medium text-gray-700">NIP</label>
                            <input type="text" id="nip_auditor" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label for="jabatan_tim" class="block text-sm font-medium text-gray-700">Jabatan dalam Tim</label>
                            <select id="jabatan_tim" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <option>Penanggung Jawab</option>
                                <option>Pengendali Mutu</option>
                                <option>Pengendali Teknis</option>
                                <option>Ketua Tim</option>
                                <option>Anggota</option>
                            </select>
                        </div>
                        <div class="md:col-span-4 text-right">
                             <button type="submit" id="submit-team-btn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                 Tambah Tim
                             </button>
                        </div>
                    </form>
                </div>
                <div class="bg-white p-8 rounded-lg shadow-md">
                   <h3 class="text-xl font-semibold mb-4">Daftar Tim Audit</h3>
                   <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIP</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jabatan</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="tabel-tim-audit" class="bg-white divide-y divide-gray-200">
                                <!-- Data tim akan diisi oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Menu 3: Pembagian Tugas Tim -->
            <div id="menu3" class="menu-content hidden">
                 <div class="flex justify-between items-center mb-6 border-b pb-2">
                    <h2 class="text-3xl font-bold">3. Pembagian Tugas Tim</h2>
                     <div class="flex items-center space-x-4">
                        <span id="save-status-menu3" class="text-sm text-gray-500 italic status-indicator"></span>
                        <button onclick="saveCurrentState(false)" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z" /></svg>
                            Simpan
                        </button>
                    </div>
                 </div>
                 <div class="bg-white p-8 rounded-lg shadow-md">
                       <div class="overflow-x-auto">
                           <table class="min-w-full">
                               <thead class="bg-gray-50">
                                   <tr>
                                       <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode KKA</th>
                                       <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sub KKA</th>
                                       <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fungsi/Tugas</th>
                                       <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Indikator Kinerja</th>
                                       <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bobot</th>
                                       <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dinilai?</th>
                                       <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">Auditor</th>
                                   </tr>
                               </thead>
                               <tbody id="tabel-pembagian-tugas" class="bg-white divide-y divide-gray-200">
                                   <!-- Data tugas akan diisi oleh JavaScript -->
                               </tbody>
                           </table>
                       </div>
                 </div>
            </div>

            <!-- Menu 4: Kertas Kerja -->
            <div id="menu4" class="menu-content hidden">
                <div class="flex justify-between items-center mb-6 border-b pb-2">
                    <h2 class="text-3xl font-bold">4. Kertas Kerja Auditor</h2>
                </div>
                <div class="bg-white p-8 rounded-lg shadow-md">
                    <div id="filter-section-menu4" class="mb-6">
                        <div id="nip-input-container-4">
                            <label for="filter-auditor-nip" class="block text-sm font-medium text-gray-700">Cari Auditor Berdasarkan NIP:</label>
                            <input type="text" id="filter-auditor-nip" class="mt-1 block w-full md:w-1/3 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Ketik NIP untuk mencari...">
                            <p id="auditor-info-display-4" class="mt-2 text-sm text-gray-600 font-medium"></p>
                        </div>
                        <div id="anggota-selector-container" class="mt-4">
                            <label for="anggota-selector" class="block text-sm font-medium text-gray-700">Pilih Anggota untuk Dilihat:</label>
                            <select id="anggota-selector" class="mt-1 block w-full md:w-1/3 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></select>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode KKA</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Indikator Kinerja</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bobot</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nilai</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hasil</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status Reviu</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="tabel-kertas-kerja" class="bg-white divide-y divide-gray-200">
                                <!-- Data KKA per auditor akan diisi oleh JavaScript -->
                            </tbody>
                        </table>
                        <p id="no-task-message" class="text-center text-gray-500 py-8 hidden">Tidak ada tugas yang diberikan untuk auditor ini.</p>
                    </div>
                </div>
            </div>
            
            <!-- Menu 5: Notisi Audit -->
            <div id="menu5" class="menu-content hidden">
                <div class="flex justify-between items-center mb-6 border-b pb-2">
                    <h2 class="text-3xl font-bold">5. Notisi Audit</h2>
                    <!-- Tombol ini akan kita fungsikan -->
                    <button id="btn-open-print-selection" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v3a2 2 0 002 2h6a2 2 0 002-2v-3h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v3h6v-3z" clip-rule="evenodd" /></svg>
                        Cetak Notisi
                    </button>
                </div>
                <div class="bg-white p-8 rounded-lg shadow-md">
                    <div id="filter-section-menu5" class="mb-6">
                        <div id="nip-input-container-5" class="flex justify-between items-center">
                             <div>
                                <label for="filter-auditor-notisi-nip" class="block text-sm font-medium text-gray-700">Cari Auditor Berdasarkan NIP:</label>
                                <input type="text" id="filter-auditor-notisi-nip" class="mt-1 block w-full md:w-80 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Ketik NIP untuk mencari...">
                            </div>
                            <button id="btn-open-print-selection" class="hidden inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v3a2 2 0 002 2h6a2 2 0 002-2v-3h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v3h6v-3z" clip-rule="evenodd" /></svg>
                                Cetak Notisi
                            </button>
                        </div>
                        <p id="auditor-info-display-5" class="mt-2 text-sm text-gray-600 font-medium"></p>
                         <div id="anggota-selector-container-notisi" class="mt-4">
                            <label for="anggota-selector-notisi" class="block text-sm font-medium text-gray-700">Pilih Anggota untuk Dilihat:</label>
                            <select id="anggota-selector-notisi" class="mt-1 block w-full md:w-1/3 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></select>
                        </div>
                    </div>
                    <div class="overflow-x-auto mt-4">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode KKA</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Indikator Kinerja</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bobot</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nilai</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hasil</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status Reviu</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="tabel-notisi-audit" class="bg-white divide-y divide-gray-200">
                                <!-- Data Notisi Audit akan diisi oleh JavaScript -->
                            </tbody>
                        </table>
                        <p id="no-finding-message" class="text-center text-gray-500 py-8 hidden">Tidak ada temuan (nilai < 1) untuk auditor ini.</p>
                    </div>
                </div>
            </div>

            <!-- Menu 6: LHA -->
            <!-- Menu 6: LHA -->
            <div id="menu6" class="menu-content hidden">
                <div class="flex justify-between items-center mb-6 border-b pb-2">
                    <h2 class="text-3xl font-bold">6. Laporan Hasil Audit (LHA)</h2>
                    <div class="flex space-x-2">
                        <button id="btn-print-lha" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v3a2 2 0 002 2h6a2 2 0 002-2v-3h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v3h6v-3z" clip-rule="evenodd" /></svg>
                            Cetak
                        </button>
                        <button id="btn-export-lha-word" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z" /></svg>
                            Export to Word
                        </button>
                    </div>
                </div>
                <!-- PERUBAHAN UTAMA DI SINI -->
                <div class="page-container">
                    <div id="lha-content" class="a4-paper prose max-w-none">
                        <!-- Konten LHA akan di-generate oleh JavaScript di sini -->
                    </div>
                </div>
            </div>
<!-- Sisipkan seluruh blok ini di dalam <main> setelah div menu6 -->
<div id="menu-dashboard" class="menu-content hidden">
    <div class="flex justify-between items-center mb-6 border-b pb-2">
        <h2 class="text-3xl font-bold">Dashboard Audit Kinerja</h2>
    </div>

    <!-- Filter Global -->
    <div class="bg-white p-4 rounded-lg shadow-md mb-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label for="dashboard-filter-satker" class="block text-sm font-medium text-gray-700">Filter Satuan Kerja</label>
                <select id="dashboard-filter-satker" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="semua">Semua Satker</option>
                    <!-- Opsi akan diisi oleh JavaScript -->
                </select>
            </div>
            <div>
                <label for="dashboard-filter-tahap" class="block text-sm font-medium text-gray-700">Filter Tahap Audit</label>
                <select id="dashboard-filter-tahap" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="semua">Semua Tahap</option>
                    <option value="Tahap Perencanaan">Tahap Perencanaan</option>
                    <option value="Tahap Pelaksanaan">Tahap Pelaksanaan</option>
                    <option value="Tahap Evaluasi & Pelaporan">Tahap Evaluasi & Pelaporan</option>
                    <option value="Tahap Pencapaian Hasil/Outcome">Tahap Pencapaian Hasil</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Scorecard Utama -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6 mb-6">
        <div class="bg-white p-5 rounded-lg shadow-md text-center">
            <h4 class="text-sm font-medium text-gray-500">Nilai Total Rata-rata</h4>
            <p id="scorecard-total" class="text-3xl font-bold mt-2">-</p>
        </div>
        <div class="bg-white p-5 rounded-lg shadow-md text-center">
            <h4 class="text-sm font-medium text-gray-500">Skor Perencanaan</h4>
            <p id="scorecard-perencanaan" class="text-3xl font-bold mt-2">-%</p>
        </div>
        <div class="bg-white p-5 rounded-lg shadow-md text-center">
            <h4 class="text-sm font-medium text-gray-500">Skor Pelaksanaan</h4>
            <p id="scorecard-pelaksanaan" class="text-3xl font-bold mt-2">-%</p>
        </div>
        <div class="bg-white p-5 rounded-lg shadow-md text-center">
            <h4 class="text-sm font-medium text-gray-500">Skor Evaluasi</h4>
            <p id="scorecard-evaluasi" class="text-3xl font-bold mt-2">-%</p>
        </div>
        <div class="bg-white p-5 rounded-lg shadow-md text-center">
            <h4 class="text-sm font-medium text-gray-500">Skor Pencapaian</h4>
            <p id="scorecard-pencapaian" class="text-3xl font-bold mt-2">-%</p>
        </div>
    </div>

<!-- Rekapitulasi Hasil Audit Rata-rata -->
    <div class="bg-white p-5 rounded-lg shadow-md mb-6">
        <h3 class="font-semibold mb-4">Rekapitulasi Hasil Audit Rata-rata</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full border border-gray-300 text-center">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 border border-gray-300 font-medium text-gray-600">Tahapan/Penilaian</th>
                        <th class="px-4 py-2 border border-gray-300 font-medium text-gray-600">Tahap Perencanaan</th>
                        <th class="px-4 py-2 border border-gray-300 font-medium text-gray-600">Tahap Pelaksanaan</th>
                        <th class="px-4 py-2 border border-gray-300 font-medium text-gray-600">Tahap Evaluasi & Pelaporan</th>
                        <th class="px-4 py-2 border border-gray-300 font-medium text-gray-600">Tahap Pencapaian Hasil</th>
                        <th class="px-4 py-2 border border-gray-300 font-medium text-gray-600">TOTAL</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="px-4 py-2 border border-gray-300 font-medium text-left">Bobot</td>
                        <td class="px-4 py-2 border border-gray-300">15</td>
                        <td class="px-4 py-2 border border-gray-300">65</td>
                        <td class="px-4 py-2 border border-gray-300">10</td>
                        <td class="px-4 py-2 border border-gray-300">10</td>
                        <td class="px-4 py-2 border border-gray-300 font-bold">100</td>
                    </tr>
                    <tr>
                        <td class="px-4 py-2 border border-gray-300 font-medium text-left">Rata-rata Hasil</td>
                        <td id="rekap-avg-hasil-perencanaan" class="px-4 py-2 border border-gray-300">0,00</td>
                        <td id="rekap-avg-hasil-pelaksanaan" class="px-4 py-2 border border-gray-300">0,00</td>
                        <td id="rekap-avg-hasil-evaluasi" class="px-4 py-2 border border-gray-300">0,00</td>
                        <td id="rekap-avg-hasil-pencapaian" class="px-4 py-2 border border-gray-300">0,00</td>
                        <td id="rekap-avg-hasil-total" class="px-4 py-2 border border-gray-300 font-bold">0,00</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="mt-4 flex items-stretch space-x-4">
            <div class="w-1/2 p-4 border border-gray-300 rounded-lg flex items-center justify-center">
                <p class="text-lg font-medium">SKOR KINERJA RATA-RATA</p>
                <p id="skor-kinerja-avg" class="ml-4 text-4xl font-bold text-gray-800">0</p>
            </div>
            <div id="kategori-container-avg" class="w-1/2 p-4 border border-gray-300 rounded-lg flex items-center justify-center bg-gray-100">
                <p id="kategori-kinerja-avg" class="text-4xl font-bold text-gray-500">-</p>
            </div>
        </div>
    </div>

    <!-- Visualisasi Grafik -->
    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-6">
        <div class="lg:col-span-3 bg-white p-5 rounded-lg shadow-md">
            <h3 class="font-semibold mb-4">Nilai Kinerja per Satuan Kerja</h3>
            <canvas id="chart-kinerja-satker"></canvas>
        </div>
        <div class="lg:col-span-2 bg-white p-5 rounded-lg shadow-md">
            <h3 class="font-semibold mb-4">Proporsi Temuan Keuangan</h3>
            <canvas id="chart-temuan-keuangan"></canvas>
        </div>
         <div class="lg:col-span-5 bg-white p-5 rounded-lg shadow-md">
            <h3 class="font-semibold mb-4">Persentase Capaian per Tahap</h3>
            <canvas id="chart-capaian-tahap"></canvas>
        </div>
    </div>

    <!-- Tabel Data Rinci -->
    <div class="grid grid-cols-1 gap-6 mb-6">
        <div class="bg-white p-5 rounded-lg shadow-md">
            <h3 class="font-semibold mb-4">Rincian Capaian Kinerja</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Satuan Kerja</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Perencanaan</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Pelaksanaan</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Evaluasi</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Pencapaian</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Kategori</th>
                        </tr>
                    </thead>
                    <tbody id="table-kinerja-body" class="bg-white divide-y divide-gray-200">
                        <!-- Data diisi oleh JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="bg-white p-5 rounded-lg shadow-md">
            <h3 class="font-semibold mb-4">Rincian Temuan Keuangan</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Satuan Kerja</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Anggaran Diaudit</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Temuan Keuangan</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Tindak Lanjut</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Saldo</th>
                        </tr>
                    </thead>
                    <tbody id="table-keuangan-body" class="bg-white divide-y divide-gray-200">
                        <!-- Data diisi oleh JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Analisis Cerdas -->
    <div class="bg-white p-5 rounded-lg shadow-md">
        <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
            <h3 class="font-semibold w-full sm:w-auto">Laporan Konsolidasi Otomatis</h3>
            <div class="flex items-center gap-2 flex-wrap">
                <input type="date" id="report-start-date" class="px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                <span class="text-gray-500">s/d</span>
                <input type="date" id="report-end-date" class="px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                <button id="btn-generate-summary" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 ml-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M11.983 1.904a1 1 0 00-1.966 0l-1.34 4.142a1 1 0 01-.95.69h-4.344a1 1 0 000 1.966h4.343a1 1 0 01.95.69l1.34 4.142a1 1 0 001.966 0l1.34-4.142a1 1 0 01.95-.69h4.345a1 1 0 000-1.966h-4.344a1 1 0 01-.95-.69L11.983 1.904z" /></svg>
                    Generate Laporan
                </button>
            </div>
        </div>
        <textarea id="ai-summary-textarea" rows="15" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm" readonly placeholder="Pilih rentang tanggal dan klik 'Generate Laporan' untuk membuat Laporan Hasil Audit Kinerja Konsolidasi..."></textarea>
        <div id="ai-summary-spinner" class="hidden flex items-center justify-center mt-4">
            <div class="spinner"></div>
            <p class="ml-2 text-gray-600">Menganalisis data, mohon tunggu...</p>
        </div>
    </div>
</div>
        </main>
    </div>

    <!-- Modal Kertas Kerja Audit -->
    <div id="audit-modal" class="modal">
        <div class="modal-content bg-white w-11/12 md:max-w-4xl mx-auto rounded-lg shadow-xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-5 border-b">
                <h3 id="modal-title" class="text-2xl font-bold text-gray-800">Detail Kertas Kerja Audit</h3>
                <button id="close-modal" class="text-gray-400 hover:text-gray-600 text-3xl font-bold">&times;</button>
            </div>
            <div id="modal-body" class="p-6 overflow-y-auto">
                <!-- Konten modal akan diisi oleh JavaScript -->
            </div>
             <div id="modal-footer" class="p-4 bg-gray-50 border-t flex justify-end items-center">
                <p id="modal-error" class="text-red-600 text-sm mr-auto font-medium"></p>
                <button id="edit-audit-btn" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 mr-2 hidden">Edit</button>
                <button id="save-progress-btn" class="px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 mr-2">Simpan</button>
                <button id="finish-audit-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 mr-2">Selesai</button>
                <button id="close-modal-footer" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Modal Print Selection -->
    <div id="print-selection-modal" class="modal">
        <div class="modal-content bg-white w-11/12 md:max-w-2xl mx-auto rounded-lg shadow-xl">
            <div class="flex justify-between items-center p-5 border-b">
                <h3 class="text-xl font-bold text-gray-800">Pilih Kode KKA yang akan dicetak</h3>
                <button id="close-print-selection-modal" class="text-gray-400 hover:text-gray-600 text-3xl font-bold">&times;</button>
            </div>
            <div id="print-selection-body" class="p-6 max-h-[60vh] overflow-y-auto">
                <!-- Checkbox list will be generated here -->
            </div>
            <div class="p-4 bg-gray-50 border-t flex justify-end">
                <button id="btn-generate-print-preview" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Cetak</button>
            </div>
        </div>
    </div>

    <!-- Modal Print Preview -->
    <div id="print-preview-modal" class="modal">
        <div class="modal-content bg-white w-11/12 md:max-w-4xl mx-auto rounded-lg shadow-xl max-h-[95vh] flex flex-col">
            <div class="flex justify-between items-center p-5 border-b">
                <h3 class="text-xl font-bold text-gray-800">Preview Notisi Audit</h3>
                <button id="close-print-preview-modal" class="text-gray-400 hover:text-gray-600 text-3xl font-bold">&times;</button>
            </div>
            <div id="print-preview-body" class="p-8 overflow-y-auto bg-white">
                <div id="print-preview-content" class="p-4 border">
                    <!-- Print content will be generated here -->
                </div>
            </div>
            <div class="p-4 bg-gray-50 border-t flex justify-end space-x-2">
                <button id="btn-export-word" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Export to Word</button>
                <button id="btn-export-pdf" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Export to PDF</button>
            </div>
        </div>
    </div>


    <script>
        // --- KONFIGURASI ---
        const GAS_URL = "https://script.google.com/macros/s/AKfycbz1Q9rk4ELD8EkUPcDXiF7uFJbk8Du0BL78Rc03SdjwCrQrOYAwSkFxURnwX5YKcErz/exec";

        // --- STATE APLIKASI ---
        // Tambahkan di bawah // --- STATE APLIKASI ---
        let allAuditsData = []; // Untuk menyimpan semua data audit
        let chartKinerjaSatker, chartTemuanKeuangan, chartCapaianTahap; // Variabel untuk instance chart
        let loggedInUser = { username: null, nip: null, nama: null }; 
        let allUsers = []; 
        let currentUserRole = null; 
        let fullMasterKKA = []; 
        let kkaData = []; 
        let auditTeam = [];
        let editingIndex = null;
        let taskAssignments = {};
        let auditFindings = {};
        let auditStatus = {};
        let reviewNotes = {};
        let reviewState = {};
        let reviewApprovalStatus = {};
        let indicatorStatus = {};
        let isSaving = false;
        let isDataDirty = false; 
        let navigationTarget = { menuId: null, element: null }; 
        let isNavigating = false; 
        let pollingIntervalId = null;

        // --- DOM Elements ---
        // Tambahkan di bawah // --- DOM Elements ---
        const dashboardFilterSatker = document.getElementById('dashboard-filter-satker');
        const dashboardFilterTahap = document.getElementById('dashboard-filter-tahap');
        const scorecardTotal = document.getElementById('scorecard-total');
        const scorecardPerencanaan = document.getElementById('scorecard-perencanaan');
        const scorecardPelaksanaan = document.getElementById('scorecard-pelaksanaan');
        const scorecardEvaluasi = document.getElementById('scorecard-evaluasi');
        const scorecardPencapaian = document.getElementById('scorecard-pencapaian');
        const tableKinerjaBody = document.getElementById('table-kinerja-body');
        const tableKeuanganBody = document.getElementById('table-keuangan-body');
        const btnGenerateSummary = document.getElementById('btn-generate-summary');
        const aiSummaryTextarea = document.getElementById('ai-summary-textarea');
        const aiSummarySpinner = document.getElementById('ai-summary-spinner');
        const loginModal = document.getElementById('login-modal');
        const welcomeModal = document.getElementById('welcome-modal');
        const mainAppContainer = document.getElementById('main-app-container');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const menuContents = document.querySelectorAll('.menu-content');
        const menuItems = document.querySelectorAll('.menu-item');
        const formTimAudit = document.getElementById('form-tim-audit');
        const tabelTimAuditBody = document.getElementById('tabel-tim-audit');
        const tabelPembagianTugasBody = document.getElementById('tabel-pembagian-tugas');
        const filterAuditorNipInput = document.getElementById('filter-auditor-nip');
        const auditorInfoDisplay4 = document.getElementById('auditor-info-display-4');
        const anggotaSelectorContainer = document.getElementById('anggota-selector-container');
        const anggotaSelector = document.getElementById('anggota-selector');
        const filterAuditorNotisiNipInput = document.getElementById('filter-auditor-notisi-nip');
        const auditorInfoDisplay5 = document.getElementById('auditor-info-display-5');
        const anggotaSelectorContainerNotisi = document.getElementById('anggota-selector-container-notisi');
        const anggotaSelectorNotisi = document.getElementById('anggota-selector-notisi');
        const tabelKertasKerjaBody = document.getElementById('tabel-kertas-kerja');
        const noTaskMessage = document.getElementById('no-task-message');
        const tabelNotisiAuditBody = document.getElementById('tabel-notisi-audit');
        const noFindingMessage = document.getElementById('no-finding-message');
        const modal = document.getElementById('audit-modal');
        const modalBody = document.getElementById('modal-body');
        const closeModalBtn = document.getElementById('close-modal');
        const closeModalFooterBtn = document.getElementById('close-modal-footer');
        const saveProgressBtn = document.getElementById('save-progress-btn');
        const finishAuditBtn = document.getElementById('finish-audit-btn');
        const editAuditBtn = document.getElementById('edit-audit-btn');
        const btnOpenPrintSelection = document.getElementById('btn-open-print-selection');
        const printSelectionModal = document.getElementById('print-selection-modal');
        const closePrintSelectionModalBtn = document.getElementById('close-print-selection-modal');
        const printSelectionBody = document.getElementById('print-selection-body');
        const btnGeneratePrintPreview = document.getElementById('btn-generate-print-preview');
        const printPreviewModal = document.getElementById('print-preview-modal');
        const closePrintPreviewModalBtn = document.getElementById('close-print-preview-modal');
        const printPreviewContent = document.getElementById('print-preview-content');
        const btnExportWord = document.getElementById('btn-export-word');
        const btnExportPdf = document.getElementById('btn-export-pdf');
        const saveStatusIndicators = document.querySelectorAll('.status-indicator');

        // --- FUNGSI UTAMA & ALUR APLIKASI ---

document.addEventListener('DOMContentLoaded', () => {
    // Event listeners untuk form utama
    document.getElementById('login-form').addEventListener('submit', handleLogin);
    document.getElementById('change-password-form').addEventListener('submit', handleChangePassword);

    // Event listener untuk menandai perubahan data
    mainAppContainer.addEventListener('input', handleDataChange);
    mainAppContainer.addEventListener('change', handleDataChange);

    // Event listeners untuk modal selamat datang
    document.getElementById('btn-load-audit').addEventListener('click', handleLoadAudit);
    document.getElementById('btn-new-audit').addEventListener('click', handleNewAudit);

    // Event listeners untuk modal "perubahan belum disimpan"
    document.getElementById('btn-cancel-navigation').addEventListener('click', () => {
        document.getElementById('unsaved-changes-modal').style.display = 'none';
        isNavigating = false;
    });
    document.getElementById('btn-print-lha').addEventListener('click', () => {
        window.print();
    });
    document.getElementById('btn-discard-changes').addEventListener('click', () => {
        isDataDirty = false;
        document.getElementById('unsaved-changes-modal').style.display = 'none';
        if (navigationTarget.menuId === 'signout') {
            window.location.reload();
        } else if (navigationTarget.menuId) {
            performNavigation(navigationTarget.menuId, navigationTarget.element);
        }
    });
    document.getElementById('btn-save-and-navigate').addEventListener('click', async () => {
        isNavigating = true;
        await saveCurrentState(false);
        document.getElementById('unsaved-changes-modal').style.display = 'none';
        if (navigationTarget.menuId === 'signout') {
            window.location.reload();
        } else if (navigationTarget.menuId) {
            performNavigation(navigationTarget.menuId, navigationTarget.element);
        }
    });

    // Event listeners untuk filter NIP
    filterAuditorNipInput.addEventListener('input', (e) => handleNipFilter(e, 'worksheet'));
    filterAuditorNotisiNipInput.addEventListener('input', (e) => handleNipFilter(e, 'notice'));

    // Event listeners untuk ekspor dokumen
    document.getElementById('btn-export-lha-word').addEventListener('click', exportLhaToWord);
    btnExportWord.addEventListener('click', exportToWord);
    btnExportPdf.addEventListener('click', exportToPdf);

    // PERBAIKAN: Pindahkan event listener modal ke document untuk memastikan selalu aktif
    document.addEventListener('input', handleReviewChange);
    document.addEventListener('click', handleReviewActions);
});

        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginError = document.getElementById('login-error');
            loginError.textContent = '';
            showLoading('Memverifikasi...');

            try {
                // PERBAIKAN: Mengubah metode menjadi POST untuk mengatasi masalah CORS
                const payload = {
                    action: 'checkLogin',
                    username: username,
                    password: password
                };

                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    // Menggunakan text/plain adalah praktik umum untuk menghindari pre-flight request yang rumit dengan Apps Script
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8', 
                    },
                    body: JSON.stringify(payload),
                    redirect: 'follow' // Menambahkan ini untuk keamanan ekstra
                });
                // AKHIR PERBAIKAN

                const result = await response.json();

                if (result.status === 'success') {
                    loggedInUser = { username: result.username, nip: result.nip, nama: result.nama };
                    document.getElementById('welcome-title').textContent = `Selamat Datang Bapak/Ibu ${result.nama}`;

                    loginModal.style.display = 'none';
                    welcomeModal.style.display = 'flex';
                    
                    await Promise.all([
                        loadAuditList(),
                        loadSatuanKerjaList(),
                        loadUsersList() 
                    ]);

                } else {
                    loginError.textContent = result.message || 'Login gagal.';
                }
            } catch (error) {
                loginError.textContent = 'Terjadi kesalahan. Coba lagi.';
                console.error('Login error:', error);
            } finally {
                hideLoading();
            }
        }

        async function handleChangePassword(event) {
            event.preventDefault();
            const oldPassword = document.getElementById('old-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const statusEl = document.getElementById('password-change-status');
            statusEl.textContent = '';
            statusEl.classList.remove('text-green-600', 'text-red-600');

            if (newPassword !== confirmPassword) {
                statusEl.textContent = 'Password baru tidak cocok.';
                statusEl.classList.add('text-red-600');
                return;
            }

            showLoading('Mengubah password...');
            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'changePassword',
                        username: loggedInUser.username,
                        oldPassword: oldPassword,
                        newPassword: newPassword
                    })
                });
                statusEl.textContent = 'Password berhasil diubah.';
                statusEl.classList.add('text-green-600');
                document.getElementById('change-password-form').reset();

            } catch (error) {
                statusEl.textContent = 'Gagal mengubah password. Coba lagi.';
                statusEl.classList.add('text-red-600');
                console.error('Password change error:', error);
            } finally {
                hideLoading();
                 setTimeout(() => { statusEl.textContent = ''; }, 4000);
            }
        }
        
        function handleDataChange(event) {
            if (!isDataDirty) {
                isDataDirty = true;
                updateSaveStatus('Perubahan belum disimpan', null);
            }
        }
        
        function updateSaveStatus(status, isSuccess = null) {
            saveStatusIndicators.forEach(indicator => {
                indicator.classList.remove('text-green-600', 'text-red-600', 'text-yellow-600');
                let icon = '';
                if (isSuccess === true) {
                    indicator.classList.add('text-green-600');
                    icon = '&#10003; '; // Checkmark
                } else if (isSuccess === false) {
                    indicator.classList.add('text-red-600');
                    icon = '&#10005; '; // Cross
                } else {
                    indicator.classList.add('text-yellow-600');
                }
                indicator.innerHTML = icon + status;

                if (isSuccess !== null) {
                    setTimeout(() => {
                        if (status !== 'Perubahan belum disimpan') {
                           indicator.innerHTML = '';
                        }
                    }, 3000);
                }
            });
        }


        function showLoading(text = "Memproses...") {
            loadingText.textContent = text;
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }
        
        async function loadSatuanKerjaList() {
            try {
                const response = await fetch(`${GAS_URL}?action=getSatuanKerjaList`);
                const data = await response.json();
                if (data.error) throw new Error(data.error);

                const selectNew = document.getElementById('select-new-satker');
                const selectMain = document.getElementById('satuan_kerja');
                
                selectNew.innerHTML = '<option value="">-- Pilih Satuan Kerja --</option>';
                selectMain.innerHTML = '<option value="">-- Pilih Satuan Kerja --</option>';

                data.satuanKerjaList.forEach(satker => {
                    const option = `<option value="${satker}">${satker}</option>`;
                    selectNew.innerHTML += option;
                    selectMain.innerHTML += option;
                });

            } catch (error) {
                 console.error("Gagal memuat daftar satuan kerja:", error);
                 alert("Gagal memuat daftar Satuan Kerja. Pastikan kolom 'Satuan Kerja' ada di sheet KKA_Master.");
            }
        }

        async function loadUsersList() {
            try {
                const response = await fetch(`${GAS_URL}?action=getUsersList`);
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                allUsers = data.users || [];
            } catch (error) {
                console.error("Gagal memuat daftar pengguna:", error);
                alert("Gagal memuat daftar pengguna. Periksa koneksi dan sheet 'Pengguna'.");
            }
        }


async function loadAuditList() {
            showLoading("Mengambil daftar audit Anda...");
            try {
                // Modifikasi: Tambahkan parameter NIP ke URL
                const response = await fetch(`${GAS_URL}?nip=${encodeURIComponent(loggedInUser.nip)}`);
                const data = await response.json();
                if (data.error) throw new Error(data.error);

                const select = document.getElementById('select-existing-audit');
                select.innerHTML = '<option value="">-- Pilih Audit --</option>';
                
                if (data.audits && data.audits.length > 0) {
                    data.audits.forEach(audit => {
                        const option = document.createElement('option');
                        option.value = audit.nomor_st;
                        option.textContent = `${audit.nomor_st} - ${audit.nama_audit || 'Tanpa Nama'}`;
                        select.appendChild(option);
                    });
                } else {
                    // Beri tahu pengguna jika tidak ada audit yang terkait dengannya
                    const option = document.createElement('option');
                    option.disabled = true;
                    option.textContent = 'Tidak ada audit yang terkait dengan Anda';
                    select.appendChild(option);
                }

            } catch (error) {
                console.error("Gagal memuat daftar audit:", error);
                alert("Gagal terhubung ke database. Periksa koneksi dan URL Apps Script Anda.");
            } finally {
                hideLoading();
            }
        }

async function handleLoadAudit() {
    const nomorST = document.getElementById('select-existing-audit').value;
    if (!nomorST) {
        showWelcomeError("Silakan pilih audit yang akan dimuat.");
        return;
    }
    
    showLoading(`Memuat data audit ${nomorST}...`);
    try {
        const response = await fetch(`${GAS_URL}?nomor_st=${encodeURIComponent(nomorST)}`);
        const data = await response.json();
        if (data.error) throw new Error(data.error);

        // 1. Temukan peran pengguna terlebih dahulu
        const userInTeam = data.timAudit.find(member => String(member.nip).trim() === String(loggedInUser.nip).trim());
        if (!userInTeam) {
            alert("Akses ditolak. Anda tidak terdaftar dalam tim audit ini.");
            hideLoading();
            return;
        }
        currentUserRole = userInTeam.role;

        // 2. Muat semua data ke state global
        kkaData = data.masterKKA || []; 
        auditTeam = data.timAudit || [];
        taskAssignments = data.pembagianTugas || {};
        auditFindings = data.temuanAudit || {};
        
        const allStatus = data.statusAudit || {};
        indicatorStatus = allStatus.indicatorStatus || {};
        auditStatus = allStatus.auditStatus || {};
        reviewNotes = allStatus.reviewNotes || {};
        reviewState = allStatus.reviewState || {};
        reviewApprovalStatus = allStatus.reviewApprovalStatus || {};

        // 3. Isi form data umum
        populateDataUmum(data.dataUmum);
        
        // 4. Terapkan batasan berdasarkan peran
        applyRoleRestrictions(currentUserRole);

        // 5. Lakukan SEMUA proses rendering HANYA SETELAH semua data siap
        renderAll();
        
        // 6. Tampilkan aplikasi
        startApp();
        isDataDirty = false;
        updateSaveStatus('', null);

    } catch (error) {
        console.error("Gagal memuat data audit:", error);
        alert(`Gagal memuat data untuk ${nomorST}. Error: ${error.message}`);
    } finally {
        hideLoading();
    }
}
async function handleNewAudit() {
    const nomorST = document.getElementById('input-new-st').value.trim();
    const selectedSatker = document.getElementById('select-new-satker').value;

    if (!nomorST) {
        showWelcomeError("Nomor Surat Tugas tidak boleh kosong.");
        return;
    }
     if (!selectedSatker) {
        showWelcomeError("Silakan pilih Satuan Kerja terlebih dahulu.");
        return;
    }

    const existingOptions = document.querySelectorAll('#select-existing-audit option');
    const isExist = Array.from(existingOptions).some(opt => opt.value === nomorST);
    if(isExist) {
        showWelcomeError("Nomor Surat Tugas sudah ada. Silakan muat dari daftar.");
        return;
    }

    showLoading("Memulai audit baru...");
    try {
        const response = await fetch(`${GAS_URL}?action=getAllMasterKKA`);
        const data = await response.json();
        if (data.error) throw new Error(data.error);

        fullMasterKKA = data.masterKKA || [];

        kkaData = fullMasterKKA.filter(kka => kka['Satuan Kerja'] === selectedSatker);

        if (kkaData.length === 0) {
            alert(`Tidak ditemukan master KKA untuk Satuan Kerja "${selectedSatker}". Harap periksa kembali sheet KKA_Master Anda.`);
            hideLoading();
            return;
        }

        resetState();
        document.getElementById('no_st').value = nomorST;
        document.getElementById('satuan_kerja').value = selectedSatker;

        kkaData.forEach(indicator => {
            indicatorStatus[indicator['Sub KKA']] = 'Y';
            reviewApprovalStatus[indicator['Sub KKA']] = 'belum_direviu';
        });

        // Otomatis tambahkan pembuat audit ke tim sebagai Ketua Tim
        currentUserRole = 'Ketua Tim'; 
        auditTeam.push({
            name: loggedInUser.nama,
            nip: loggedInUser.nip,
            role: currentUserRole
        });

        applyRoleRestrictions(currentUserRole); 
        renderAll();
        startApp();
        isDataDirty = true;
        updateSaveStatus('Perubahan belum disimpan', null);
    } catch (error) {
         console.error("Gagal memulai audit baru:", error);
         alert(`Gagal memulai audit baru. Error: ${error.message}`);
    } finally {
        hideLoading();
    }
}

function applyRoleRestrictions(role) {
    const managerRoles = ['Ketua Tim', 'Pengendali Teknis', 'Pengendali Mutu', 'Penanggung Jawab', 'Admin'];

    // Selalu tampilkan semua menu terlebih dahulu, lalu sembunyikan yang tidak perlu
    menuItems.forEach(item => item.parentElement.style.display = 'block');
    document.getElementById('new-audit-section').style.display = 'block';

    // Atur tampilan filter default
    document.getElementById('filter-section-menu4').style.display = 'block';
    document.getElementById('nip-input-container-4').style.display = 'block';
    document.getElementById('anggota-selector-container').style.display = 'none';

    document.getElementById('filter-section-menu5').style.display = 'block';
    document.getElementById('nip-input-container-5').style.display = 'flex';
    document.getElementById('anggota-selector-container-notisi').style.display = 'none';

    if (role === 'Anggota') {
        // Sembunyikan menu yang tidak relevan untuk Anggota
        document.querySelector('[data-menu="menu-dashboard"]').parentElement.style.display = 'none'; // <-- TAMBAHKAN BARIS INI
        document.querySelector('[data-menu="menu1"]').parentElement.style.display = 'none';
        document.querySelector('[data-menu="menu2"]').parentElement.style.display = 'none';
        document.querySelector('[data-menu="menu3"]').parentElement.style.display = 'none';
        document.querySelector('[data-menu="menu6"]').parentElement.style.display = 'none';
        document.getElementById('new-audit-section').style.display = 'none';

        // Sembunyikan semua filter, karena Anggota hanya melihat tugasnya sendiri
        document.getElementById('filter-section-menu4').style.display = 'none';
        document.getElementById('filter-section-menu5').style.display = 'none';

        // Langsung arahkan ke menu Kertas Kerja
        showMenu('menu4', document.querySelector('[data-menu="menu4"]'));

    } else if (managerRoles.includes(role)) {
        // Atur tampilan filter untuk Manajer
        document.getElementById('nip-input-container-4').style.display = 'none';
        document.getElementById('auditor-info-display-4').style.display = 'none';
        document.getElementById('anggota-selector-container').style.display = 'block';

        document.getElementById('nip-input-container-5').style.display = 'none';
        document.getElementById('auditor-info-display-5').style.display = 'none';
        document.getElementById('anggota-selector-container-notisi').style.display = 'block';

        // Isi dropdown dengan daftar anggota
        anggotaSelector.innerHTML = createAuditorOptions('Anggota', true);
        anggotaSelectorNotisi.innerHTML = createAuditorOptions('Anggota', true);
        anggotaSelector.value = 'semua';
        anggotaSelectorNotisi.value = 'semua';

        // Arahkan Manajer ke menu Data Umum
        showMenu('menu1', document.querySelector('[data-menu="menu1"]'));
    }
    // PERHATIKAN: Semua baris yang memanggil renderWorksheetTable() dan renderNoticeTable() telah dihapus dari sini.
}

async function saveCurrentState(isAutoSave = false) {
    if (isSaving) return;
    isSaving = true;

    updateSaveStatus('Menyimpan...');

    const nomorST = document.getElementById('no_st').value;
    if (!nomorST) {
        alert("Nomor Surat Tugas tidak ditemukan. Gagal menyimpan.");
        hideLoading();
        isSaving = false;
        return;
    }

    try {
        const payload = {
            dataUmum: collectDataUmum(),
            timAudit: auditTeam,
            pembagianTugas: taskAssignments,
            temuanAudit: auditFindings,
            statusAudit: {
                indicatorStatus,
                auditStatus,
                reviewNotes,
                reviewState,
                reviewApprovalStatus
            }
        };

        const response = await fetch(GAS_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload)
        });

        isDataDirty = false;
        updateSaveStatus('Tersimpan', true);

        await loadAuditList();

    } catch (error) {
        console.error("Gagal menyimpan perubahan:", error);
        updateSaveStatus('Gagal menyimpan', false);
    } finally {
        isSaving = false;
        isNavigating = false;
    }
}

function startApp() {
    welcomeModal.style.display = 'none';
    mainAppContainer.style.display = 'flex';
}

function resetState() {
    auditTeam = [];
    editingIndex = null;
    taskAssignments = {};
    auditFindings = {};
    auditStatus = {};
    reviewNotes = {};
    reviewState = {};
    reviewApprovalStatus = {};
    indicatorStatus = {};
    document.getElementById('form-data-umum').reset();
    isDataDirty = false;
}
function renderAll() {
    // Fungsi ini sekarang hanya fokus pada rendering, bukan kalkulasi yang memicu render lain
    renderTeamTable();
    recalculateAndRenderBobot(); // Ini akan me-render tabel tugas
    
    // Render tabel Kertas Kerja dan Notisi berdasarkan peran saat ini
    if (currentUserRole === 'Anggota') {
        renderWorksheetTable(loggedInUser.nama, false);
        renderNoticeTable(loggedInUser.nama, currentUserRole);
    } else {
        const managerRoles = ['Ketua Tim', 'Pengendali Teknis', 'Pengendali Mutu', 'Penanggung Jawab', 'Admin'];
        if (managerRoles.includes(currentUserRole)) {
            renderWorksheetTable('semua', true);
            renderNoticeTable('semua', currentUserRole);
        }
    }
    
    // Update semua rekapitulasi
    updateRekapitulasi();
    updateProgresStatistik();
    update3EScore();
    updateRekapitulasiKeuangan();
}
           
        function showWelcomeError(message) {
            const errorEl = document.getElementById('welcome-error');
            errorEl.textContent = message;
            setTimeout(() => { errorEl.textContent = ''; }, 3000);
        }

        function collectDataUmum() {
            const ids = ["nama_audit", "unit_kerja", "satuan_kerja", "nama_satuan_kerja", "alamat", "nama_pimpinan", "nip_pimpinan", "pangkat_golongan", "jabatan_pimpinan", "waktu_audit_mulai", "waktu_audit_selesai", "periode_audit_mulai", "periode_audit_selesai", "no_st", "tgl_st", "bobot_perencanaan", "bobot_pelaksanaan", "bobot_evaluasi", "bobot_pencapaian"];
            const data = {};
            ids.forEach(id => {
                data[id] = document.getElementById(id).value;
            });
            return data;
        }

        function populateDataUmum(data) {
            if(!data) return;
            const dateInputIds = ['waktu_audit_mulai', 'waktu_audit_selesai', 'periode_audit_mulai', 'periode_audit_selesai', 'tgl_st'];

            for (const key in data) {
                const element = document.getElementById(key);
                if (element) {
                    if (dateInputIds.includes(key) && data[key]) {
                        try {
                            const date = new Date(data[key]);
                            if (!isNaN(date.getTime())) {
                                const year = date.getFullYear();
                                const month = String(date.getMonth() + 1).padStart(2, '0');
                                const day = String(date.getDate()).padStart(2, '0');
                                element.value = `${year}-${month}-${day}`;
                            } else {
                               element.value = '';
                            }
                        } catch (e) {
                            console.error(`Tidak dapat mem-parsing tanggal untuk ${key}:`, data[key]);
                            element.value = '';
                        }
                    } else {
                        element.value = data[key];
                    }
                }
            }
        }
        
        function performNavigation(menuId, element) {
            menuContents.forEach(menu => menu.classList.add('hidden'));
            document.getElementById(menuId).classList.remove('hidden');
            menuItems.forEach(item => item.classList.remove('active'));
            element.classList.add('active');
            
            isNavigating = false;
            navigationTarget = { menuId: null, element: null };
        }

        function showMenu(menuId, element) {
            // PERBAIKAN: Hentikan polling setiap kali berpindah menu untuk efisiensi
            stopPollingForUpdates();

            if (isDataDirty && !isNavigating) {
                navigationTarget = { menuId, element };
                document.getElementById('unsaved-changes-modal').style.display = 'flex';
                return;
            }
            
            if (menuId === 'menu6') {
                renderLHA();
            }

            // PERBAIKAN: Mulai polling secara otomatis jika pengguna masuk ke menu Notisi Audit
            if (menuId === 'menu5') {
                startPollingForUpdates();
            }

            if (menuId === 'menu-dashboard') {
                // Hanya fetch data jika belum ada, untuk efisiensi
                if (allAuditsData.length === 0) {
                    fetchAllAuditsDataAndRenderDashboard();
                } else {
                    renderDashboard(); // Render ulang dengan data yang ada
                }
            }

            performNavigation(menuId, element);
        }

        function renderTeamTable() {
            tabelTimAuditBody.innerHTML = '';
            auditTeam.forEach((member, index) => {
                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${index + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${member.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${member.nip}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${member.role}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="editTeamMember(${index})" class="text-blue-600 hover:text-blue-900 mr-3">Edit</button>
                            <button onclick="deleteTeamMember(${index})" class="text-red-600 hover:text-red-900">Hapus</button>
                        </td>
                    </tr>
                `;
                tabelTimAuditBody.innerHTML += row;
            });
            recalculateAndRenderBobot();
        }
        
        function handleTeamFormSubmit(event) {
            event.preventDefault();
            const name = document.getElementById('nama_auditor').value;
            const nip = document.getElementById('nip_auditor').value;
            const role = document.getElementById('jabatan_tim').value;

            if (!name || !nip) {
                alert("Nama dan NIP tidak boleh kosong. Harap pilih nama dari daftar.");
                return;
            }

            if (editingIndex !== null) {
                auditTeam[editingIndex] = { name, nip, role };
            } else {
                if (auditTeam.some(member => member.nip === nip)) {
                    alert('Auditor dengan NIP ini sudah ada di dalam tim.');
                    return;
                }
                auditTeam.push({ name, nip, role });
            }

            editingIndex = null;
            formTimAudit.reset(); 
            document.getElementById('submit-team-btn').textContent = 'Tambah Tim';
            
            renderTeamTable();
        }

        function editTeamMember(index) {
            const member = auditTeam[index];
            if (!member) return;

            document.getElementById('nama_auditor_search').value = member.name;
            document.getElementById('nama_auditor').value = member.name;
            document.getElementById('nip_auditor').value = member.nip;
            document.getElementById('nip_auditor').readOnly = true; 
            document.getElementById('jabatan_tim').value = member.role;

            editingIndex = index;
            document.getElementById('submit-team-btn').textContent = 'Simpan Perubahan';
            document.getElementById('nama_auditor_search').focus();
        }

        function deleteTeamMember(index) {
            if (confirm(`Apakah Anda yakin ingin menghapus ${auditTeam[index].name} dari tim?`)) {
                auditTeam.splice(index, 1);
                renderTeamTable();
            }
        }

        function createAuditorOptions(filterRole = null, withSelectAll = false) {
            let options = '<option value="">-- Pilih Auditor --</option>';
            if (withSelectAll) {
                options += '<option value="semua">-- Pilih Semua --</option>';
            }
            const teamToIterate = filterRole ? auditTeam.filter(m => m.role === filterRole) : auditTeam;
            
            teamToIterate.forEach(member => {
                options += `<option value="${member.name}">${member.name}</option>`;
            });
            return options;
        }
        
        function recalculateAndRenderBobot() {
            const stageWeights = {
                'Tahap Perencanaan': parseFloat(document.getElementById('bobot_perencanaan').value) || 0,
                'Tahap Pelaksanaan': parseFloat(document.getElementById('bobot_pelaksanaan').value) || 0,
                'Tahap Evaluasi & Pelaporan': parseFloat(document.getElementById('bobot_evaluasi').value) || 0,
                'Tahap Pencapaian Hasil/Outcome': parseFloat(document.getElementById('bobot_pencapaian').value) || 0, // <-- Nama tahap disamakan
            };

            const indicatorsByStage = {
                'Tahap Perencanaan': kkaData.filter(i => i.Tahap === 'Tahap Perencanaan'),
                'Tahap Pelaksanaan': kkaData.filter(i => i.Tahap === 'Tahap Pelaksanaan'),
                'Tahap Evaluasi & Pelaporan': kkaData.filter(i => i.Tahap === 'Tahap Evaluasi & Pelaporan'),
                'Tahap Pencapaian Hasil/Outcome': kkaData.filter(i => i.Tahap === 'Tahap Pencapaian Hasil/Outcome'), // <-- Nama tahap disamakan
            };

            for (const stageName in indicatorsByStage) {
                const totalWeightForStage = stageWeights[stageName];
                const indicatorsInStage = indicatorsByStage[stageName];
                
                const assessedIndicatorsCount = indicatorsInStage.filter(i => indicatorStatus[i['Sub KKA']] === 'Y').length;

                const weightPerIndicator = assessedIndicatorsCount > 0 ? totalWeightForStage / assessedIndicatorsCount : 0;

                indicatorsInStage.forEach(indicator => {
                    const originalIndicator = kkaData.find(i => i['Sub KKA'] === indicator['Sub KKA']);
                    if (originalIndicator) {
                        // --- PERBAIKAN UTAMA: Menggunakan toFixed untuk presisi 3 angka desimal ---
                        originalIndicator['Bobot Aspek Penilaian'] = indicatorStatus[indicator['Sub KKA']] === 'Y' ? weightPerIndicator.toFixed(3) : '0.000';
                    }
                });
            }
            
            renderTaskAssignmentTable();
            updateRekapitulasi();
            updateProgresStatistik();
            update3EScore();
            updateRekapitulasiKeuangan();
            
            // Refresh filter jika ada
            const activeNipWorksheet = document.getElementById('filter-auditor-nip').value;
            if (activeNipWorksheet) handleNipFilter({ target: { value: activeNipWorksheet } }, 'worksheet');

            const activeNipNotice = document.getElementById('filter-auditor-notisi-nip').value;
            if (activeNipNotice) handleNipFilter({ target: { value: activeNipNotice } }, 'notice');
        }
        
function renderTaskAssignmentTable() {
            tabelPembagianTugasBody.innerHTML = '';
            const auditorOptions = createAuditorOptions();
            
            const groupedData = kkaData.reduce((acc, current) => {
                acc[current['Kode KKA']] = acc[current['Kode KKA']] || [];
                acc[current['Kode KKA']].push(current);
                return acc;
            }, {});

            for (const kodeKKA in groupedData) {
                const items = groupedData[kodeKKA];
                const rowSpan = items.length;
                
                items.forEach((item, index) => {
                    let rowHtml = '<tr>';
                    if (index === 0) {
                        rowHtml += `<td class="px-4 py-4 text-sm font-medium text-gray-900 grouped-row-cell" rowspan="${rowSpan}">${item['Kode KKA']}</td>`;
                    }
                    rowHtml += `<td class="px-4 py-4 text-sm font-medium text-gray-700">${item['Sub KKA']}</td>`;
                    if (index === 0) {
                        rowHtml += `<td class="px-4 py-4 text-sm text-gray-500 grouped-row-cell" rowspan="${rowSpan}">${item['Fungsi/Tugas (PMA Pasal)']}</td>`;
                    }
                    
                    // --- PERBAIKAN UTAMA: Menggunakan replace untuk format desimal yang konsisten ---
                    const formattedBobot = String(parseFloat(item['Bobot Aspek Penilaian']).toFixed(3)).replace('.', ',');

                    rowHtml += `
                        <td class="px-4 py-4 text-sm text-gray-500">${item['Indikator Kinerja Aspek Penilaian Audit']}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${formattedBobot}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                            <select class="dinilai-select w-full border-gray-300 rounded-md" data-sub-kka="${item['Sub KKA']}">
                                <option value="Y" ${indicatorStatus[item['Sub KKA']] === 'Y' ? 'selected' : ''}>Y</option>
                                <option value="T" ${indicatorStatus[item['Sub KKA']] === 'T' ? 'selected' : ''}>T</option>
                            </select>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                            <select class="auditor-assign-select w-full border-gray-300 rounded-md" data-sub-kka="${item['Sub KKA']}" ${indicatorStatus[item['Sub KKA']] === 'T' ? 'disabled' : ''}>
                                ${auditorOptions}
                            </select>
                        </td>
                    `;
                    
                    rowHtml += '</tr>';
                    tabelPembagianTugasBody.innerHTML += rowHtml;
                });
            }

            document.querySelectorAll('.auditor-assign-select').forEach(select => {
                const subKkaCode = select.dataset.subKka;
                if (taskAssignments[subKkaCode]) {
                    select.value = taskAssignments[subKkaCode];
                }
            });
        }
        
function handleAssignmentChange(event) {
    const target = event.target;
    const subKkaCode = target.dataset.subKka;

    if (!subKkaCode) return; // Keluar jika tidak ada atribut data-sub-kka

    if (target.classList.contains('auditor-assign-select')) {
        const auditorName = target.value;
        if (auditorName) {
            taskAssignments[subKkaCode] = auditorName;
        } else {
            delete taskAssignments[subKkaCode];
        }
    } else if (target.classList.contains('dinilai-select')) {
        const isAssessed = target.value;
        indicatorStatus[subKkaCode] = isAssessed;

        // Jika status diubah menjadi 'T' (Tidak dinilai), hapus juga temuan audit yang mungkin sudah ada
        if (isAssessed === 'T' && auditFindings[subKkaCode]) {
            delete auditFindings[subKkaCode];
            delete auditStatus[subKkaCode]; // Hapus juga status pengerjaannya
        }

        // Memanggil rekalkulasi bobot yang akan me-render ulang tabel tugas dan data lainnya
        recalculateAndRenderBobot();
    }

    // Tandai bahwa ada perubahan yang belum disimpan
    handleDataChange();

    // Refresh tabel Kertas Kerja dan Notisi setelah ada perubahan
    const activeNipWorksheet = document.getElementById('filter-auditor-nip').value;
    const activeNipNotice = document.getElementById('filter-auditor-notisi-nip').value;

    if (activeNipWorksheet) {
        handleNipFilter({ target: { value: activeNipWorksheet } }, 'worksheet');
    } else if (currentUserRole === 'Anggota') {
        // Jika tidak ada NIP di filter (misal. untuk Anggota), render ulang tabelnya
        renderWorksheetTable(loggedInUser.nama, false);
    }

    if (activeNipNotice) {
        handleNipFilter({ target: { value: activeNipNotice } }, 'notice');
    } else if (currentUserRole === 'Anggota') {
        renderNoticeTable(loggedInUser.nama, currentUserRole);
    }
}
            
        function getReviewStatusBadge(status) {
            const statusMap = {
                'belum_direviu': { text: 'Belum Direviu', color: 'bg-gray-200 text-gray-800' },
                'direviu_ketua': { text: 'Direviu Ketua Tim', color: 'bg-blue-200 text-blue-800' },
                'perbaikan_ketua': { text: 'Perbaikan Reviu Ketua Tim', color: 'bg-yellow-200 text-yellow-800' },
                'disetujui_ketua': { text: 'Disetujui Ketua Tim', color: 'bg-indigo-200 text-indigo-800' },
                'direviu_teknis': { text: 'Direviu Pengendali Teknis', color: 'bg-purple-200 text-purple-800' },
                'perbaikan_teknis': { text: 'Perbaikan Reviu Pengendali Teknis', color: 'bg-orange-200 text-orange-800' },
                'disetujui_teknis': { text: 'Disetujui Pengendali Teknis', color: 'bg-green-200 text-green-800' },
            };
            const statusInfo = statusMap[status] || statusMap['belum_direviu'];
            return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusInfo.color}">${statusInfo.text}</span>`;
        }
        
    function renderWorksheetTable(selectedAuditorName, isViewOnly = false) {
        tabelKertasKerjaBody.innerHTML = ''; // Hapus isi tabel sebelumnya

        let tasksFound = false;
        let totalBobot = 0;
        let totalNilai = 0;
        let totalHasil = 0;
        let taskRowsHtml = ''; // Variabel untuk menyimpan baris-baris tugas

        const anggotaNames = auditTeam.filter(m => m.role === 'Anggota').map(m => m.name);

        kkaData.forEach(task => {
            let isAssigned = false;
            if (selectedAuditorName === 'semua') {
                isAssigned = anggotaNames.includes(taskAssignments[task['Sub KKA']]);
            } else {
                const assignedAuditor = taskAssignments[task['Sub KKA']];
                isAssigned = assignedAuditor && selectedAuditorName && assignedAuditor.trim() === selectedAuditorName.trim();
            }

            if (isAssigned) {
                tasksFound = true;
                const finding = auditFindings[task['Sub KKA']] || {};
                const status = reviewApprovalStatus[task['Sub KKA']] || 'belum_direviu';

                // Akumulasi total
                const bobot = parseFloat(task['Bobot Aspek Penilaian']) || 0;
                const nilai = parseFloat(String(finding.nilai_skor || '0').replace(',', '.')) || 0;
                const hasil = parseFloat(String(finding.hasil_skor || '0').replace(',', '.')) || 0;

                totalBobot += bobot;
                totalNilai += nilai;
                totalHasil += hasil;

                // Logika tombol tetap sama
                let buttonHtml;
                if (isViewOnly) {
                    buttonHtml = `<button onclick="openAuditModal('${task['Sub KKA']}', true, '${currentUserRole}', 'kertas_kerja')" class="text-white bg-gray-500 hover:bg-gray-600 px-3 py-1 rounded-md text-xs transition-colors">Lihat Detail</button>`;
                } else {
                    let buttonColor = 'bg-blue-600 hover:bg-blue-700';
                    if (auditStatus[task['Sub KKA']] === 'in-progress') {
                        buttonColor = 'bg-yellow-500 hover:bg-yellow-600';
                    } else if (auditStatus[task['Sub KKA']] === 'completed') {
                        buttonColor = 'bg-green-600 hover:bg-green-700';
                    }
                    buttonHtml = `<button onclick="openAuditModal('${task['Sub KKA']}', false, '${currentUserRole}', 'kertas_kerja')" class="text-white ${buttonColor} px-3 py-1 rounded-md text-xs transition-colors">Audit</button>`;
                }

                const formattedBobot = String(parseFloat(task['Bobot Aspek Penilaian']).toFixed(3)).replace('.', ',');

                // Tambahkan baris tugas ke dalam string HTML
                taskRowsHtml += `
                    <tr>
                        <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${task['Kode KKA']} (${task['Sub KKA']})</td>
                        <td class="px-4 py-4 text-sm text-gray-500">${task['Indikator Kinerja Aspek Penilaian Audit']}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${formattedBobot}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${finding.nilai_skor || ''}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${finding.hasil_skor || ''}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${getReviewStatusBadge(status)}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">${buttonHtml}</td>
                    </tr>
                `;
            }
        });

        let totalRowHtml = '';
        if (tasksFound) {
            // Buat baris total jika ada tugas yang ditemukan
            totalRowHtml = `
                <tr class="bg-gray-100 font-bold border-y-2 border-gray-300">
                    <td class="px-4 py-3 text-left text-sm" colspan="2">TOTAL CAPAIAN KINERJA</td>
                    <td class="px-4 py-3 text-left text-sm">${totalBobot.toLocaleString('id-ID', { minimumFractionDigits: 3, maximumFractionDigits: 3 })}</td>
                    <td class="px-4 py-3 text-left text-sm">${totalNilai.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="px-4 py-3 text-left text-sm">${totalHasil.toLocaleString('id-ID', { minimumFractionDigits: 3, maximumFractionDigits: 3 })}</td>
                    <td class="px-4 py-3" colspan="2"></td>
                </tr>
            `;
        }

        // Gabungkan baris total dengan baris tugas, lalu masukkan ke dalam tabel
        tabelKertasKerjaBody.innerHTML = totalRowHtml + taskRowsHtml;

        noTaskMessage.classList.toggle('hidden', !tasksFound);
    }

function renderNoticeTable(selectedAuditorName, viewerRole) {
    tabelNotisiAuditBody.innerHTML = '';
    let findingsFound = false;
    const anggotaNames = auditTeam.filter(m => m.role === 'Anggota').map(m => m.name);

    kkaData.forEach(task => {
        let isAssigned = false;
        if (selectedAuditorName === 'semua') {
            isAssigned = anggotaNames.includes(taskAssignments[task['Sub KKA']]);
        } else {
            // --- PERBAIKAN: Mengabaikan spasi kosong saat membandingkan nama ---
            const assignedAuditor = taskAssignments[task['Sub KKA']];
            isAssigned = assignedAuditor && selectedAuditorName && assignedAuditor.trim() === selectedAuditorName.trim();
            // --- AKHIR PERBAIKAN ---
        }

        const finding = auditFindings[task['Sub KKA']];
        const score = finding ? parseFloat(String(finding.nilai_skor).replace(',', '.')) : null;

        if (isAssigned && finding && score !== null && score < 1) {
            findingsFound = true;
            const status = reviewApprovalStatus[task['Sub KKA']] || 'belum_direviu';

            let actionButtonHtml = `<button onclick="openAuditModal('${task['Sub KKA']}', true, '${viewerRole}', 'notisi')" class="text-white bg-gray-500 hover:bg-gray-600 px-3 py-1 rounded-md text-xs transition-colors">Lihat Detail</button>`;
            if (viewerRole === 'Ketua Tim') {
                actionButtonHtml = `<button onclick="openAuditModal('${task['Sub KKA']}', true, 'Ketua Tim', 'notisi')" class="text-white bg-indigo-600 hover:bg-indigo-700 px-3 py-1 rounded-md text-xs transition-colors">Reviu Ketua Tim</button>`;
            } else if (viewerRole === 'Pengendali Teknis') {
                 actionButtonHtml = `<button onclick="openAuditModal('${task['Sub KKA']}', true, 'Pengendali Teknis', 'notisi')" class="text-white bg-purple-600 hover:bg-purple-700 px-3 py-1 rounded-md text-xs transition-colors">Reviu Pengendali Teknis</button>`;
            }

            const row = `
                <tr>
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${task['Kode KKA']} (${task['Sub KKA']})</td>
                    <td class="px-4 py-4 text-sm text-gray-500">${task['Indikator Kinerja Aspek Penilaian Audit']}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${parseFloat(task['Bobot Aspek Penilaian']).toLocaleString('id-ID', { minimumFractionDigits: 3, maximumFractionDigits: 3 })}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${finding.nilai_skor || ''}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${finding.hasil_skor || ''}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${getReviewStatusBadge(status)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">${actionButtonHtml}</td>
                </tr>
            `;
            tabelNotisiAuditBody.innerHTML += row;
        }
    });

    noFindingMessage.classList.toggle('hidden', !findingsFound);
}

        function handleNipFilter(event, viewType) {
            const nip = event.target.value.trim();
            let displayElement, tableBody, noDataMessage, selectorContainer, selector;

            if (viewType === 'worksheet') {
                displayElement = auditorInfoDisplay4;
                tableBody = tabelKertasKerjaBody;
                noDataMessage = noTaskMessage;
                selectorContainer = anggotaSelectorContainer;
                selector = anggotaSelector;
            } else { // notice
                displayElement = auditorInfoDisplay5;
                tableBody = tabelNotisiAuditBody;
                noDataMessage = noFindingMessage;
                selectorContainer = anggotaSelectorContainerNotisi;
                selector = anggotaSelectorNotisi;
                btnOpenPrintSelection.classList.add('hidden');
            }
            
            selectorContainer.classList.add('hidden');
            displayElement.textContent = '';
            tableBody.innerHTML = '';
            noDataMessage.classList.add('hidden');

            if (!nip) {
                return;
            }

            const auditor = auditTeam.find(member => String(member.nip).trim() === String(nip).trim());
            const managerRoles = ['Ketua Tim', 'Pengendali Teknis', 'Pengendali Mutu', 'Penanggung Jawab'];
            const printBtnRoles = ['Anggota', 'Ketua Tim'];

            if (auditor) {
                displayElement.textContent = `${auditor.nip} - ${auditor.name} (${auditor.role})`;
                if (managerRoles.includes(auditor.role)) {
                    selectorContainer.classList.remove('hidden');
                    selector.innerHTML = createAuditorOptions('Anggota', true);
                    selector.value = 'semua';
                    renderTableForView(viewType, 'semua', auditor.role);
                } else { 
                    renderTableForView(viewType, auditor.name, auditor.role);
                }
                if(viewType === 'notice' && printBtnRoles.includes(auditor.role)) {
                    btnOpenPrintSelection.classList.remove('hidden');
                }
            } else {
                noDataMessage.classList.remove('hidden');
                displayElement.textContent = 'NIP tidak ditemukan.';
            }
        }

        function renderTableForView(viewType, auditorName, viewerRole) {
            const isViewOnly = viewerRole !== 'Anggota';
            if (viewType === 'worksheet') {
                renderWorksheetTable(auditorName, isViewOnly);
            } else {
                renderNoticeTable(auditorName, viewerRole);
            }
        }

        function formatNumber(value) {
            if (isNaN(value) || value === null || value === undefined) return '';
            return new Intl.NumberFormat('id-ID').format(value);
        }

        function parseNumber(value) {
            if (typeof value !== 'string') return 0;
            return parseFloat(value.replace(/[^0-9,-]/g, '').replace(',', '.')) || 0;
        }

        function calculateSaldo() {
            const temuanKeuangan = document.getElementById('temuan_keuangan');
            const tindakLanjut = document.getElementById('tindak_lanjut');
            const saldo = document.getElementById('saldo');
            if (temuanKeuangan && tindakLanjut && saldo) {
                const temuanValue = parseNumber(temuanKeuangan.value);
                const tindakValue = parseNumber(tindakLanjut.value);
                saldo.value = formatNumber(temuanValue - tindakValue);
            }
        }

        function calculateHasil() {
            const bobotElement = document.getElementById('bobot_penilaian');
            const nilaiElement = document.getElementById('nilai_skor');
            const hasilElement = document.getElementById('hasil_skor');

            if (!bobotElement || !nilaiElement || !hasilElement) return;

            let rawValue = nilaiElement.value;
            let nilai = parseFloat(rawValue.replace(',', '.'));

            if (isNaN(nilai)) {
                nilai = 0;
            }

            if (nilai < 0) {
                nilai = 0;
                nilaiElement.value = '0';
            } else if (nilai > 1) {
                nilai = 1;
                nilaiElement.value = '1';
            }

            const bobot = parseFloat(bobotElement.value.replace(',', '.')) || 0;
            const hasil = bobot * nilai;

            hasilElement.value = hasil.toFixed(3).replace('.', ',');
        }

        function openAuditModal(subKkaCode, isViewOnly = false, viewerRole = 'Anggota', modalContext = 'kertas_kerja') {
            const task = kkaData.find(t => t['Sub KKA'] === subKkaCode);
            if (!task) return;

            const modalTitle = document.getElementById('modal-title');
            modalTitle.textContent = modalContext === 'notisi' ? 'Detail Notisi Audit' : 'Detail Kertas Kerja Audit';

            const findings = auditFindings[subKkaCode] || {};
            const isAnggota = viewerRole === 'Anggota';
            const currentReviewStatus = reviewApprovalStatus[subKkaCode] || 'belum_direviu';
            const isUntouched = currentReviewStatus === 'belum_direviu';
            const isPerbaikanKetua = currentReviewStatus === 'perbaikan_ketua';
            const isPerbaikanTeknis = currentReviewStatus === 'perbaikan_teknis';
            const isAnggotaEditable = isAnggota && (isUntouched || isPerbaikanKetua || isPerbaikanTeknis);
            const isManagerReadOnly = (viewerRole === 'Ketua Tim' || viewerRole === 'Pengendali Teknis') && modalContext === 'kertas_kerja';
            const isEditorReadOnly = !isAnggotaEditable || isManagerReadOnly;

            let modalHtml = '<div id="audit-form" class="space-y-4">';
            
            // ... (Bagian HTML untuk Detail Tugas dan Input Hasil Audit tetap sama, tidak perlu diubah)
            
            modalHtml += '<h4 class="text-lg font-semibold border-b pb-2 mb-4">Detail Tugas</h4>';
            const taskDetails = { ...task };
            delete taskDetails["Bobot Aspek Penilaian"];
            for (const key in taskDetails) {
                modalHtml += `<div class="grid grid-cols-3 gap-4 border-b pb-2"><dt class="text-sm font-medium text-gray-500 col-span-1">${key}</dt><dd class="text-sm text-gray-900 col-span-2 whitespace-pre-wrap">${taskDetails[key]}</dd></div>`;
            }

            modalHtml += `<div class="flex justify-between items-center mt-6 mb-4 border-b pb-2"><h4 class="text-lg font-semibold">Input Hasil Audit</h4><button id="ai-analysis-btn" onclick="handleAiAnalysis()" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>Analisis InVia<div id="ai-spinner" class="spinner ml-2 hidden"></div></button></div>`;

            const formFields = [
                { id: 'kondisi_positif', label: 'Kondisi Positif', type: 'textarea' }, { id: 'kondisi_negatif', label: 'Kondisi Negatif', type: 'textarea' },
                { id: 'sebab', label: 'Sebab', type: 'textarea' }, { id: 'kriteria', label: 'Kriteria', type: 'textarea' },
                { id: 'akibat', label: 'Akibat', type: 'textarea' }, { id: 'rekomendasi', label: 'Rekomendasi', type: 'textarea' },
                { id: 'anggaran_diaudit', label: 'Anggaran Diaudit', type: 'text' }, { id: 'temuan_keuangan', label: 'Temuan Keuangan Rp', type: 'text' },
                { id: 'tindak_lanjut', label: 'Tindak Lanjut', type: 'text' }, { id: 'saldo', label: 'Saldo', type: 'text' },
            ];

            formFields.forEach(field => {
                const value = findings[field.id] || '';
                const isFieldReadOnly = (field.id === 'saldo' || isEditorReadOnly);
                const bgReadOnly = isFieldReadOnly ? 'bg-gray-100' : 'bg-white';
                modalHtml += `<div class="grid grid-cols-3 gap-4 items-start"><label for="${field.id}" class="block text-sm font-medium text-gray-700 col-span-1 pt-2">${field.label}</label>`;
                if (field.type === 'textarea') {
                    const inputClasses = `audit-input col-span-2 mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 ${bgReadOnly}`;
                    modalHtml += `<textarea id="${field.id}" rows="3" class="${inputClasses}" ${isFieldReadOnly ? 'readonly' : ''}>${value}</textarea>`;
                } else {
                    const inputClasses = `audit-input col-span-2 mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 ${bgReadOnly}`;
                    modalHtml += `<input type="text" id="${field.id}" value="${value}" class="${inputClasses}" ${isFieldReadOnly ? 'readonly' : ''}>`;
                }
                modalHtml += `</div>`;
            });

            modalHtml += `<div class="border-t pt-4 mt-4"><h5 class="text-md font-semibold mb-2">Penilaian Skor Kinerja</h5><div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end"><div><label for="bobot_penilaian" class="block text-sm font-medium text-gray-700">Bobot Aspek Penilaian</label><input type="text" id="bobot_penilaian" value="${parseFloat(task['Bobot Aspek Penilaian']).toLocaleString('id-ID', { minimumFractionDigits: 3, maximumFractionDigits: 3 })}" class="audit-input mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm" readonly></div><div><label for="nilai_skor" class="block text-sm font-medium text-gray-700">Nilai (0-1)</label><input type="text" id="nilai_skor" value="${findings['nilai_skor'] || ''}" placeholder="Contoh: 0,5" class="audit-input mt-1 block w-full px-3 py-2 ${isEditorReadOnly ? 'bg-gray-100' : 'bg-white'} border border-gray-300 rounded-md shadow-sm" ${isEditorReadOnly ? 'readonly' : ''}></div><div><label for="hasil_skor" class="block text-sm font-medium text-gray-700">Hasil</label><input type="text" id="hasil_skor" value="${findings['hasil_skor'] || ''}" class="audit-input mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm" readonly></div></div></div>`;

            if (modalContext === 'notisi') {
                const reviewData = reviewNotes[subKkaCode] || { ketua: '', teknis: '' };
                const isKetua = viewerRole === 'Ketua Tim';
                const isTeknis = viewerRole === 'Pengendali Teknis';
                
                // --- PERBAIKAN LOGIKA: Tentukan status bisa edit secara berjenjang ---
                const isApprovedByTeknis = ['disetujui_teknis'].includes(currentReviewStatus);
                const isBeingReviewedByTeknis = ['direviu_teknis', 'perbaikan_teknis'].includes(currentReviewStatus);
                
                const isKetuaEditable = isKetua && !isApprovedByTeknis && !isBeingReviewedByTeknis;
                const isTeknisEditable = isTeknis && ['disetujui_ketua', 'direviu_teknis', 'perbaikan_teknis'].includes(currentReviewStatus);

                modalHtml += `<div class="border-t pt-4 mt-4 space-y-4">`;
                // Reviu Ketua Tim
                modalHtml += `<div><label for="reviu_ketua" class="block text-sm font-medium text-gray-700">Reviu Ketua Tim</label><textarea id="reviu_ketua" data-sub-kka="${subKkaCode}" data-review-type="ketua" rows="3" class="review-textarea mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm ${!isKetuaEditable || reviewState[subKkaCode]?.ketua === 'saved' ? 'bg-gray-100' : 'bg-white'}" ${!isKetuaEditable || reviewState[subKkaCode]?.ketua === 'saved' ? 'readonly' : ''}>${reviewData.ketua || ''}</textarea>`;
                if (isKetuaEditable) {
                    modalHtml += `<div class="mt-2 flex justify-end space-x-2">
                        <button class="review-edit-btn text-sm py-1 px-3 rounded-md bg-gray-500 text-white" data-review-type="ketua" ${reviewState[subKkaCode]?.ketua !== 'saved' ? 'style="display:none;"' : ''}>Edit</button>
                        <button class="review-save-btn text-sm py-1 px-3 rounded-md bg-blue-600 text-white" data-review-type="ketua" ${reviewState[subKkaCode]?.ketua === 'saved' ? 'style="display:none;"' : ''}>Simpan</button>
                        <button class="review-revise-btn text-sm py-1 px-3 rounded-md bg-yellow-500 text-white" data-review-type="ketua">Perbaiki</button>
                        <button class="review-approve-btn text-sm py-1 px-3 rounded-md bg-green-600 text-white" data-review-type="ketua">Setujui</button>
                    </div>`;
                }
                modalHtml += `</div>`;

                // Reviu Pengendali Teknis
                modalHtml += `<div><label for="reviu_teknis" class="block text-sm font-medium text-gray-700">Reviu Pengendali Teknis</label><textarea id="reviu_teknis" data-sub-kka="${subKkaCode}" data-review-type="teknis" rows="3" class="review-textarea mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm ${!isTeknisEditable || reviewState[subKkaCode]?.teknis === 'saved' ? 'bg-gray-100' : 'bg-white'}" ${!isTeknisEditable || reviewState[subKkaCode]?.teknis === 'saved' ? 'readonly' : ''}>${reviewData.teknis || ''}</textarea>`;
                if (isTeknisEditable) {
                     modalHtml += `<div class="mt-2 flex justify-end space-x-2">
                        <button class="review-edit-btn text-sm py-1 px-3 rounded-md bg-gray-500 text-white" data-review-type="teknis" ${reviewState[subKkaCode]?.teknis !== 'saved' ? 'style="display:none;"' : ''}>Edit</button>
                        <button class="review-save-btn text-sm py-1 px-3 rounded-md bg-blue-600 text-white" data-review-type="teknis" ${reviewState[subKkaCode]?.teknis === 'saved' ? 'style="display:none;"' : ''}>Simpan</button>
                        <button class="review-revise-btn text-sm py-1 px-3 rounded-md bg-yellow-500 text-white" data-review-type="teknis">Perbaiki</button>
                        <button class="review-approve-btn text-sm py-1 px-3 rounded-md bg-green-600 text-white" data-review-type="teknis">Setujui</button>
                    </div>`;
                }
                modalHtml += `</div></div>`;
            }
            modalHtml += '</div>';

            modalBody.innerHTML = modalHtml;
            modal.dataset.currentSubKka = subKkaCode;
            
            const temuanInput = document.getElementById('temuan_keuangan');
            const tindakLanjutInput = document.getElementById('tindak_lanjut');
            const nilaiSkorInput = document.getElementById('nilai_skor');

            if(temuanInput && tindakLanjutInput){
                temuanInput.addEventListener('input', calculateSaldo);
                tindakLanjutInput.addEventListener('input', calculateSaldo);
            }
            if(nilaiSkorInput){
                 nilaiSkorInput.addEventListener('input', calculateHasil);
            }

            calculateSaldo();
            calculateHasil();
            updateModalState(subKkaCode, isViewOnly, viewerRole, modalContext);
            
            modal.style.display = 'flex';
        }
        
async function handleAiAnalysis() {
            const aiButton = document.getElementById('ai-analysis-btn');
            const spinner = document.getElementById('ai-spinner');
            const errorElement = document.getElementById('modal-error');

            const kondisiNegatifEl = document.getElementById('kondisi_negatif');
            const sebabEl = document.getElementById('sebab');
            const kriteriaEl = document.getElementById('kriteria');
            const akibatEl = document.getElementById('akibat');
            const rekomendasiEl = document.getElementById('rekomendasi');

            const periodeSelesaiInput = document.getElementById('periode_audit_selesai').value;
            const namaSatuanKerja = document.getElementById('nama_satuan_kerja').value || '(Nama Satuan Kerja)'; // Ambil nama satker
            const unitKerja = document.getElementById('unit_kerja').value || 'Unit Kerja terkait';

            const kondisiNegatif = kondisiNegatifEl.value.trim();
            const sebab = sebabEl.value.trim();

            if (!kondisiNegatif) {
                errorElement.textContent = 'Harap isi "Kondisi Negatif" terlebih dahulu.';
                setTimeout(() => { errorElement.textContent = ''; }, 4000);
                return;
            }

            let regulationContext = "Peraturan Menteri Agama yang relevan";
            if (periodeSelesaiInput) {
                const auditYear = new Date(periodeSelesaiInput).getFullYear();
                if (auditYear <= 2024) {
                    regulationContext = "Peraturan Menteri Agama Nomor 72 Tahun 2022 tentang Organisasi dan Tata Kerja Kementerian Agama";
                } else {
                    regulationContext = "Peraturan Menteri Agama Nomor 33 Tahun 2024 tentang Organisasi dan Tata Kerja Kementerian Agama";
                }
            } else {
                 errorElement.textContent = 'Harap isi "Periode Audit" di Data Umum terlebih dahulu.';
                 setTimeout(() => { errorElement.textContent = ''; }, 4000);
                 return;
            }


            aiButton.disabled = true;
            spinner.classList.remove('hidden');
            errorElement.textContent = '';

            let prompt;
            let payload;

            if (sebab) {
                prompt = `
                    Anda adalah seorang auditor kinerja ahli untuk pemerintah Republik Indonesia, dengan spesialisasi pada audit kinerja di Kementerian Agama.
                    Konteks Audit:
                    - Satuan Kerja: ${namaSatuanKerja}
                    - Unit Kerja: ${unitKerja}
                    - Regulasi Utama: ${regulationContext}

                    Berdasarkan temuan audit berikut:
                    - **Kondisi Negatif**: ${kondisiNegatif}
                    - **Sebab**: ${sebab}

                    Tolong hasilkan analisis audit yang logis dan komprehensif dengan format JSON.
                    Instruksi:
                    1.  **kriteria**: Identifikasi dan kutip peraturan perundang-undangan yang relevan yang tidak dipatuhi. **Prioritaskan dan rujuk secara spesifik pada ${regulationContext}**. Sajikan dalam bentuk narasi yang jelas dan formal.
                    2.  **akibat**: Jabarkan maksimal 3 dampak negatif paling signifikan yang mungkin timbul dari kondisi tersebut dalam bentuk narasi.
                    3.  **rekomendasi**: Susun maksimal 3 rekomendasi yang konkret dan dapat ditindaklanjuti untuk mengatasi 'Sebab' dan mencegah 'Akibat'.

                    Pastikan semua output dalam bahasa Indonesia formal dan ada hubungan sebab-akibat yang kuat.
                `;
                payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "kriteria": { "type": "STRING" },
                                "akibat": { "type": "STRING" },
                                "rekomendasi": { "type": "STRING" }
                            },
                            required: ["kriteria", "akibat", "rekomendasi"]
                        }
                    }
                };
            } else {
                prompt = `
                    Anda adalah seorang auditor kinerja ahli untuk pemerintah Republik Indonesia, dengan spesialisasi pada audit kinerja di Kementerian Agama.
                    Konteks Audit:
                    - Satuan Kerja: ${namaSatuanKerja}
                    - Unit Kerja: ${unitKerja}
                    - Regulasi Utama: ${regulationContext}

                    Berdasarkan temuan audit berikut:
                    - **Kondisi Negatif**: ${kondisiNegatif}

                    Tolong hasilkan analisis audit yang logis dan komprehensif dengan format JSON.
                    Instruksi:
                    1.  **sebab**: Identifikasi dan jabarkan beberapa kemungkinan penyebab utama (maksimal 3) dari 'Kondisi Negatif' dalam bentuk narasi.
                    2.  **kriteria**: Berdasarkan 'Kondisi Negatif', identifikasi dan kutip peraturan perundang-undangan yang relevan yang tidak dipatuhi. **Prioritaskan dan rujuk secara spesifik pada ${regulationContext}**. Sajikan dalam bentuk narasi yang jelas dan formal.
                    3.  **akibat**: Jabarkan maksimal 3 dampak negatif paling signifikan yang mungkin timbul dari kondisi tersebut dalam bentuk narasi.
                    4.  **rekomendasi**: Susun maksimal 3 rekomendasi yang konkret dan dapat ditindaklanjuti untuk mengatasi kemungkinan penyebab dan mencegah 'Akibat'.

                    Pastikan semua output dalam bahasa Indonesia formal dan ada hubungan sebab-akibat yang kuat.
                `;
                payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "sebab": { "type": "STRING" },
                                "kriteria": { "type": "STRING" },
                                "akibat": { "type": "STRING" },
                                "rekomendasi": { "type": "STRING" }
                            },
                            required: ["sebab", "kriteria", "akibat", "rekomendasi"]
                        }
                    }
                };
            }

            let response;
            let retries = 3;
            let delay = 1000;
            while (retries > 0) {
                try {
                    const apiKey = "AIzaSyBp2bF8al-3Wg9Tk-n93Nr91i87ttMzJEc"; // Dikosongkan sesuai instruksi
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) break;

                    if (response.status === 429 || response.status >= 500) {
                        console.warn(`API request failed with status ${response.status}. Retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                        retries--;
                    } else {
                        throw new Error(`API request failed with status ${response.status}`);
                    }

                } catch (error) {
                    console.error("Fetch attempt failed:", error);
                    retries--;
                    if (retries <= 0) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }

            try {
                if (!response || !response.ok) {
                    throw new Error("Gagal mendapatkan respons dari AI setelah beberapa kali percobaan.");
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts[0].text) {
                    const content = result.candidates[0].content.parts[0].text;
                    const parsedContent = JSON.parse(content);

                    // --- PERBAIKAN UTAMA ADA DI BLOK INI ---
                    if (parsedContent.sebab) {
                        sebabEl.value = `Keadaan tersebut disebabkan oleh: ${parsedContent.sebab}`;
                    }
                    if (parsedContent.kriteria) {
                        kriteriaEl.value = `Kondisi Tersebut Tidak Sesuai Dengan: ${parsedContent.kriteria}`;
                    }
                    if (parsedContent.akibat) {
                        akibatEl.value = `Hal tersebut mengakibatkan: ${parsedContent.akibat}`;
                    }
                    if (parsedContent.rekomendasi) {
                        rekomendasiEl.value = `Inspektorat Jenderal merekomendasikan kepada kepala ${namaSatuanKerja}, ${parsedContent.rekomendasi}`;
                    }
                    // --- AKHIR PERBAIKAN ---

                } else {
                    throw new Error("Tidak ada konten yang diterima dari AI.");
                }

            } catch (error) {
                console.error("AI Analysis Error:", error);
                errorElement.textContent = 'Gagal melakukan analisis AI. Silakan coba lagi.';
                setTimeout(() => { errorElement.textContent = ''; }, 4000);
            } finally {
                aiButton.disabled = false;
                spinner.classList.add('hidden');
            }
        }

function updateModalState(subKkaCode, isViewOnly = false, viewerRole = 'Anggota', modalContext = 'kertas_kerja') {
            const currentReviewStatus = reviewApprovalStatus[subKkaCode] || 'belum_direviu';
            const isCompletedByAnggota = auditStatus[subKkaCode] === 'completed';
            
            // --- PERBAIKAN UTAMA: Logika disederhanakan dan diperketat ---
            const isUntouched = currentReviewStatus === 'belum_direviu';
            const isReturnedForFix = currentReviewStatus.startsWith('perbaikan_');
            
            // Kondisi untuk bisa mengedit: adalah Anggota DAN statusnya masih baru atau dikembalikan untuk perbaikan.
            const canEdit = viewerRole === 'Anggota' && (isUntouched || isReturnedForFix);
            // --- AKHIR PERBAIKAN ---

            // Terapkan status read-only pada semua input jika tidak bisa mengedit
            document.querySelectorAll('.audit-input').forEach(input => {
                if (input.id !== 'saldo' && input.id !== 'bobot_penilaian' && input.id !== 'hasil_skor') {
                     input.readOnly = !canEdit;
                     input.classList.toggle('bg-gray-100', !canEdit);
                }
            });
            
            // Nonaktifkan tombol AI jika tidak bisa mengedit
            const aiButton = document.getElementById('ai-analysis-btn');
            if(aiButton) {
                aiButton.disabled = !canEdit;
            }

            // Sembunyikan tombol Simpan dan Selesai jika tidak bisa mengedit
            saveProgressBtn.classList.toggle('hidden', !canEdit);
            finishAuditBtn.classList.toggle('hidden', !canEdit);
            
            // Kondisi untuk menampilkan tombol "Edit"
            const showEditButton = viewerRole === 'Anggota' && isCompletedByAnggota && isReturnedForFix;
            editAuditBtn.classList.toggle('hidden', !showEditButton);
        
            if (canEdit) {
                editAuditBtn.classList.add('hidden');
            }
        }

function saveAuditData(subKkaCode) {
    if (!subKkaCode) return null;
    const findingsData = {
        kondisi_positif: document.getElementById('kondisi_positif').value,
        kondisi_negatif: document.getElementById('kondisi_negatif').value,
        kriteria: document.getElementById('kriteria').value,
        akibat: document.getElementById('akibat').value,
        sebab: document.getElementById('sebab').value,
        rekomendasi: document.getElementById('rekomendasi').value,
        anggaran_diaudit: document.getElementById('anggaran_diaudit').value,
        temuan_keuangan: document.getElementById('temuan_keuangan').value,
        tindak_lanjut: document.getElementById('tindak_lanjut').value,
        saldo: document.getElementById('saldo').value,
        nilai_skor: document.getElementById('nilai_skor').value,
        hasil_skor: document.getElementById('hasil_skor').value,
    };
    auditFindings[subKkaCode] = findingsData;
    return findingsData;
}

async function handleSaveProgress() {
    const subKkaCode = modal.dataset.currentSubKka;
    if (saveAuditData(subKkaCode)) {
        auditStatus[subKkaCode] = 'in-progress';

        // --- PERBAIKAN: Menyimpan state ke server SEBELUM refresh UI ---
        await saveCurrentState(false); 
        // --- AKHIR PERBAIKAN ---

        if (currentUserRole === 'Anggota') {
            renderWorksheetTable(loggedInUser.nama, false);
            renderNoticeTable(loggedInUser.nama, currentUserRole);
        } else { 
            const selectedAuditorKK = document.getElementById('anggota-selector').value;
            renderWorksheetTable(selectedAuditorKK, true);
            const selectedAuditorNotisi = document.getElementById('anggota-selector-notisi').value;
            renderNoticeTable(selectedAuditorNotisi, currentUserRole);
        }

        modal.style.display = 'none';
        updateRekapitulasi();
        updateProgresStatistik();
    }
}

async function handleFinishAudit() {
    const subKkaCode = modal.dataset.currentSubKka;
    const nilaiSkorInput = document.getElementById('nilai_skor');
    const errorElement = document.getElementById('modal-error');

    errorElement.textContent = '';

    if (nilaiSkorInput.value.trim() === '') {
        errorElement.textContent = 'Harap isi kolom "Nilai" sebelum menyelesaikan.';
        setTimeout(() => { errorElement.textContent = ''; }, 3000);
        return;
    }

    if (saveAuditData(subKkaCode)) {
        auditStatus[subKkaCode] = 'completed';
        const currentStatus = reviewApprovalStatus[subKkaCode];
        if(currentStatus === 'perbaikan_ketua') {
            reviewApprovalStatus[subKkaCode] = 'direviu_ketua';
        } else if (currentStatus === 'perbaikan_teknis') {
            reviewApprovalStatus[subKkaCode] = 'direviu_teknis';
        }

        // --- PERBAIKAN: Menyimpan state ke server SEBELUM refresh UI ---
        await saveCurrentState(false);
        // --- AKHIR PERBAIKAN ---

        if (currentUserRole === 'Anggota') {
            renderWorksheetTable(loggedInUser.nama, false);
            renderNoticeTable(loggedInUser.nama, currentUserRole);
        } else {
            const selectedAuditorKK = document.getElementById('anggota-selector').value;
            renderWorksheetTable(selectedAuditorKK, true);
            const selectedAuditorNotisi = document.getElementById('anggota-selector-notisi').value;
            renderNoticeTable(selectedAuditorNotisi, currentUserRole);
        }

        modal.style.display = 'none';
        updateRekapitulasi();
        updateProgresStatistik();
    }
}
        function handleEditAudit() {
            const subKkaCode = modal.dataset.currentSubKka;
            auditStatus[subKkaCode] = 'in-progress';
            updateModalState(subKkaCode, false, 'Anggota', 'kertas_kerja');
            openAuditModal(subKkaCode, false, 'Anggota', 'kertas_kerja'); // Re-open to enable fields
        }

        function handleReviewChange(event) {
    const target = event.target;
    // Pastikan event berasal dari dalam modal dan merupakan textarea reviu
    if (target.closest('#audit-modal') && target.classList.contains('review-textarea')) {
        const subKkaCode = target.dataset.subKka;
        const reviewType = target.dataset.reviewType;

        if (!subKkaCode || !reviewType) return;

        if (!reviewNotes[subKkaCode]) {
            reviewNotes[subKkaCode] = { ketua: '', teknis: '' };
        }
        reviewNotes[subKkaCode][reviewType] = target.value;
        
        // PERBAIKAN: Panggil handleDataChange untuk menandai ada perubahan
        handleDataChange();
    }
}

async function handleReviewActions(event) {
    // Pastikan event berasal dari tombol di dalam modal
    if (!event.target.closest('#audit-modal')) return;

    const button = event.target.closest('button.review-edit-btn, button.review-save-btn, button.review-revise-btn, button.review-approve-btn');
    if (!button) return;

    const subKkaCode = modal.dataset.currentSubKka;
    const reviewType = button.dataset.reviewType;
    const textarea = document.getElementById(`reviu_${reviewType}`);
    const saveBtn = button.parentElement.querySelector('.review-save-btn');
    const editBtn = button.parentElement.querySelector('.review-edit-btn');
    let shouldCloseModal = false;
    let shouldRefreshTables = false;

    // Jaring pengaman: Selalu baca nilai terkini dari KEDUA textarea sebelum aksi.
    const reviuKetuaText = document.getElementById('reviu_ketua')?.value;
    const reviuTeknisText = document.getElementById('reviu_teknis')?.value;

    if (!reviewNotes[subKkaCode]) {
        reviewNotes[subKkaCode] = { ketua: '', teknis: '' };
    }
    if (reviuKetuaText !== undefined) {
        reviewNotes[subKkaCode].ketua = reviuKetuaText;
    }
    if (reviuTeknisText !== undefined) {
        reviewNotes[subKkaCode].teknis = reviuTeknisText;
    }

    // Aksi yang hanya mengubah UI (tidak perlu ke server)
    if (button.classList.contains('review-edit-btn')) {
        textarea.readOnly = false;
        textarea.classList.remove('bg-gray-100');
        saveBtn.style.display = 'inline-flex';
        editBtn.style.display = 'none';
        if (reviewState[subKkaCode]) reviewState[subKkaCode][reviewType] = 'editing';
        return; // Keluar dari fungsi setelah mengubah UI
    }

    // Aksi yang perlu menyimpan ke server
    if (button.classList.contains('review-save-btn')) {
        textarea.readOnly = true;
        textarea.classList.add('bg-gray-100');
        saveBtn.style.display = 'none';
        editBtn.style.display = 'inline-flex';
        if (!reviewState[subKkaCode]) reviewState[subKkaCode] = {};
        reviewState[subKkaCode][reviewType] = 'saved';
    }
    else if (button.classList.contains('review-approve-btn')) {
        if (reviewType === 'ketua') {
            reviewApprovalStatus[subKkaCode] = 'disetujui_ketua';
        } else if (reviewType === 'teknis') {
            reviewApprovalStatus[subKkaCode] = 'disetujui_teknis';
        }
        shouldCloseModal = true;
        shouldRefreshTables = true;
    }
    else if (button.classList.contains('review-revise-btn')) {
        if (reviewType === 'ketua') {
            reviewApprovalStatus[subKkaCode] = 'perbaikan_ketua';
        } else if (reviewType === 'teknis') {
            reviewApprovalStatus[subKkaCode] = 'perbaikan_teknis';
        }
        auditStatus[subKkaCode] = 'in-progress';
        shouldCloseModal = true;
        shouldRefreshTables = true;
    }

    // PERBAIKAN UTAMA: Semua aksi yang mengubah data (Simpan, Setujui, Perbaiki)
    // sekarang memanggil fungsi penyimpanan yang terisolasi dan aman.
    await sendReviewUpdateToServer();

    if (shouldCloseModal) {
        modal.style.display = 'none';
    }

    if (shouldRefreshTables) {
        // Refresh tabel notisi untuk menampilkan status baru
        const selectedAuditor = (currentUserRole === 'Anggota') ? loggedInUser.nama : document.getElementById('anggota-selector-notisi').value;
        renderNoticeTable(selectedAuditor, currentUserRole);
    }
}
async function sendReviewUpdateToServer() {
    updateSaveStatus('Menyimpan reviu...');
    const nomorST = document.getElementById('no_st').value;

    try {
        // Buat payload yang HANYA berisi data status
        const payload = {
            action: 'updateStatusAudit', // Aksi baru untuk backend
            nomor_st: nomorST,
            statusAuditData: {
                indicatorStatus,
                auditStatus,
                reviewNotes,
                reviewState,
                reviewApprovalStatus
            }
        };

        const response = await fetch(GAS_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        // Tandai data sebagai "bersih" hanya untuk status ini
        // Ini tidak akan mengganggu status "belum disimpan" di halaman lain
        isDataDirty = false; 
        updateSaveStatus('Reviu tersimpan', true);

    } catch (error) {
        console.error("Gagal menyimpan pembaruan reviu:", error);
        updateSaveStatus('Gagal menyimpan reviu', false);
    }
}
        function openPrintSelectionModal() {
            // Tentukan status persetujuan final berdasarkan keberadaan Pengendali Teknis
            const hasPengendaliTeknis = auditTeam.some(m => m.role === 'Pengendali Teknis');
            const finalStatus = hasPengendaliTeknis ? 'disetujui_teknis' : 'disetujui_ketua';

            // Saring semua KKA untuk mendapatkan Notisi yang sudah disetujui
            let approvedKKA = kkaData.filter(kka => {
                const finding = auditFindings[kka['Sub KKA']];
                const score = finding ? parseFloat(String(finding.nilai_skor).replace(',', '.')) : null;
                // Notisi adalah KKA yang disetujui DAN memiliki temuan (skor < 1)
                return reviewApprovalStatus[kka['Sub KKA']] === finalStatus && score !== null && score < 1;
            });

            // Jika pengguna adalah Anggota, saring lagi hanya untuk tugasnya
            if (currentUserRole === 'Anggota') {
                approvedKKA = approvedKKA.filter(kka => (taskAssignments[kka['Sub KKA']] || '').trim() === (loggedInUser.nama || '').trim());
            }
            
            // Definisikan urutan tahap yang benar
            const tahapOrder = ['Tahap Perencanaan', 'Tahap Pelaksanaan', 'Tahap Evaluasi & Pelaporan', 'Tahap Pencapaian Hasil/Outcome'];
            
            // Urutkan Notisi berdasarkan urutan tahap
            approvedKKA.sort((a, b) => tahapOrder.indexOf(a.Tahap) - tahapOrder.indexOf(b.Tahap));

            // Kelompokkan Notisi berdasarkan Tahap
            const groupedByTahap = approvedKKA.reduce((acc, kka) => {
                const tahap = kka['Tahap'];
                if(!acc[tahap]) acc[tahap] = [];
                acc[tahap].push(kka);
                return acc;
            }, {});

            let contentHtml = '<p class="text-sm text-gray-600 mb-4">Pilih satu atau lebih Notisi dari tahap yang sama untuk diekspor.</p>';
            if (approvedKKA.length === 0) {
                contentHtml = '<p>Tidak ada Notisi yang telah disetujui untuk diekspor.</p>';
            }

            // Tampilkan Notisi yang sudah dikelompokkan
            tahapOrder.forEach(tahap => {
                if (groupedByTahap[tahap]) {
                    contentHtml += `<div class="mb-4"><h4 class="font-bold text-lg mb-2 border-b">${tahap}</h4>`;
                    groupedByTahap[tahap].forEach(kka => {
                        contentHtml += `
                            <div class="flex items-center">
                                <input type="checkbox" id="kka-${kka['Sub KKA']}" name="kka_selection" value="${kka['Sub KKA']}" data-tahap="${tahap}" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 kka-checkbox">
                                <label for="kka-${kka['Sub KKA']}" class="ml-2 block text-sm text-gray-900">${kka['Kode KKA']} (${kka['Sub KKA']}) - ${kka['Indikator Kinerja Aspek Penilaian Audit']}</label>
                            </div>
                        `;
                    });
                    contentHtml += `</div>`;
                }
            });
            
            printSelectionBody.innerHTML = contentHtml;
            printSelectionModal.style.display = 'flex';

            // Tambahkan logika untuk hanya mengizinkan pemilihan dari tahap yang sama
            document.querySelectorAll('.kka-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const selectedCheckboxes = document.querySelectorAll('.kka-checkbox:checked');
                    
                    if (selectedCheckboxes.length > 0) {
                        const selectedTahap = selectedCheckboxes[0].dataset.tahap;
                        document.querySelectorAll('.kka-checkbox').forEach(otherCheckbox => {
                            if (otherCheckbox.dataset.tahap !== selectedTahap) {
                                otherCheckbox.disabled = true;
                                otherCheckbox.parentElement.classList.add('opacity-50');
                            }
                        });
                    } else {
                        // Jika tidak ada yang dipilih, aktifkan kembali semua
                        document.querySelectorAll('.kka-checkbox').forEach(otherCheckbox => {
                            otherCheckbox.disabled = false;
                            otherCheckbox.parentElement.classList.remove('opacity-50');
                        });
                    }
                });
            });
        }

        function handlePrintSelection() {
            const selectedCheckboxes = document.querySelectorAll('.kka-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                alert('Pilih minimal satu KKA untuk dicetak.');
                return;
            }

            const selectedSubKKAs = Array.from(selectedCheckboxes).map(cb => cb.value);
            const selectedKKAs = kkaData.filter(kka => selectedSubKKAs.includes(kka['Sub KKA']));
            
            const anggota = auditTeam.find(m => m.name === taskAssignments[selectedKKAs[0]['Sub KKA']]);
            const ketuaTim = auditTeam.find(m => m.role === 'Ketua Tim');
            const pengendaliTeknis = auditTeam.find(m => m.role === 'Pengendali Teknis');

            const firstKKA = selectedKKAs[0];
            
            // Gabungkan data dari semua KKA yang dipilih
            const indikatorList = selectedKKAs.map(k => `${k['Indikator Kinerja Aspek Penilaian Audit']} (${k['Sub KKA']})`).join(', ');
            const aggregatedData = {
                tahap: firstKKA['Tahap'],
                fungsi: firstKKA['Fungsi/Tugas (PMA Pasal)'],
                indikator: indikatorList,
                nilaiHasil: selectedKKAs.map(k => auditFindings[k['Sub KKA']]?.hasil_skor || '0').reduce((sum, val) => sum + parseFloat(String(val).replace(',','.')), 0).toFixed(3).replace('.',','),
                nilaiBobot: selectedKKAs.map(k => k['Bobot Aspek Penilaian']).reduce((sum, val) => sum + parseFloat(val), 0).toFixed(3).replace('.',','),
                halPositif: selectedKKAs.map(k => auditFindings[k['Sub KKA']]?.kondisi_positif || '').filter(Boolean).join('<br>'),
                aspekBelumMaksimal: selectedKKAs.map(k => auditFindings[k['Sub KKA']]?.kondisi_negatif || '').filter(Boolean).join('<br>'),
                tidakSesuai: selectedKKAs.map(k => auditFindings[k['Sub KKA']]?.kriteria || '').filter(Boolean).join('<br>'),
                mengakibatkan: selectedKKAs.map(k => auditFindings[k['Sub KKA']]?.akibat || '').filter(Boolean).join('<br>'),
                disebabkan: selectedKKAs.map(k => auditFindings[k['Sub KKA']]?.sebab || '').filter(Boolean).join('<br>'),
                rekomendasi: selectedKKAs.map(k => auditFindings[k['Sub KKA']]?.rekomendasi || '').filter(Boolean).join('<br>'),
            };

            const previewHTML = `
                <div class="text-center mb-4">
                    <h4 class="font-bold">Inspektorat Jenderal Kementerian Agama RI</h4>
                    <h5 class="font-bold underline">NOTISI HASIL AUDIT</h5>
                </div>
                <table class="w-full text-sm mb-4 border-collapse">
                    <tr>
                        <td class="border p-1 w-1/4">Nama Satker</td>
                        <td class="border p-1">: ${document.getElementById('satuan_kerja').value}</td>
                        <td class="border p-1 w-1/4">Disusun oleh</td>
                        <td class="border p-1">: ${anggota ? anggota.name : '................'}</td>
                    </tr>
                    <tr>
                        <td class="border p-1">Sasaran Audit</td>
                        <td class="border p-1">: ${document.getElementById('nama_audit').value}</td>
                        <td class="border p-1">Tanggal/Paraf</td>
                        <td class="border p-1">: ................. /</td>
                    </tr>
                    <tr>
                        <td class="border p-1">Periode Audit</td>
                        <td class="border p-1">: ${document.getElementById('periode_audit_mulai').value} s.d ${document.getElementById('periode_audit_selesai').value}</td>
                        <td class="border p-1">Direviu oleh</td>
                        <td class="border p-1">: ${ketuaTim ? ketuaTim.name : '................'}</td>
                    </tr>
                    <tr>
                        <td class="border p-1">Tahap</td>
                        <td class="border p-1">: ${aggregatedData.tahap}</td>
                        <td class="border p-1">Tanggal/Paraf</td>
                        <td class="border p-1">: /</td>
                    </tr>
                    <tr>
                        <td class="border p-1">Fungsi</td>
                        <td class="border p-1">: ${aggregatedData.fungsi}</td>
                        <td class="border p-1">Disetujui oleh</td>
                        <td class="border p-1">: ${pengendaliTeknis ? pengendaliTeknis.name : (ketuaTim ? ketuaTim.name : '................')}</td>
                    </tr>
                    <tr>
                        <td class="border p-1">Unit Kerja</td>
                        <td class="border p-1">: ${document.getElementById('unit_kerja').value}</td>
                        <td class="border p-1">Tanggal/Paraf</td>
                        <td class="border p-1">: /</td>
                    </tr>
                </table>
                <div class="text-sm space-y-2 text-justify">
                    <p class="font-bold text-center">TAHAP ${aggregatedData.tahap.toUpperCase().replace('TAHAP ', '')}</p>
                    <p>Berdasarkan hasil pengujian dokumen, wawancara, dan konfirmasi dengan pihak terkait, pelaksanaan kerja tahap ${aggregatedData.tahap.toLowerCase()} pada indikator ${aggregatedData.indikator}, dihasilkan hal-hal sebagai berikut:</p>
                    <p>Capaian kinerja ${aggregatedData.tahap.toLowerCase()} pada indikator ${aggregatedData.indikator} memperoleh nilai capaian ${aggregatedData.nilaiHasil} dari nilai maksimal ${aggregatedData.nilaiBobot}</p>
                    <p class="font-bold">Hal Positif</p>
                    <div class="pl-4">${aggregatedData.halPositif}</div>
                    <p class="font-bold">Terdapat aspek yang belum maksimal, yaitu:</p>
                    <div class="pl-4">${aggregatedData.aspekBelumMaksimal}</div>
                    <p class="font-bold">Kondisi tersebut tidak sesuai dengan:</p>
                    <div class="pl-4">${aggregatedData.tidakSesuai}</div>
                    <p class="font-bold">Hal tersebut mengakibatkan:</p>
                    <div class="pl-4">${aggregatedData.mengakibatkan}</div>
                    <p class="font-bold">Keadaan tersebut disebabkan oleh:</p>
                    <div class="pl-4">${aggregatedData.disebabkan}</div>
                    <p class="font-bold">Inspektorat Jenderal merekomendasikan kepada Kepala ${document.getElementById('unit_kerja').value} agar melakukan perbaikan dengan langkah-langkah sebagai berikut:</p>
                    <div class="pl-4">${aggregatedData.rekomendasi}</div>
                    <p class="font-bold mt-4">Tanggapan Auditi: (Berkop surat Satker)</p>
                </div>
            `;

            printPreviewContent.innerHTML = previewHTML;
            printSelectionModal.style.display = 'none';
            printPreviewModal.style.display = 'flex';
        }

        function exportToWord() {
            const content = document.getElementById('print-preview-content').innerHTML;
            const converted = htmlDocx.asBlob(content, {orientation: 'portrait'});
            const url = URL.createObjectURL(converted);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'notisi_audit.docx';
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportToPdf() {
            const { jsPDF } = window.jspdf;
            const content = document.getElementById('print-preview-content');
            
            html2canvas(content, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const canvasWidth = canvas.width;
                const canvasHeight = canvas.height;
                const ratio = canvasWidth / canvasHeight;
                const imgWidth = pdfWidth - 20; // with margin
                const imgHeight = imgWidth / ratio;

                let heightLeft = imgHeight;
                let position = 10; // top margin

                pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                heightLeft -= (pdfHeight - 20);

                while (heightLeft > 0) {
                    position = heightLeft - imgHeight + 10; // top margin on new page
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                    heightLeft -= (pdfHeight - 20);
                }
                
                pdf.save('notisi_audit.pdf');
            });
        }
        
        function getCategoryForScore(score) {
            const container = document.getElementById('kategori-container');
            const textEl = document.getElementById('kategori-kinerja');
            
            container.className = 'w-1/2 p-4 border rounded-lg flex items-center justify-center';
            textEl.className = 'text-4xl font-bold';

            if (score > 90) {
                container.classList.add('bg-green-100', 'border-green-400');
                textEl.classList.add('text-green-700');
                return 'SANGAT BAIK';
            }
            if (score > 75) {
                container.classList.add('bg-blue-100', 'border-blue-400');
                textEl.classList.add('text-blue-700');
                return 'BAIK';
            }
            if (score > 60) {
                container.classList.add('bg-yellow-100', 'border-yellow-400');
                textEl.classList.add('text-yellow-700');
                return 'CUKUP BAIK';
            }
            if (score > 50) {
                container.classList.add('bg-orange-100', 'border-orange-400');
                textEl.classList.add('text-orange-700');
                return 'KURANG BAIK';
            }
            container.classList.add('bg-red-100', 'border-red-400');
            textEl.classList.add('text-red-700');
            return 'BURUK';
        }

        function updateRekapitulasi() {
            const stageWeights = {
                perencanaan: parseFloat(document.getElementById('bobot_perencanaan').value) || 0,
                pelaksanaan: parseFloat(document.getElementById('bobot_pelaksanaan').value) || 0,
                evaluasi: parseFloat(document.getElementById('bobot_evaluasi').value) || 0,
                pencapaian: parseFloat(document.getElementById('bobot_pencapaian').value) || 0,
            };

            const hasil = { perencanaan: 0, pelaksanaan: 0, evaluasi: 0, pencapaian: 0 };

        for (const subKka in auditFindings) {
                const finding = auditFindings[subKka];
                const task = kkaData.find(k => k['Sub KKA'] === subKka);
                if (finding && task && finding.hasil_skor) {
                    const hasilSkor = parseFloat(String(finding.hasil_skor).replace(',', '.')) || 0;
                    if (task.Tahap === 'Tahap Perencanaan') hasil.perencanaan += hasilSkor;
                    else if (task.Tahap === 'Tahap Pelaksanaan') hasil.pelaksanaan += hasilSkor;
                    else if (task.Tahap === 'Tahap Evaluasi & Pelaporan') hasil.evaluasi += hasilSkor;
                    else if (task.Tahap === 'Tahap Pencapaian Hasil/Outcome') hasil.pencapaian += hasilSkor;
                }
            }
        // PERBAIKAN SELESAI

            document.getElementById('rekap-bobot-perencanaan').textContent = stageWeights.perencanaan;
            document.getElementById('rekap-bobot-pelaksanaan').textContent = stageWeights.pelaksanaan;
            document.getElementById('rekap-bobot-evaluasi').textContent = stageWeights.evaluasi;
            document.getElementById('rekap-bobot-pencapaian').textContent = stageWeights.pencapaian;
            const totalBobot = stageWeights.perencanaan + stageWeights.pelaksanaan + stageWeights.evaluasi + stageWeights.pencapaian;
            document.getElementById('rekap-bobot-total').textContent = totalBobot;

            document.getElementById('rekap-hasil-perencanaan').textContent = hasil.perencanaan.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('rekap-hasil-pelaksanaan').textContent = hasil.pelaksanaan.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('rekap-hasil-evaluasi').textContent = hasil.evaluasi.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('rekap-hasil-pencapaian').textContent = hasil.pencapaian.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            const totalHasil = hasil.perencanaan + hasil.pelaksanaan + hasil.evaluasi + hasil.pencapaian;
            document.getElementById('rekap-hasil-total').textContent = totalHasil.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            const skorKinerja = Math.round(totalHasil);
            document.getElementById('skor-kinerja').textContent = skorKinerja;
            document.getElementById('kategori-kinerja').textContent = getCategoryForScore(skorKinerja);
        }

        function updateProgresStatistik() {
            const hasPengendaliTeknis = auditTeam.some(m => m.role === 'Pengendali Teknis');
            const finalApprovalStatus = hasPengendaliTeknis ? 'disetujui_teknis' : 'disetujui_ketua';

            const getKKAStatus = (subKka) => {
                const approvalStatus = reviewApprovalStatus[subKka];
                const workStatus = auditStatus[subKka];

                if (approvalStatus === finalApprovalStatus) {
                    return 'Selesai';
                }
                if (workStatus === 'in-progress' || workStatus === 'completed' || (approvalStatus && approvalStatus !== 'belum_direviu')) {
                    return 'Sedang Audit';
                }
                return 'Belum Diaudit';
            };

            // Berdasarkan Tahap
            const tahapStats = {
                'Tahap Perencanaan': { total: 0, belum: 0, sedang: 0, selesai: 0 },
                'Tahap Pelaksanaan': { total: 0, belum: 0, sedang: 0, selesai: 0 },
                'Tahap Evaluasi & Pelaporan': { total: 0, belum: 0, sedang: 0, selesai: 0 },
                'Tahap Pencapaian Hasil/Outcome': { total: 0, belum: 0, sedang: 0, selesai: 0 },
            };

            kkaData.forEach(kka => {
                // HANYA HITUNG JIKA KKA DINILAI (Y)
                if (indicatorStatus[kka['Sub KKA']] === 'Y') {
                    const tahap = kka['Tahap'];
                    if (tahap && tahapStats[tahap]) {
                        tahapStats[tahap].total++;
                        const status = getKKAStatus(kka['Sub KKA']);
                        if (status === 'Selesai') tahapStats[tahap].selesai++;
                        else if (status === 'Sedang Audit') tahapStats[tahap].sedang++;
                        else tahapStats[tahap].belum++;
                    }
                }
            });

            const tahapBody = document.getElementById('tabel-progres-tahap');
            tahapBody.innerHTML = '';
            for (const tahapName in tahapStats) {
                const stats = tahapStats[tahapName];
                tahapBody.innerHTML += `
                    <tr>
                        <td class="px-4 py-2 border border-gray-300 text-left">${tahapName}</td>
                        <td class="px-4 py-2 border border-gray-300">${stats.total}</td>
                        <td class="px-4 py-2 border border-gray-300">${stats.belum}</td>
                        <td class="px-4 py-2 border border-gray-300">${stats.sedang}</td>
                        <td class="px-4 py-2 border border-gray-300">${stats.selesai}</td>
                    </tr>
                `;
            }

            // Berdasarkan Auditor
            const auditorStats = {};
            const assignedAuditors = auditTeam.filter(m => m.role === 'Anggota');

            assignedAuditors.forEach(auditor => {
                auditorStats[auditor.name] = { total: 0, belum: 0, sedang: 0, selesai: 0 };
            });

            for (const subKka in taskAssignments) {
                const auditorName = taskAssignments[subKka];
                if (auditorStats[auditorName]) {
                    auditorStats[auditorName].total++;
                    const status = getKKAStatus(subKka);
                    if (status === 'Selesai') auditorStats[auditorName].selesai++;
                    else if (status === 'Sedang Audit') auditorStats[auditorName].sedang++;
                    else auditorStats[auditorName].belum++;
                }
            }
            
            const auditorBody = document.getElementById('tabel-progres-auditor');
            auditorBody.innerHTML = '';
            for (const auditorName in auditorStats) {
                const stats = auditorStats[auditorName];
                auditorBody.innerHTML += `
                    <tr>
                        <td class="px-4 py-2 border border-gray-300 text-left">${auditorName}</td>
                        <td class="px-4 py-2 border border-gray-300">${stats.total}</td>
                        <td class="px-4 py-2 border border-gray-300">${stats.belum}</td>
                        <td class="px-4 py-2 border border-gray-300">${stats.sedang}</td>
                        <td class="px-4 py-2 border border-gray-300">${stats.selesai}</td>
                    </tr>
                `;
            }
        }

        function getKualitasKinerja3E(score, aspek) {
            let kategori = `Tidak ${aspek}`; // Default
            if (score > 90) kategori = `Sangat ${aspek}`;
            else if (score > 75) kategori = aspek;
            else if (score > 60) kategori = `Cukup ${aspek}`;
            else if (score > 50) kategori = `Kurang ${aspek}`;
            return kategori;
        }


        function update3EScore() {
            const aspek3E = ['Ekonomis', 'Efisien', 'Efektif'];
            const tabelBody = document.getElementById('tabel-skor-3e');
            tabelBody.innerHTML = '';

            aspek3E.forEach(aspek => {
                let totalHasil = 0;
                let totalBobot = 0;

                const filteredKKA = kkaData.filter(kka => kka['3E'] === aspek && indicatorStatus[kka['Sub KKA']] === 'Y');

                filteredKKA.forEach(kka => {
                    totalBobot += parseFloat(kka['Bobot Aspek Penilaian']) || 0;
                    const finding = auditFindings[kka['Sub KKA']];
                    if (finding && finding.hasil_skor) {
                        totalHasil += parseFloat(String(finding.hasil_skor).replace(',', '.')) || 0;
                    }
                });

                const skor = totalBobot > 0 ? (totalHasil / totalBobot) * 100 : 0;
                const kualitas = getKualitasKinerja3E(skor, aspek);

                const row = `
                    <tr>
                        <td class="px-4 py-2 border border-gray-300 text-left font-medium">${aspek}</td>
                        <td class="px-4 py-2 border border-gray-300">${totalHasil.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        <td class="px-4 py-2 border border-gray-300">${totalBobot.toLocaleString('id-ID', { minimumFractionDigits: 3, maximumFractionDigits: 3 })}</td>
                        <td class="px-4 py-2 border border-gray-300 font-bold">${skor.toFixed(2)}</td>
                        <td class="px-4 py-2 border border-gray-300 font-semibold">${kualitas}</td>
                    </tr>
                `;
                tabelBody.innerHTML += row;
            });
        }

        function updateRekapitulasiKeuangan() {
            let totalAnggaran = 0;
            let totalTemuan = 0;
            let totalTindakLanjut = 0;

            for (const subKka in auditFindings) {
                const finding = auditFindings[subKka];
                if (finding) {
                    totalAnggaran += parseNumber(finding.anggaran_diaudit);
                    totalTemuan += parseNumber(finding.temuan_keuangan);
                    totalTindakLanjut += parseNumber(finding.tindak_lanjut);
                }
            }

            const totalSaldo = totalTemuan - totalTindakLanjut;

            document.getElementById('rekap-anggaran-diaudit').textContent = `Rp ${formatNumber(totalAnggaran)}`;
            document.getElementById('rekap-temuan-keuangan').textContent = `Rp ${formatNumber(totalTemuan)}`;
            document.getElementById('rekap-tindak-lanjut').textContent = `Rp ${formatNumber(totalTindakLanjut)}`;
            document.getElementById('rekap-saldo').textContent = `Rp ${formatNumber(totalSaldo)}`;
        }
        
        function exportLhaToWord() {
            const content = document.getElementById('lha-content').innerHTML;
            const converted = htmlDocx.asBlob(content, {orientation: 'portrait'});
            const url = URL.createObjectURL(converted);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'LHA.docx';
            a.click();
            URL.revokeObjectURL(url);
        }

function formatDate(dateString) {
            if (!dateString || isNaN(new Date(dateString))) {
                return '................';
            }
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            const date = new Date(dateString);
            return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
        }

        function formatDate(dateString) {
            if (!dateString || isNaN(new Date(dateString))) {
                return '................';
            }
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            const date = new Date(dateString);
            return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
        }
function handleSignOut() {
            if (isDataDirty) {
                // Jika ada perubahan, gunakan modal yang sudah ada
                navigationTarget = { menuId: 'signout', element: null }; // Gunakan target khusus
                document.getElementById('unsaved-changes-modal').style.display = 'flex';
            } else {
                // Jika tidak ada perubahan, langsung reload halaman
                window.location.reload();
            }
        }

        function renderLHA() {
            const lhaContainer = document.getElementById('lha-content');
            lhaContainer.innerHTML = '<p>Membuat laporan...</p>';

            const dataUmum = collectDataUmum();
            const skorKinerja = document.getElementById('skor-kinerja').textContent;
            
            const kualitas3E = {};
            ['Ekonomis', 'Efisien', 'Efektif'].forEach(aspek => {
                let totalHasil = 0;
                let totalBobot = 0;
                const filteredKKA = kkaData.filter(kka => kka['3E'] === aspek && indicatorStatus[kka['Sub KKA']] === 'Y');
                filteredKKA.forEach(kka => {
                    totalBobot += parseFloat(kka['Bobot Aspek Penilaian']) || 0;
                    const finding = auditFindings[kka['Sub KKA']];
                    if (finding && finding.hasil_skor) {
                        totalHasil += parseFloat(String(finding.hasil_skor).replace(',', '.')) || 0;
                    }
                });
                const skor = totalBobot > 0 ? (totalHasil / totalBobot) * 100 : 0;
                kualitas3E[aspek] = getKualitasKinerja3E(skor, aspek);
            });

            const penanggungJawab = auditTeam.find(m => m.role === 'Penanggung Jawab');

            const groupedByTahap = kkaData.reduce((acc, kka) => {
                if(indicatorStatus[kka['Sub KKA']] !== 'Y') return acc;
                const tahap = kka['Tahap'];
                const fungsi = kka['Kode KKA'];
                if (!acc[tahap]) acc[tahap] = {};
                if (!acc[tahap][fungsi]) acc[tahap][fungsi] = [];
                acc[tahap][fungsi].push(kka);
                return acc;
            }, {});

            let rincianHasilAuditHtml = '<table class="lha-table" style="width: 100%; margin-top: 1rem;">';
            rincianHasilAuditHtml += `
                <thead>
                    <tr>
                        <th rowspan="2" style="width: 10%;">Nomor</th>
                        <th rowspan="2">Fungsi/Sub Fungsi</th>
                        <th colspan="2">Bobot Penilaian</th>
                    </tr>
                    <tr>
                        <th style="width: 15%;">Bobot</th>
                        <th style="width: 15%;">Hasil</th>
                    </tr>
                </thead>
                <tbody>
            `;

            const tahapMapping = {
                'Tahap Perencanaan': 'A',
                'Tahap Pelaksanaan': 'B',
                'Tahap Evaluasi & Pelaporan': 'C',
                'Tahap Pencapaian Hasil/Outcome': 'D'
            };

            for (const tahap in groupedByTahap) {
                rincianHasilAuditHtml += `
                    <tr>
                        <td style="font-weight: bold; text-align: center;">${tahapMapping[tahap] || ''}</td>
                        <td style="font-weight: bold; text-align: left;" colspan="3">${tahap}</td>
                    </tr>
                `;

                for (const fungsi in groupedByTahap[tahap]) {
                    const subKkaList = groupedByTahap[tahap][fungsi];
                    const firstSubKka = subKkaList[0]; 

                    let totalBobotFungsi = 0;
                    let totalHasilFungsi = 0;

                    subKkaList.forEach(kka => {
                        totalBobotFungsi += parseFloat(kka['Bobot Aspek Penilaian'] || 0);
                        const finding = auditFindings[kka['Sub KKA']];
                        if (finding && finding.hasil_skor) {
                            totalHasilFungsi += parseFloat(String(finding.hasil_skor).replace(',', '.')) || 0;
                        }
                    });
                    
                    const fungsiText = (firstSubKka['Fungsi/Tugas (PMA Pasal)'] || '').replace(/\(Pasal.*?\)/g, '').trim();

                    rincianHasilAuditHtml += `
                        <tr>
                            <td style="text-align: center;">${fungsi}</td>
                            <td style="text-align: left;">${fungsiText}</td>
                            <td style="text-align: center;">${totalBobotFungsi > 0 ? String(totalBobotFungsi.toFixed(3)).replace('.', ',') : '-'}</td>
                            <td style="text-align: center;">${totalBobotFungsi > 0 ? String(totalHasilFungsi.toFixed(3)).replace('.', ',') : '-'}</td>
                        </tr>
                    `;
                }
            }

            const totalBobotRekap = parseFloat(document.getElementById('rekap-bobot-total').textContent) || 100;
            const totalHasilRekap = parseFloat(document.getElementById('rekap-hasil-total').textContent.replace(',', '.')) || 0;

            rincianHasilAuditHtml += `
                    <tr>
                        <td colspan="2" style="font-weight: bold; text-align: center;">JUMLAH</td>
                        <td style="font-weight: bold; text-align: center;">${totalBobotRekap.toLocaleString('id-ID')}</td>
                        <td style="font-weight: bold; text-align: center;">${totalHasilRekap.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    </tr>
                </tbody>
            </table>
            `;
            
            // --- PERBAIKAN UTAMA: Menambahkan penomoran bertingkat ---
            let faktaAuditHtml = '';
            let tahapCounter = 1;
            for (const tahap in groupedByTahap) {
                const totalBobotTahap = parseFloat(document.getElementById(`rekap-bobot-${tahap.split(' ')[1].toLowerCase()}`).textContent) || 0;
                const totalHasilTahap = parseFloat(document.getElementById(`rekap-hasil-${tahap.split(' ')[1].toLowerCase()}`).textContent.replace(',','.')) || 0;
                
                faktaAuditHtml += `
                    <h4 style="font-weight: bold; margin-top: 1.5rem; text-indent: -1rem; padding-left: 1rem;">${tahapCounter}. ${tahap}</h4>
                    <p>Tahap ${tahap.toLowerCase().replace('tahap ','')} memperoleh nilai capaian kinerja ${totalHasilTahap.toFixed(2)} dari hasil maksimal ${totalBobotTahap.toFixed(2)}.</p>
                    <p>Tahap ${tahap.toLowerCase().replace('tahap ','')} mengukur ${Object.keys(groupedByTahap[tahap]).length} fungsi yaitu:</p>
                `;

                let fungsiCounter = 0;
                for (const fungsi in groupedByTahap[tahap]) {
                    const kkaFungsi = groupedByTahap[tahap][fungsi][0];
                    const fungsiText = (kkaFungsi['Fungsi/Tugas (PMA Pasal)'] || '').replace(/\(Pasal.*?\)/g, '').trim();

                    faktaAuditHtml += `
                        <div style="margin-left: 1rem;">
                            <h5 style="font-weight: bold; margin-top: 1rem; text-indent: -1rem; padding-left: 1rem;">${String.fromCharCode(97 + fungsiCounter)}. Fungsi ${fungsiText} (${fungsi})</h5>
                            <p>Berdasarkan hasil pengujian dokumen, wawancara, dan konfirmasi dengan pihak terkait, pelaksanaan kerja fungsi ${fungsiText} pada ${dataUmum.nama_satuan_kerja}, dapat digambarkan hasilnya sebagai berikut:</p>
                        </div>
                    `;
                    
                    let indikatorCounter = 1;
                    groupedByTahap[tahap][fungsi].forEach(kka => {
                        const finding = auditFindings[kka['Sub KKA']];
                        if (finding && finding.kondisi_negatif) {
                            faktaAuditHtml += `
                                <div style="margin-left: 2rem;">
                                    <p style="margin-top: 1rem; text-indent: -1.5rem; padding-left: 1.5rem;">${indikatorCounter}) ${kka['Indikator Kinerja Aspek Penilaian Audit']} (${kka['Sub KKA']})</p>
                                    <p>${finding.kondisi_negatif || '...'}</p>
                                    <p style="font-weight: bold;">Kondisi tersebut tidak sesuai dengan:</p>
                                    <p>${finding.kriteria || '...'}</p>
                                    <p style="font-weight: bold;">Akibatnya:</p>
                                    <p>${finding.akibat || '...'}</p>
                                    <p style="font-weight: bold;">Kondisi tersebut disebabkan oleh:</p>
                                    <p>${finding.sebab || '...'}</p>
                                </div>
                            `;
                            indikatorCounter++;
                        }
                    });
                    fungsiCounter++;
                }
                tahapCounter++;
            }
            // --- AKHIR PERBAIKAN ---
            
            let rekomendasiHtml = '';
            for (const tahap in groupedByTahap) {
                 rekomendasiHtml += `
                    <h4 style="font-weight: bold; margin-top: 1.5rem;">${tahap}</h4>
                    <p>Terhadap temuan pada tahap ${tahap.toLowerCase().replace('tahap ','')}:</p>
                    <ol style="list-style-type: decimal; padding-left: 2rem;">
                `;
                for (const fungsi in groupedByTahap[tahap]) {
                    groupedByTahap[tahap][fungsi].forEach(kka => {
                         const finding = auditFindings[kka['Sub KKA']];
                         if (finding && finding.rekomendasi) {
                             rekomendasiHtml += `<li>${finding.rekomendasi}</li>`;
                         }
                    });
                }
                rekomendasiHtml += `</ol>`;
            }

            const lhaHtml = `
                <div style="text-align: left; margin-bottom: 2rem;">
                    <p>Nomor : .................... &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ${formatDate(new Date())}</p>
                    <p>Sifat : Rahasia</p>
                    <p>Lampiran : Satu berkas</p>
                    <p>Hal : Laporan Hasil Audit Kinerja Pada ${dataUmum.nama_satuan_kerja || '(Satuan Kerja)'} Tahun Anggaran ${new Date(dataUmum.periode_audit_selesai).getFullYear() || '20xx'}</p>
                </div>
                <div style="margin-bottom: 2rem;">
                    <p>Yth. (Atasan Langsung Satuan Kerja)</p>
                    <p>Kementerian Agama RI</p>
                    <p>Jakarta</p>
                </div>
                <p>Berdasarkan hasil audit kinerja Tim Inspektorat Jenderal Kementerian Agama pada ${dataUmum.nama_satuan_kerja || '........'} Tahun Anggaran ${new Date(dataUmum.periode_audit_selesai).getFullYear() || '20xx'}, sesuai dengan Surat Tugas Inspektur Jenderal Kementerian Agama Nomor: ${dataUmum.no_st || '......'} tanggal ${formatDate(dataUmum.tgl_st)}, dengan ini kami sampaikan pokok-pokok hasil audit.</p>
                
                <h3 style="font-weight: bold; text-align: left; margin-top: 1.5rem;">Simpulan Hasil Audit</h3>
                <p>Nilai capaian kinerja berdasarkan hasil audit kinerja pada ${dataUmum.nama_satuan_kerja || '...'} adalah ${skorKinerja} dengan kualitas kinerja "${kualitas3E['Ekonomis'] || '...'}" dalam pengelolaan keuangan dan BMN, "${kualitas3E['Efisien'] || '...'}" dalam kinerja fungsi perencanaan, pelaksanaan, dan evaluasi pelaporan, serta "${kualitas3E['Efektif'] || '...'}" dalam pencapaian hasil (outcome).</p>
                
                <h3 style="font-weight: bold; text-align: left; margin-top: 1.5rem;">Rekomendasi</h3>
                <p>Dari hasil audit, Inspektorat Jenderal memberikan rekomendasi kepada (Atasan Langsung Satuan Kerja) agar memerintahkan ${dataUmum.jabatan_pimpinan || '(Jabatan Pimpinan)'}, untuk melakukan langkah-langkah perbaikan sesuai dengan uraian rekomendasi yang ada di BAB III.</p>
                
                <div style="page-break-before: always;"></div>

                <h2 style="font-weight: bold; text-align: center;">BAB I<br/>GAMBARAN UMUM</h2>
                
                <h3 style="font-weight: bold; margin-top: 1.5rem;">A. DATA AUDITI</h3>
                <table style="width: 100%; border-collapse: collapse;">
                    <tr><td style="width: 25%; vertical-align: top;">Nama Auditi</td><td style="vertical-align: top;">: ${dataUmum.nama_satuan_kerja || '...'}</td></tr>
                    <tr><td style="vertical-align: top;">Alamat</td><td style="vertical-align: top;">: ${dataUmum.alamat || '...'}</td></tr>
                    <tr><td colspan="2" style="padding-top: 0.5rem;">Pimpinan</td></tr>
                    <tr><td style="padding-left: 1rem; vertical-align: top;">Nama</td><td style="vertical-align: top;">: ${dataUmum.nama_pimpinan || '...'}</td></tr>
                    <tr><td style="padding-left: 1rem; vertical-align: top;">Jabatan</td><td style="vertical-align: top;">: ${dataUmum.jabatan_pimpinan || '...'}</td></tr>
                    <tr><td style="padding-left: 1rem; vertical-align: top;">NIP</td><td style="vertical-align: top;">: ${dataUmum.nip_pimpinan || '...'}</td></tr>
                    <tr><td style="padding-left: 1rem; vertical-align: top;">Pangkat/Golongan</td><td style="vertical-align: top;">: ${dataUmum.pangkat_golongan || '...'}</td></tr>
                </table>

                <h3 style="font-weight: bold; margin-top: 1.5rem;">B. TUJUAN AUDIT</h3>
                <ol style="list-style-type: decimal; padding-left: 2rem; margin: 0;">
                    <li>Menilai aspek kehematan, efisiensi dan efektifitas pengelolaan program kerja dan pelaksanaan tugas dan fungsi satuan kerja.</li>
                    <li>Memberikan Informasi hasil audit kepada pimpinan sebagai pertimbangan untuk mengambil Kebijakan.</li>
                    <li>Memberikan rekomendasi untuk perbaikan kinerja.</li>
                </ol>

                <h3 style="font-weight: bold; margin-top: 1.5rem;">C. RUANG LINGKUP</h3>
                <p>Penilaian terhadap fungsi perencanaan, pelaksanaan, pelaporan dan evaluasi, serta pencapaian hasil terhadap pelaksanaan tugas dan fungsi satuan kerja, namun tidak mencakup (hal-hal yang dikecualikan kalau ada).</p>

                <h3 style="font-weight: bold; margin-top: 1.5rem;">D. WAKTU AUDIT</h3>
                <p>Audit dilaksanakan mulai tanggal ${formatDate(dataUmum.waktu_audit_mulai)} sampai dengan tanggal ${formatDate(dataUmum.waktu_audit_selesai)}.</p>

                <h3 style="font-weight: bold; margin-top: 1.5rem;">E. PERIODE AUDIT</h3>
                <p>Periode yang diaudit meliputi masa sejak ${formatDate(dataUmum.periode_audit_mulai)} sampai ${formatDate(dataUmum.periode_audit_selesai)}.</p>
                
                <h3 style="font-weight: bold; margin-top: 1.5rem;">F. STANDAR AUDIT</h3>
                <p>Audit telah dilaksanakan sesuai dengan standar audit yang diterbitkan oleh Asosiasi Auditor Intern Pemerintah Indonesia (AAIPI).</p>
                
                <h3 style="font-weight: bold; margin-top: 1.5rem;">G. METODE AUDIT</h3>
                <p>Audit kinerja ini dilaksanakan dengan metode dengan metode pengukuran Integrated Performance Measurement System (IPMS) yaitu metode pengukuran kinerja yang terintegrasi untuk mengukur kinerja suatu organisasi yang dilakukan secara top-down dengan memperhatikan kebutuhan dari setiap stakeholder.</p>
                <p style="font-weight: bold;">Penetapan Indikator dan Pembobotan</p>
                <p>Penetapan indikator kinerja atau Key Performance Indicator (KPI) didasarkan atas pelaksanaan tugas dan fungsi pada ${dataUmum.nama_satuan_kerja || '(Nama Satuan Kerja)'}. KPI yang ditetapkan merupakan ukuran kualitatif yang dikuantitatifkan atas pelaksanaan tugas dan fungsi untuk mengukur atau membandingkan kinerja dalam hal memenuhi tujuan strategis dan program. Pembobotan masing-masing kegiatan telah ditetapkan pada KPI untuk setiap satker dengan jumlah ${kkaData.filter(kka => indicatorStatus[kka['Sub KKA']] === 'Y').length || '...'} untuk setiap fungsi pada ${dataUmum.nama_satuan_kerja || '...'}.</p>
                <p>Adapun indikator-indikator keberhasilan pelaksanaan tugas dan fungsi pada ${dataUmum.nama_satuan_kerja || '...'} sebagai berikut:</p>
                <table class="lha-table" style="width: 50%; margin-top: 1rem;">
                    <thead><tr><th>No</th><th>Uraian</th><th>Bobot</th></tr></thead>
                    <tbody>
                        <tr><td style="text-align: center;">1.</td><td>Perencanaan</td><td style="text-align: center;">${dataUmum.bobot_perencanaan || '...'}</td></tr>
                        <tr><td style="text-align: center;">2.</td><td>Pelaksanaan</td><td style="text-align: center;">${dataUmum.bobot_pelaksanaan || '...'}</td></tr>
                        <tr><td style="text-align: center;">3.</td><td>Evaluasi dan Pelaporan</td><td style="text-align: center;">${dataUmum.bobot_evaluasi || '...'}</td></tr>
                        <tr><td style="text-align: center;">4.</td><td>Pengukuran Pencapaian Sasaran/Outcome</td><td style="text-align: center;">${dataUmum.bobot_pencapaian || '...'}</td></tr>
                        <tr><td colspan="2" style="font-weight: bold; text-align: center;">TOTAL</td><td style="font-weight: bold; text-align: center;">100</td></tr>
                    </tbody>
                </table>
                <p style="margin-top: 1rem; font-weight: bold;">Tanggapan audit</p>
                <p>Pihak auditi telah menanggapi dan mengakui hasil audit yang dilakukan oleh tim audit Inspektorat Jenderal Kementerian Agama.</p>
                
                <h3 style="font-weight: bold; margin-top: 1.5rem;">H. INFORMASI UMUM</h3>
                <p>Struktur organisasi</p>
                <p>Kekuatan Sumber Daya</p>

                <h3 style="font-weight: bold; margin-top: 1.5rem;">I. REALISASI KEUANGAN</h3>
                <p>Pagu anggaran ${dataUmum.nama_satuan_kerja || '(satuan kerja)'} Tahun ... sebesar Rp... dengan realisasi sebesar Rp... (...%). Tahun ... pagu anggaran sebesar Rp... realisasi sebesar Rp... (...%)</p>
                <p style="margin-top: 1rem; text-align: center; font-weight: bold;">Realisasi Anggaran Tahun ...</p>
                <table class="lha-table" style="width: 100%; margin-top: 1rem; text-align: center;">
                    <thead><tr><th>Jenis Belanja</th><th>Anggaran</th><th>Realisasi</th><th>%</th><th>Sisa</th></tr></thead>
                    <tbody>
                        <tr><td>Belanja Pegawai</td><td>...</td><td>...</td><td>...</td><td>...</td></tr>
                        <tr><td>Belanja Barang</td><td>...</td><td>...</td><td>...</td><td>...</td></tr>
                        <tr><td>Belanja Modal</td><td>...</td><td>...</td><td>...</td><td>...</td></tr>
                        <tr><td>Bantuan Sosial</td><td>...</td><td>...</td><td>...</td><td>...</td></tr>
                        <tr><td style="font-weight: bold;">Jumlah</td><td style="font-weight: bold;">...</td><td style="font-weight: bold;">...</td><td style="font-weight: bold;">...</td><td style="font-weight: bold;">...</td></tr>
                    </tbody>
                </table>

                <div style="page-break-before: always;"></div>
                
                <h2 style="font-weight: bold; text-align: center;">BAB II<br/>URAIAN HASIL AUDIT</h2>
                <h3 style="font-weight: bold;">A. SIMPULAN HASIL AUDIT</h3>
                <p>Nilai capaian kinerja berdasarkan hasil audit kinerja pada ${dataUmum.nama_satuan_kerja} adalah ${skorKinerja} dengan kualitas kinerja ${kualitas3E['Ekonomis']} dalam pengelolaan keuangan dan BMN, ${kualitas3E['Efisien']} dalam kinerja fungsi perencanaan, pelaksanaan, dan evaluasi pelaporan, serta ${kualitas3E['Efektif']} dalam pencapaian hasil (outcome), dengan nilai rinci sebagai berikut:</p>
                ${rincianHasilAuditHtml}
                <h3 style="font-weight: bold; margin-top: 1.5rem;">B. FAKTA AUDIT</h3>
                ${faktaAuditHtml}

                <div style="page-break-before: always;"></div>

                <h2 style="font-weight: bold; text-align: center;">BAB III<br/>REKOMENDASI</h2>
                <p>Dari hasil audit yang telah diuraikan, Inspektorat Jenderal memberikan rekomendasi kepada (Atasan Langsung Satuan Kerja) agar memerintahkan ${dataUmum.jabatan_pimpinan || '(Jabatan Pimpinan)'}, untuk melakukan langkah-langkah perbaikan sebagai berikut:</p>
                ${rekomendasiHtml}

                <div style="page-break-before: always;"></div>

                <h2 style="font-weight: bold; text-align: center;">BAB IV<br/>PENUTUP</h2>
                <p>Demikian laporan hasil audit (LHA) ini kami sampaikan untuk ditindaklanjuti selambat-lambatnya dalam waktu 60 (enam puluh) hari sejak diterima, dan hasilnya disampaikan kepada Inspektur Jenderal Kementerian Agama. Atas perhatian dan kerja sama Saudara, kami sampaikan terimakasih.</p>
                <div style="margin-top: 3rem; text-align: center; margin-left: 50%;">
                    <p>a.n Inspektur Jenderal</p>
                    <p>Inspektur ....</p>
                    <br/><br/><br/>
                    <p>(${penanggungJawab ? penanggungJawab.name : '.......................'})</p>
                </div>
            `;
            lhaContainer.innerHTML = lhaHtml;
        }
        // Sisipkan semua fungsi baru ini di dalam tag <script>

async function fetchAllAuditsDataAndRenderDashboard() {
    showLoading("Mengambil semua data audit...");
    try {
        const response = await fetch(`${GAS_URL}?action=getAllAuditsData`);
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        
        allAuditsData = data; // Simpan data di state global

        // PERBAIKAN: Muat master KKA jika belum ada
        if (fullMasterKKA.length === 0) {
            const kkaResponse = await fetch(`${GAS_URL}?action=getAllMasterKKA`);
            const kkaResult = await kkaResponse.json();
            if (kkaResult.error) throw new Error(kkaResult.error);
            fullMasterKKA = kkaResult.masterKKA || [];
        }

        // Isi filter Satker sekali saja
        const uniqueSatkers = [...new Set(allAuditsData.map(audit => audit.dataUmum.satuan_kerja).filter(Boolean))];
        dashboardFilterSatker.innerHTML = '<option value="semua">Semua Satker</option>';
        uniqueSatkers.forEach(satker => {
            dashboardFilterSatker.innerHTML += `<option value="${satker}">${satker}</option>`;
        });

        renderDashboard(); // Render dashboard untuk pertama kali
    } catch (error) {
        console.error("Gagal mengambil semua data audit:", error);
        alert("Gagal mengambil data untuk dashboard. Coba lagi.");
    } finally {
        hideLoading();
    }
}

function stopPollingForUpdates() {
            if (pollingIntervalId) {
                clearInterval(pollingIntervalId);
                pollingIntervalId = null;
            }
        }

        function startPollingForUpdates() {
            // Hentikan polling yang mungkin sudah berjalan sebelum memulai yang baru
            stopPollingForUpdates();

            const nomorST = document.getElementById('no_st').value;
            if (!nomorST) return; // Jangan lakukan polling jika tidak ada audit yang dimuat

            pollingIntervalId = setInterval(async () => {
                try {
                    // Meminta pembaruan status yang ringan dari server
                    const response = await fetch(`${GAS_URL}?action=getAuditStatusUpdates&nomor_st=${encodeURIComponent(nomorST)}`);
                    if (!response.ok) return; // Gagal secara diam-diam jika ada masalah jaringan

                    const data = await response.json();
                    if (data.error) {
                        console.error("Kesalahan saat polling:", data.error);
                        stopPollingForUpdates(); // Hentikan jika ada error dari server
                        return;
                    }
                    
                    // Bandingkan data baru dengan data lama untuk melihat apakah ada perubahan
                    const hasChanges = JSON.stringify(data.statusAudit.reviewNotes) !== JSON.stringify(reviewNotes) ||
                                     JSON.stringify(data.statusAudit.reviewApprovalStatus) !== JSON.stringify(reviewApprovalStatus);

                    if (hasChanges) {
                        // Jika ada perubahan, perbarui state global di browser
                        const allStatus = data.statusAudit || {};
                        reviewNotes = allStatus.reviewNotes || {};
                        reviewState = allStatus.reviewState || {};
                        reviewApprovalStatus = allStatus.reviewApprovalStatus || {};

                        // Render ulang tabel notisi untuk menampilkan data baru
                        const selectedAuditor = (currentUserRole === 'Anggota') ? loggedInUser.nama : document.getElementById('anggota-selector-notisi').value;
                        renderNoticeTable(selectedAuditor, currentUserRole);
                    }

                } catch (error) {
                    // Jangan hentikan polling jika hanya error jaringan, mungkin akan pulih
                    console.error("Error saat mengambil data polling:", error);
                }
            }, 15000); // Lakukan polling setiap 15 detik
        }

function renderDashboard() {
    // 1. Filter data berdasarkan pilihan dropdown
    const selectedSatker = dashboardFilterSatker.value;
    const selectedTahap = dashboardFilterTahap.value;

    let filteredAudits = allAuditsData;
    if (selectedSatker !== 'semua') {
        filteredAudits = filteredAudits.filter(audit => audit.dataUmum.satuan_kerja === selectedSatker);
    }

    // 2. Proses dan agregasi data yang sudah difilter
    const processedData = filteredAudits.map(audit => {
        const hasil = { perencanaan: 0, pelaksanaan: 0, evaluasi: 0, pencapaian: 0 };
        const bobot = { 
            perencanaan: parseFloat(audit.dataUmum.bobot_perencanaan) || 0,
            pelaksanaan: parseFloat(audit.dataUmum.bobot_pelaksanaan) || 0,
            evaluasi: parseFloat(audit.dataUmum.bobot_evaluasi) || 0,
            pencapaian: parseFloat(audit.dataUmum.bobot_pencapaian) || 0
        };

        // PERBAIKAN DIMULAI DI SINI
        // Mengganti logika untuk menggunakan variabel global 'fullMasterKKA' yang sudah dimuat
        for (const subKka in audit.temuanAudit) {
            const finding = audit.temuanAudit[subKka];
            // Menggunakan daftar KKA master yang lengkap untuk mencari detail tugas
            const task = fullMasterKKA.find(k => k['Sub KKA'] === subKka);
            
            if (finding && task && finding.hasil_skor) {
                const hasilSkor = parseFloat(String(finding.hasil_skor).replace(',', '.')) || 0;
                if (task.Tahap === 'Tahap Perencanaan') hasil.perencanaan += hasilSkor;
                else if (task.Tahap === 'Tahap Pelaksanaan') hasil.pelaksanaan += hasilSkor;
                else if (task.Tahap === 'Tahap Evaluasi & Pelaporan') hasil.evaluasi += hasilSkor;
                else if (task.Tahap === 'Tahap Pencapaian Hasil/Outcome') hasil.pencapaian += hasilSkor;
            }
        }
        // PERBAIKAN SELESAI
        
        const totalHasil = hasil.perencanaan + hasil.pelaksanaan + hasil.evaluasi + hasil.pencapaian;
        
        let totalAnggaran = 0, totalTemuan = 0, totalTindakLanjut = 0;
        for (const subKka in audit.temuanAudit) {
            const f = audit.temuanAudit[subKka];
            totalAnggaran += parseNumber(f.anggaran_diaudit);
            totalTemuan += parseNumber(f.temuan_keuangan);
            totalTindakLanjut += parseNumber(f.tindak_lanjut);
        }

        return {
            satker: audit.dataUmum.nama_satuan_kerja || audit.dataUmum.satuan_kerja,
            hasil: hasil,
            bobot: bobot,
            totalHasil: totalHasil,
            kategori: getCategoryForScore(Math.round(totalHasil)),
            keuangan: {
                anggaran: totalAnggaran,
                temuan: totalTemuan,
                tindakLanjut: totalTindakLanjut,
                saldo: totalTemuan - totalTindakLanjut
            }
        };
    });

    // 3. Update Scorecards & Rekapitulasi dengan filter tahap
    updateScorecards(processedData, selectedTahap);
    updateDashboardRekapitulasi(processedData, selectedTahap);

    // 4. Update Charts
    updateCharts(processedData);

    // 5. Update Tables
    updateTables(processedData);
}

function updateScorecards(data, selectedTahap) {
    if (data.length === 0) {
        scorecardTotal.textContent = '-';
        scorecardPerencanaan.textContent = '-';
        scorecardPelaksanaan.textContent = '-';
        scorecardEvaluasi.textContent = '-';
        scorecardPencapaian.textContent = '-';
        return;
    }

    // Hitung total rata-rata berdasarkan filter tahap
    const totalAvg = data.reduce((sum, item) => {
        let itemTotal = 0;
        if (selectedTahap === 'semua') {
            itemTotal = item.totalHasil;
        } else if (selectedTahap === 'Tahap Perencanaan') {
            itemTotal = item.hasil.perencanaan;
        } else if (selectedTahap === 'Tahap Pelaksanaan') {
            itemTotal = item.hasil.pelaksanaan;
        } else if (selectedTahap === 'Tahap Evaluasi & Pelaporan') {
            itemTotal = item.hasil.evaluasi;
        } else if (selectedTahap === 'Tahap Pencapaian Hasil/Outcome') {
            itemTotal = item.hasil.pencapaian;
        }
        return sum + itemTotal;
    }, 0) / data.length;

    scorecardTotal.textContent = Math.round(totalAvg) || 0;
    
    // Hitung rata-rata per tahap (selalu dibutuhkan)
    const calcTahapHasilAvg = (tahap) => {
        const totalHasilTahap = data.reduce((sum, item) => sum + item.hasil[tahap], 0);
        return data.length > 0 ? totalHasilTahap / data.length : 0;
    };

    // Tampilkan skor per tahap berdasarkan filter
    scorecardPerencanaan.textContent = (selectedTahap === 'semua' || selectedTahap === 'Tahap Perencanaan') ? calcTahapHasilAvg('perencanaan').toFixed(2) : '-';
    scorecardPelaksanaan.textContent = (selectedTahap === 'semua' || selectedTahap === 'Tahap Pelaksanaan') ? calcTahapHasilAvg('pelaksanaan').toFixed(2) : '-';
    scorecardEvaluasi.textContent = (selectedTahap === 'semua' || selectedTahap === 'Tahap Evaluasi & Pelaporan') ? calcTahapHasilAvg('evaluasi').toFixed(2) : '-';
    scorecardPencapaian.textContent = (selectedTahap === 'semua' || selectedTahap === 'Tahap Pencapaian Hasil/Outcome') ? calcTahapHasilAvg('pencapaian').toFixed(2) : '-';
}

function updateCharts(data) {
    const ctxKinerja = document.getElementById('chart-kinerja-satker').getContext('2d');
    const ctxTemuan = document.getElementById('chart-temuan-keuangan').getContext('2d');
    const ctxCapaian = document.getElementById('chart-capaian-tahap').getContext('2d');

    // Chart 1: Kinerja per Satker
    if (chartKinerjaSatker) chartKinerjaSatker.destroy();
    chartKinerjaSatker = new Chart(ctxKinerja, {
        type: 'bar',
        data: {
            labels: data.map(d => d.satker),
            datasets: [{
                label: 'Skor Kinerja Total',
                data: data.map(d => Math.round(d.totalHasil)),
                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                borderColor: 'rgba(59, 130, 246, 1)',
                borderWidth: 1
            }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true, max: 100 } } }
    });

    // Chart 2: Temuan Keuangan
    const temuanData = data.filter(d => d.keuangan.temuan > 0);
    if (chartTemuanKeuangan) chartTemuanKeuangan.destroy();
    chartTemuanKeuangan = new Chart(ctxTemuan, {
        type: 'doughnut',
        data: {
            labels: temuanData.map(d => d.satker),
            datasets: [{
                data: temuanData.map(d => d.keuangan.temuan),
                backgroundColor: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#6366F1'],
            }]
        },
        options: { responsive: true }
    });
    
    // Chart 3: Capaian per Tahap
    const avgCapaian = {
        perencanaan: data.length > 0 ? data.reduce((sum, d) => sum + (d.bobot.perencanaan > 0 ? d.hasil.perencanaan / d.bobot.perencanaan : 0), 0) / data.length * 100 : 0,
        pelaksanaan: data.length > 0 ? data.reduce((sum, d) => sum + (d.bobot.pelaksanaan > 0 ? d.hasil.pelaksanaan / d.bobot.pelaksanaan : 0), 0) / data.length * 100 : 0,
        evaluasi: data.length > 0 ? data.reduce((sum, d) => sum + (d.bobot.evaluasi > 0 ? d.hasil.evaluasi / d.bobot.evaluasi : 0), 0) / data.length * 100 : 0,
        pencapaian: data.length > 0 ? data.reduce((sum, d) => sum + (d.bobot.pencapaian > 0 ? d.hasil.pencapaian / d.bobot.pencapaian : 0), 0) / data.length * 100 : 0,
    };
    if (chartCapaianTahap) chartCapaianTahap.destroy();
    chartCapaianTahap = new Chart(ctxCapaian, {
        type: 'polarArea',
        data: {
            labels: ['Perencanaan', 'Pelaksanaan', 'Evaluasi', 'Pencapaian'],
            datasets: [{
                data: [avgCapaian.perencanaan, avgCapaian.pelaksanaan, avgCapaian.evaluasi, avgCapaian.pencapaian],
                backgroundColor: ['rgba(59, 130, 246, 0.5)', 'rgba(16, 185, 129, 0.5)', 'rgba(245, 158, 11, 0.5)', 'rgba(239, 68, 68, 0.5)'],
            }]
        },
        options: { responsive: true }
    });
}

function updateTables(data) {
    tableKinerjaBody.innerHTML = '';
    data.forEach(d => {
        tableKinerjaBody.innerHTML += `
            <tr>
                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${d.satker}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${d.hasil.perencanaan.toFixed(2)}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${d.hasil.pelaksanaan.toFixed(2)}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${d.hasil.evaluasi.toFixed(2)}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${d.hasil.pencapaian.toFixed(2)}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 text-center font-bold">${Math.round(d.totalHasil)}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${d.kategori}</td>
            </tr>
        `;
    });

    tableKeuanganBody.innerHTML = '';
    data.forEach(d => {
        tableKeuanganBody.innerHTML += `
            <tr>
                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${d.satker}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 text-right">Rp ${formatNumber(d.keuangan.anggaran)}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 text-right">Rp ${formatNumber(d.keuangan.temuan)}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 text-right">Rp ${formatNumber(d.keuangan.tindakLanjut)}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 text-right font-bold">Rp ${formatNumber(d.keuangan.saldo)}</td>
            </tr>
        `;
    });
}

function updateDashboardRekapitulasi(data, selectedTahap) {
    const perencanaanEl = document.getElementById('rekap-avg-hasil-perencanaan');
    const pelaksanaanEl = document.getElementById('rekap-avg-hasil-pelaksanaan');
    const evaluasiEl = document.getElementById('rekap-avg-hasil-evaluasi');
    const pencapaianEl = document.getElementById('rekap-avg-hasil-pencapaian');
    const totalEl = document.getElementById('rekap-avg-hasil-total');
    const skorEl = document.getElementById('skor-kinerja-avg');
    const kategoriContainer = document.getElementById('kategori-container-avg');
    const kategoriText = document.getElementById('kategori-kinerja-avg');

    if (data.length === 0) {
        perencanaanEl.textContent = '0,00';
        pelaksanaanEl.textContent = '0,00';
        evaluasiEl.textContent = '0,00';
        pencapaianEl.textContent = '0,00';
        totalEl.textContent = '0,00';
        skorEl.textContent = '0';
        kategoriText.textContent = '-';
        kategoriContainer.className = 'w-1/2 p-4 border border-gray-300 rounded-lg flex items-center justify-center bg-gray-100';
        kategoriText.className = 'text-4xl font-bold text-gray-500';
        return;
    }

    const totalHasil = data.reduce((acc, curr) => {
        acc.perencanaan += curr.hasil.perencanaan;
        acc.pelaksanaan += curr.hasil.pelaksanaan;
        acc.evaluasi += curr.hasil.evaluasi;
        acc.pencapaian += curr.hasil.pencapaian;
        return acc;
    }, { perencanaan: 0, pelaksanaan: 0, evaluasi: 0, pencapaian: 0 });

    const avgHasil = {
        perencanaan: totalHasil.perencanaan / data.length,
        pelaksanaan: totalHasil.pelaksanaan / data.length,
        evaluasi: totalHasil.evaluasi / data.length,
        pencapaian: totalHasil.pencapaian / data.length,
    };

    let totalAvg = 0;
    let maxScore = 100; // Bobot maksimal untuk penentuan kategori

    if (selectedTahap === 'semua') {
        totalAvg = avgHasil.perencanaan + avgHasil.pelaksanaan + avgHasil.evaluasi + avgHasil.pencapaian;
        perencanaanEl.textContent = avgHasil.perencanaan.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        pelaksanaanEl.textContent = avgHasil.pelaksanaan.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        evaluasiEl.textContent = avgHasil.evaluasi.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        pencapaianEl.textContent = avgHasil.pencapaian.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    } else {
        perencanaanEl.textContent = (selectedTahap === 'Tahap Perencanaan') ? avgHasil.perencanaan.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0,00';
        pelaksanaanEl.textContent = (selectedTahap === 'Tahap Pelaksanaan') ? avgHasil.pelaksanaan.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0,00';
        evaluasiEl.textContent = (selectedTahap === 'Tahap Evaluasi & Pelaporan') ? avgHasil.evaluasi.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0,00';
        pencapaianEl.textContent = (selectedTahap === 'Tahap Pencapaian Hasil/Outcome') ? avgHasil.pencapaian.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0,00';

        if (selectedTahap === 'Tahap Perencanaan') { totalAvg = avgHasil.perencanaan; maxScore = 15; }
        else if (selectedTahap === 'Tahap Pelaksanaan') { totalAvg = avgHasil.pelaksanaan; maxScore = 65; }
        else if (selectedTahap === 'Tahap Evaluasi & Pelaporan') { totalAvg = avgHasil.evaluasi; maxScore = 10; }
        else if (selectedTahap === 'Tahap Pencapaian Hasil/Outcome') { totalAvg = avgHasil.pencapaian; maxScore = 10; }
    }
    
    const skorKinerjaAvg = Math.round(totalAvg);
    const percentageScore = (totalAvg / maxScore) * 100;

    totalEl.textContent = totalAvg.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    skorEl.textContent = skorKinerjaAvg;

    // Logika untuk menentukan kategori dan warna
    kategoriContainer.className = 'w-1/2 p-4 border rounded-lg flex items-center justify-center';
    kategoriText.className = 'text-4xl font-bold';
    let kategori = 'BURUK';
    if (percentageScore > 90) {
        kategori = 'SANGAT BAIK';
        kategoriContainer.classList.add('bg-green-100', 'border-green-400');
        kategoriText.classList.add('text-green-700');
    } else if (percentageScore > 75) {
        kategori = 'BAIK';
        kategoriContainer.classList.add('bg-blue-100', 'border-blue-400');
        kategoriText.classList.add('text-blue-700');
    } else if (percentageScore > 60) {
        kategori = 'CUKUP BAIK';
        kategoriContainer.classList.add('bg-yellow-100', 'border-yellow-400');
        kategoriText.classList.add('text-yellow-700');
    } else if (percentageScore > 50) {
        kategori = 'KURANG BAIK';
        kategoriContainer.classList.add('bg-orange-100', 'border-orange-400');
        kategoriText.classList.add('text-orange-700');
    } else {
        kategoriContainer.classList.add('bg-red-100', 'border-red-400');
        kategoriText.classList.add('text-red-700');
    }
    kategoriText.textContent = kategori;
}

async function handleAiSummaryGeneration() {
    aiSummaryTextarea.value = '';
    aiSummarySpinner.classList.remove('hidden');
    btnGenerateSummary.disabled = true;

    // 1. Ambil dan validasi tanggal dari input baru
    const startDateString = document.getElementById('report-start-date').value;
    const endDateString = document.getElementById('report-end-date').value;

    if (!startDateString || !endDateString) {
        alert("Harap tentukan tanggal mulai dan tanggal selesai untuk laporan.");
        aiSummarySpinner.classList.add('hidden');
        btnGenerateSummary.disabled = false;
        return;
    }

    const startDate = new Date(startDateString);
    const endDate = new Date(endDateString);
    endDate.setHours(23, 59, 59, 999); // Agar inklusif sampai akhir hari

    // 2. Filter data audit global berdasarkan rentang tanggal
    const dateFilteredAudits = allAuditsData.filter(audit => {
        const auditDateString = audit.dataUmum.waktu_audit_selesai;
        if (!auditDateString) return false;
        const auditDate = new Date(auditDateString);
        return auditDate >= startDate && auditDate <= endDate;
    });

    if (dateFilteredAudits.length === 0) {
        aiSummaryTextarea.value = `Tidak ditemukan data audit dalam rentang tanggal ${startDate.toLocaleDateString('id-ID')} hingga ${endDate.toLocaleDateString('id-ID')}.`;
        aiSummarySpinner.classList.add('hidden');
        btnGenerateSummary.disabled = false;
        return;
    }

    // 3. Proses data yang sudah difilter untuk dikirim ke AI
    const kinerjaData = dateFilteredAudits.map(audit => {
        let totalHasil = 0;
        for (const subKka in audit.temuanAudit) {
            const finding = audit.temuanAudit[subKka];
            if (finding && finding.hasil_skor) {
                totalHasil += parseFloat(String(finding.hasil_skor).replace(',', '.')) || 0;
            }
        }
        const skorBulat = Math.round(totalHasil);
        return {
            satker: audit.dataUmum.nama_satuan_kerja || audit.dataUmum.satuan_kerja,
            skor_total: skorBulat,
            kategori: getCategoryForScore(skorBulat)
        };
    });

    const keuanganData = dateFilteredAudits.map(audit => {
        let totalTemuan = 0, totalSaldo = 0;
        for (const subKka in audit.temuanAudit) {
            const f = audit.temuanAudit[subKka];
            const temuan = parseNumber(f.temuan_keuangan);
            const tindakLanjut = parseNumber(f.tindak_lanjut);
            totalTemuan += temuan;
            totalSaldo += (temuan - tindakLanjut);
        }
        return {
            satker: audit.dataUmum.nama_satuan_kerja || audit.dataUmum.satuan_kerja,
            temuan: `Rp ${formatNumber(totalTemuan)}`,
            saldo: `Rp ${formatNumber(totalSaldo)}`
        };
    });

    const avgCapaianData = {
        perencanaan: scorecardPerencanaan.textContent,
        pelaksanaan: scorecardPelaksanaan.textContent,
        evaluasi: scorecardEvaluasi.textContent,
        pencapaian: scorecardPencapaian.textContent
    };

    // 4. Prompt AI yang diperbarui dengan konteks tanggal
    const prompt = `
        Anda adalah seorang Inspektur Jenderal yang bertugas menyusun Laporan Hasil Audit Kinerja Konsolidasi untuk periode **${startDate.toLocaleDateString('id-ID', {day: '2-digit', month: 'long', year: 'numeric'})} hingga ${endDate.toLocaleDateString('id-ID', {day: '2-digit', month: 'long', year: 'numeric'})}**. Berdasarkan data terfilter berikut, buatlah laporan yang komprehensif, padat, dan jelas dalam format Markdown.

        **Data Kinerja (Periode Laporan):**
        ${JSON.stringify(kinerjaData, null, 2)}

        **Data Keuangan (Periode Laporan):**
        ${JSON.stringify(keuanganData, null, 2)}

        **Data Rata-rata Nilai Hasil per Tahap (Sebagai Pembanding Umum):**
        ${JSON.stringify(avgCapaianData, null, 2)}

        Struktur laporan HARUS mengikuti kerangka berikut dengan menggunakan heading Markdown:

        ### **1. Ringkasan Eksekutif**
        - Sebutkan periode laporan.
        - Sebutkan skor kinerja rata-rata dan kategori kinerja yang paling dominan untuk audit dalam periode ini.
        - Soroti kekuatan dan kelemahan sistemik berdasarkan data rata-rata nilai hasil per tahap.
        - Sebutkan total saldo temuan keuangan dari seluruh satker dalam periode ini.
        - Berikan 1-2 rekomendasi kunci yang paling mendesak berdasarkan temuan periode ini.

        ### **2. Analisis Kinerja Keseluruhan (Periode Laporan)**
        - Identifikasi satker dengan kinerja tertinggi (best practice) dan terendah (area for improvement) dari data kinerja periode ini.
        - Berikan komentar singkat mengenai sebaran kinerja antar satker dalam periode ini.

        ### **3. Identifikasi Area Kunci (Key Findings) (Periode Laporan)**
        - **Analisis Tematik:** Berdasarkan data yang ada, apakah ada pola kinerja yang muncul pada periode ini?
        - **Analisis Keuangan:** Identifikasi satker dengan saldo temuan keuangan terbesar pada periode ini dan berikan komentar mengenai risiko yang mungkin timbul.

        ### **4. Rekomendasi Strategis (Periode Laporan)**
        - Berikan 2-3 rekomendasi strategis yang dapat ditindaklanjuti untuk mengatasi temuan pada periode ini.
        - Sarankan adopsi praktik terbaik dari satker berkinerja tinggi pada periode ini.
        - Berikan rekomendasi terkait percepatan penyelesaian temuan keuangan yang teridentifikasi pada periode ini.
    `;

    try {
        const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
        const apiKey = "AIzaSyBp2bF8al-3Wg9Tk-n93Nr91i87ttMzJEc"; // Dikosongkan sesuai instruksi
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const result = await response.json();
        
        if (result.candidates && result.candidates[0].content.parts[0].text) {
            aiSummaryTextarea.value = result.candidates[0].content.parts[0].text;
        } else {
            throw new Error("Respons AI tidak valid.");
        }
    } catch (error) {
        console.error("AI Summary Error:", error);
        aiSummaryTextarea.value = "Gagal menghasilkan laporan. Terjadi kesalahan saat menghubungi layanan AI.";
    } finally {
        aiSummarySpinner.classList.add('hidden');
        btnGenerateSummary.disabled = false;
    }
}
        // --- EVENT LISTENERS TAMBAHAN ---
        formTimAudit.addEventListener('submit', handleTeamFormSubmit);
        tabelPembagianTugasBody.addEventListener('change', (event) => {
            if (event.target.classList.contains('auditor-assign-select') || event.target.classList.contains('dinilai-select')) {
                handleAssignmentChange(event);
            }
        });
        
        anggotaSelector.addEventListener('change', (e) => {
            renderWorksheetTable(e.target.value, true);
        });
        
        anggotaSelectorNotisi.addEventListener('change', (e) => {
            renderNoticeTable(e.target.value, currentUserRole);
        });

        modalBody.addEventListener('input', handleReviewChange); 
        modalBody.addEventListener('click', handleReviewActions);
        document.querySelectorAll('.stage-weight-input').forEach(input => {
            input.addEventListener('change', recalculateAndRenderBobot);
        });
        saveProgressBtn.addEventListener('click', handleSaveProgress);
        finishAuditBtn.addEventListener('click', handleFinishAudit);
        editAuditBtn.addEventListener('click', handleEditAudit);
        closeModalBtn.addEventListener('click', () => modal.style.display = 'none');
        closeModalFooterBtn.addEventListener('click', () => modal.style.display = 'none');
        window.addEventListener('click', (event) => {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        });
        btnOpenPrintSelection.addEventListener('click', openPrintSelectionModal);
        closePrintSelectionModalBtn.addEventListener('click', () => printSelectionModal.style.display = 'none');
        btnGeneratePrintPreview.addEventListener('click', handlePrintSelection);
        closePrintPreviewModalBtn.addEventListener('click', () => printPreviewModal.style.display = 'none');
        btnExportWord.addEventListener('click', exportToWord);
        btnExportPdf.addEventListener('click', exportToPdf);

        const searchInput = document.getElementById('nama_auditor_search');
        const hiddenNameInput = document.getElementById('nama_auditor');
        const nipInput = document.getElementById('nip_auditor');
        const userListDiv = document.getElementById('nama_auditor_list');

        searchInput.addEventListener('focus', () => {
            renderUserDropdown(allUsers);
            userListDiv.classList.remove('hidden');
        });

        searchInput.addEventListener('input', () => {
            const query = searchInput.value.toLowerCase();
            if (query === '') {
                hiddenNameInput.value = '';
                nipInput.value = '';
                nipInput.readOnly = false;
            }
            const filteredUsers = allUsers.filter(user => user.nama.toLowerCase().includes(query));
            renderUserDropdown(filteredUsers);
            userListDiv.classList.remove('hidden');
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.searchable-dropdown')) {
                userListDiv.classList.add('hidden');
            }
        });
        
        function renderUserDropdown(users) {
            userListDiv.innerHTML = '';
            if (users.length === 0) {
                userListDiv.innerHTML = `<div class="searchable-dropdown-item text-gray-500">Tidak ditemukan</div>`;
                return;
            }
            users.forEach(user => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'searchable-dropdown-item';
                itemDiv.textContent = `${user.nama} (${user.nip})`;
                
                itemDiv.addEventListener('mousedown', () => {
                    searchInput.value = user.nama;
                    hiddenNameInput.value = user.nama;
                    nipInput.value = user.nip;
                    nipInput.readOnly = true;
                    userListDiv.classList.add('hidden');
                    handleDataChange();
                });
                userListDiv.appendChild(itemDiv);
            });
        }

        formTimAudit.addEventListener('reset', () => {
            setTimeout(() => { 
                searchInput.value = '';
                hiddenNameInput.value = '';
                nipInput.readOnly = false;
            }, 0);
        });
// Tambahkan ini di akhir blok <script> Anda
dashboardFilterSatker.addEventListener('change', renderDashboard);
dashboardFilterTahap.addEventListener('change', renderDashboard);
btnGenerateSummary.addEventListener('click', handleAiSummaryGeneration);
    </script>

...
    <!-- Sisa dari konten aplikasi Anda -->

    <script>
        // Script utama aplikasi Anda yang sudah ada
        ...
    </script>

    <!-- Notifikasi Update untuk index.html -->
    <div id="notification" class="modal" style="display: none; z-index: 2000;">
        ... (seluruh isi div notifikasi) ...
    </div>

    <script>
        // Tambahkan script ini di bagian bawah file index.html Anda, sebelum tag </body> penutup
        const notification = document.getElementById('notification');
        ... (seluruh isi script notifikasi) ...
    </script>

</body>
</html>

</body>
</html>
...im...
