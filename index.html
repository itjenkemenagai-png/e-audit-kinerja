
    }

        function openPrintSelectionModal() {
            // Tentukan status persetujuan final berdasarkan keberadaan Pengendali Teknis
            const hasPengendaliTeknis = auditTeam.some(m => m.role === 'Pengendali Teknis');
            const finalStatus = hasPengendaliTeknis ? 'disetujui_teknis' : 'disetujui_ketua';

            // Saring semua KKA untuk mendapatkan Notisi yang sudah disetujui
            let approvedKKA = kkaData.filter(kka => {
                const finding = auditFindings[kka['Sub KKA']];
                const score = finding ? parseFloat(String(finding.nilai_skor).replace(',', '.')) : null;
                // Notisi adalah KKA yang disetujui DAN memiliki temuan (skor < 1)
                return reviewApprovalStatus[kka['Sub KKA']] === finalStatus && score !== null && score < 1;
            });

            // Jika pengguna adalah Anggota, saring lagi hanya untuk tugasnya
            if (currentUserRole === 'Anggota') {
                approvedKKA = approvedKKA.filter(kka => (taskAssignments[kka['Sub KKA']] || '').trim() === (loggedInUser.nama || '').trim());
            }
            
            // Definisikan urutan tahap yang benar
            const tahapOrder = ['Tahap Perencanaan', 'Tahap Pelaksanaan', 'Tahap Evaluasi & Pelaporan', 'Tahap Pencapaian Hasil/Outcome'];
            
            // Urutkan Notisi berdasarkan urutan tahap
            approvedKKA.sort((a, b) => tahapOrder.indexOf(a.Tahap) - tahapOrder.indexOf(b.Tahap));

            // Kelompokkan Notisi berdasarkan Tahap
            const groupedByTahap = approvedKKA.reduce((acc, kka) => {
                const tahap = kka['Tahap'];
                if(!acc[tahap]) acc[tahap] = [];
                acc[tahap].push(kka);
                return acc;
            }, {});

            let contentHtml = '<p class="text-sm text-gray-600 mb-4">Pilih satu atau lebih Notisi dari tahap yang sama untuk diekspor.</p>';
            if (approvedKKA.length === 0) {
                contentHtml = '<p>Tidak ada Notisi yang telah disetujui untuk diekspor.</p>';
            }

            // Tampilkan Notisi yang sudah dikelompokkan
            tahapOrder.forEach(tahap => {
                if (groupedByTahap[tahap]) {
                    contentHtml += `<div class="mb-4"><h4 class="font-bold text-lg mb-2 border-b">${tahap}</h4>`;
                    groupedByTahap[tahap].forEach(kka => {
                        contentHtml += `
                            <div class="flex items-center">
                                <input type="checkbox" id="kka-${kka['Sub KKA']}" name="kka_selection" value="${kka['Sub KKA']}" data-tahap="${tahap}" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 kka-checkbox">
                                <label for="kka-${kka['Sub KKA']}" class="ml-2 block text-sm text-gray-900">${kka['Kode KKA']} (${kka['Sub KKA']}) - ${kka['Indikator Kinerja Aspek Penilaian Audit']}</label>
                            </div>
                        `;
                    });
                    contentHtml += `</div>`;
                }
            });
            
            printSelectionBody.innerHTML = contentHtml;
            printSelectionModal.style.display = 'flex';

            // Tambahkan logika untuk hanya mengizinkan pemilihan dari tahap yang sama
            document.querySelectorAll('.kka-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const selectedCheckboxes = document.querySelectorAll('.kka-checkbox:checked');
                    
                    if (selectedCheckboxes.length > 0) {
                        const selectedTahap = selectedCheckboxes[0].dataset.tahap;
                        document.querySelectorAll('.kka-checkbox').forEach(otherCheckbox => {
                            if (otherCheckbox.dataset.tahap !== selectedTahap) {
                                otherCheckbox.disabled = true;
                                otherCheckbox.parentElement.classList.add('opacity-50');
                            }
                        });
                    } else {
                        // Jika tidak ada yang dipilih, aktifkan kembali semua
                        document.querySelectorAll('.kka-checkbox').forEach(otherCheckbox => {
                            otherCheckbox.disabled = false;
                            otherCheckbox.parentElement.classList.remove('opacity-50');
                        });
                    }
                });
            });
        }

        function handlePrintSelection() {
            const selectedCheckboxes = document.querySelectorAll('.kka-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                alert('Pilih minimal satu KKA untuk dicetak.');
                return;
            }

            const selectedSubKKAs = Array.from(selectedCheckboxes).map(cb => cb.value);
            const selectedKKAs = kkaData.filter(kka => selectedSubKKAs.includes(kka['Sub KKA']));
            
            const anggota = auditTeam.find(m => m.name === taskAssignments[selectedKKAs[0]['Sub KKA']]);
            const ketuaTim = auditTeam.find(m => m.role === 'Ketua Tim');
            const pengendaliTeknis = auditTeam.find(m => m.role === 'Pengendali Teknis');

            const firstKKA = selectedKKAs[0];
            
            // Gabungkan data dari semua KKA yang dipilih
            const indikatorList = selectedKKAs.map(k => `${k['Indikator Kinerja Aspek Penilaian Audit']} (${k['Sub KKA']})`).join(', ');
            const aggregatedData = {
                tahap: firstKKA['Tahap'],
                fungsi: firstKKA['Fungsi/Tugas (PMA Pasal)'],
                indikator: indikatorList,
                nilaiHasil: selectedKKAs.map(k => auditFindings[k['Sub KKA']]?.hasil_skor || '0').reduce((sum, val) => sum + parseFloat(String(val).replace(',','.')), 0).toFixed(3).replace('.',','),
                nilaiBobot: selectedKKAs.map(k => k['Bobot Aspek Penilaian']).reduce((sum, val) => sum + parseFloat(val), 0).toFixed(3).replace('.',','),
                halPositif: selectedKKAs.map(k => auditFindings[k['Sub KKA']]?.kondisi_positif || '').filter(Boolean).join('<br>'),
                aspekBelumMaksimal: selectedKKAs.map(k => auditFindings[k['Sub KKA']]?.kondisi_negatif || '').filter(Boolean).join('<br>'),
                tidakSesuai: selectedKKAs.map(k => auditFindings[k['Sub KKA']]?.kriteria || '').filter(Boolean).join('<br>'),
                mengakibatkan: selectedKKAs.map(k => auditFindings[k['Sub KKA']]?.akibat || '').filter(Boolean).join('<br>'),
                disebabkan: selectedKKAs.map(k => auditFindings[k['Sub KKA']]?.sebab || '').filter(Boolean).join('<br>'),
                rekomendasi: selectedKKAs.map(k => auditFindings[k['Sub KKA']]?.rekomendasi || '').filter(Boolean).join('<br>'),
            };

            const previewHTML = `
                <div class="text-center mb-4">
                    <h4 class="font-bold">Inspektorat Jenderal Kementerian Agama RI</h4>
                    <h5 class="font-bold underline">NOTISI HASIL AUDIT</h5>
                </div>
                <table class="w-full text-sm mb-4 border-collapse">
                    <tr>
                        <td class="border p-1 w-1/4">Nama Satker</td>
                        <td class="border p-1">: ${document.getElementById('satuan_kerja').value}</td>
                        <td class="border p-1 w-1/4">Disusun oleh</td>
                        <td class="border p-1">: ${anggota ? anggota.name : '................'}</td>
                    </tr>
                    <tr>
                        <td class="border p-1">Sasaran Audit</td>
                        <td class="border p-1">: ${document.getElementById('nama_audit').value}</td>
                        <td class="border p-1">Tanggal/Paraf</td>
                        <td class="border p-1">: ................. /</td>
                    </tr>
                    <tr>
                        <td class="border p-1">Periode Audit</td>
                        <td class="border p-1">: ${document.getElementById('periode_audit_mulai').value} s.d ${document.getElementById('periode_audit_selesai').value}</td>
                        <td class="border p-1">Direviu oleh</td>
                        <td class="border p-1">: ${ketuaTim ? ketuaTim.name : '................'}</td>
                    </tr>
                    <tr>
                        <td class="border p-1">Tahap</td>
                        <td class="border p-1">: ${aggregatedData.tahap}</td>
                        <td class="border p-1">Tanggal/Paraf</td>
                        <td class="border p-1">: /</td>
                    </tr>
                    <tr>
                        <td class="border p-1">Fungsi</td>
                        <td class="border p-1">: ${aggregatedData.fungsi}</td>
                        <td class="border p-1">Disetujui oleh</td>
                        <td class="border p-1">: ${pengendaliTeknis ? pengendaliTeknis.name : (ketuaTim ? ketuaTim.name : '................')}</td>
                    </tr>
                    <tr>
                        <td class="border p-1">Unit Kerja</td>
                        <td class="border p-1">: ${document.getElementById('unit_kerja').value}</td>
                        <td class="border p-1">Tanggal/Paraf</td>
                        <td class="border p-1">: /</td>
                    </tr>
                </table>
                <div class="text-sm space-y-2 text-justify">
                    <p class="font-bold text-center">TAHAP ${aggregatedData.tahap.toUpperCase().replace('TAHAP ', '')}</p>
                    <p>Berdasarkan hasil pengujian dokumen, wawancara, dan konfirmasi dengan pihak terkait, pelaksanaan kerja tahap ${aggregatedData.tahap.toLowerCase()} pada indikator ${aggregatedData.indikator}, dihasilkan hal-hal sebagai berikut:</p>
                    <p>Capaian kinerja ${aggregatedData.tahap.toLowerCase()} pada indikator ${aggregatedData.indikator} memperoleh nilai capaian ${aggregatedData.nilaiHasil} dari nilai maksimal ${aggregatedData.nilaiBobot}</p>
                    <p class="font-bold">Hal Positif</p>
                    <div class="pl-4">${aggregatedData.halPositif}</div>
                    <p class="font-bold">Terdapat aspek yang belum maksimal, yaitu:</p>
                    <div class="pl-4">${aggregatedData.aspekBelumMaksimal}</div>
                    <p class="font-bold">Kondisi tersebut tidak sesuai dengan:</p>
                    <div class="pl-4">${aggregatedData.tidakSesuai}</div>
                    <p class="font-bold">Hal tersebut mengakibatkan:</p>
                    <div class="pl-4">${aggregatedData.mengakibatkan}</div>
                    <p class="font-bold">Keadaan tersebut disebabkan oleh:</p>
                    <div class="pl-4">${aggregatedData.disebabkan}</div>
                    <p class="font-bold">Inspektorat Jenderal merekomendasikan kepada Kepala ${document.getElementById('unit_kerja').value} agar melakukan perbaikan dengan langkah-langkah sebagai berikut:</p>
                    <div class="pl-4">${aggregatedData.rekomendasi}</div>
                    <p class="font-bold mt-4">Tanggapan Auditi: (Berkop surat Satker)</p>
                </div>
            `;

            printPreviewContent.innerHTML = previewHTML;
            printSelectionModal.style.display = 'none';
            printPreviewModal.style.display = 'flex';
        }

        function exportToWord() {
            const content = document.getElementById('print-preview-content').innerHTML;
            const converted = htmlDocx.asBlob(content, {orientation: 'portrait'});
            const url = URL.createObjectURL(converted);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'notisi_audit.docx';
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportToPdf() {
            const { jsPDF } = window.jspdf;
            const content = document.getElementById('print-preview-content');
            
            html2canvas(content, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const canvasWidth = canvas.width;
                const canvasHeight = canvas.height;
                const ratio = canvasWidth / canvasHeight;
                const imgWidth = pdfWidth - 20; // with margin
                const imgHeight = imgWidth / ratio;

                let heightLeft = imgHeight;
                let position = 10; // top margin

                pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                heightLeft -= (pdfHeight - 20);

                while (heightLeft > 0) {
                    position = heightLeft - imgHeight + 10; // top margin on new page
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                    heightLeft -= (pdfHeight - 20);
                }
                
                pdf.save('notisi_audit.pdf');
            });
        }
        
        function getCategoryForScore(score) {
            const container = document.getElementById('kategori-container');
            const textEl = document.getElementById('kategori-kinerja');
            
            container.className = 'w-1/2 p-4 border rounded-lg flex items-center justify-center';
            textEl.className = 'text-4xl font-bold';

            if (score > 90) {
                container.classList.add('bg-green-100', 'border-green-400');
                textEl.classList.add('text-green-700');
                return 'SANGAT BAIK';
            }
            if (score > 75) {
                container.classList.add('bg-blue-100', 'border-blue-400');
                textEl.classList.add('text-blue-700');
                return 'BAIK';
            }
            if (score > 60) {
                container.classList.add('bg-yellow-100', 'border-yellow-400');
                textEl.classList.add('text-yellow-700');
                return 'CUKUP BAIK';
            }
            if (score > 50) {
                container.classList.add('bg-orange-100', 'border-orange-400');
                textEl.classList.add('text-orange-700');
                return 'KURANG BAIK';
            }
            container.classList.add('bg-red-100', 'border-red-400');
            textEl.classList.add('text-red-700');
            return 'BURUK';
        }

        function updateRekapitulasi() {
            const stageWeights = {
                perencanaan: parseFloat(document.getElementById('bobot_perencanaan').value) || 0,
                pelaksanaan: parseFloat(document.getElementById('bobot_pelaksanaan').value) || 0,
                evaluasi: parseFloat(document.getElementById('bobot_evaluasi').value) || 0,
                pencapaian: parseFloat(document.getElementById('bobot_pencapaian').value) || 0,
            };

            const hasil = { perencanaan: 0, pelaksanaan: 0, evaluasi: 0, pencapaian: 0 };

        for (const subKka in auditFindings) {
                const finding = auditFindings[subKka];
                const task = kkaData.find(k => k['Sub KKA'] === subKka);
                if (finding && task && finding.hasil_skor) {
                    const hasilSkor = parseFloat(String(finding.hasil_skor).replace(',', '.')) || 0;
                    if (task.Tahap === 'Tahap Perencanaan') hasil.perencanaan += hasilSkor;
                    else if (task.Tahap === 'Tahap Pelaksanaan') hasil.pelaksanaan += hasilSkor;
                    else if (task.Tahap === 'Tahap Evaluasi & Pelaporan') hasil.evaluasi += hasilSkor;
                    else if (task.Tahap === 'Tahap Pencapaian Hasil/Outcome') hasil.pencapaian += hasilSkor;
                }
            }
        // PERBAIKAN SELESAI

            document.getElementById('rekap-bobot-perencanaan').textContent = stageWeights.perencanaan;
            document.getElementById('rekap-bobot-pelaksanaan').textContent = stageWeights.pelaksanaan;
            document.getElementById('rekap-bobot-evaluasi').textContent = stageWeights.evaluasi;
            document.getElementById('rekap-bobot-pencapaian').textContent = stageWeights.pencapaian;
            const totalBobot = stageWeights.perencanaan + stageWeights.pelaksanaan + stageWeights.evaluasi + stageWeights.pencapaian;
            document.getElementById('rekap-bobot-total').textContent = totalBobot;

            document.getElementById('rekap-hasil-perencanaan').textContent = hasil.perencanaan.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('rekap-hasil-pelaksanaan').textContent = hasil.pelaksanaan.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('rekap-hasil-evaluasi').textContent = hasil.evaluasi.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('rekap-hasil-pencapaian').textContent = hasil.pencapaian.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            const totalHasil = hasil.perencanaan + hasil.pelaksanaan + hasil.evaluasi + hasil.pencapaian;
            document.getElementById('rekap-hasil-total').textContent = totalHasil.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            const skorKinerja = Math.round(totalHasil);
            document.getElementById('skor-kinerja').textContent = skorKinerja;
            document.getElementById('kategori-kinerja').textContent = getCategoryForScore(skorKinerja);
        }

        function updateProgresStatistik() {
            const hasPengendaliTeknis = auditTeam.some(m => m.role === 'Pengendali Teknis');
            const finalApprovalStatus = hasPengendaliTeknis ? 'disetujui_teknis' : 'disetujui_ketua';

            const getKKAStatus = (subKka) => {
                const approvalStatus = reviewApprovalStatus[subKka];
                const workStatus = auditStatus[subKka];

                if (approvalStatus === finalApprovalStatus) {
                    return 'Selesai';
                }
                if (workStatus === 'in-progress' || workStatus === 'completed' || (approvalStatus && approvalStatus !== 'belum_direviu')) {
                    return 'Sedang Audit';
                }
                return 'Belum Diaudit';
            };

            // Berdasarkan Tahap
            const tahapStats = {
                'Tahap Perencanaan': { total: 0, belum: 0, sedang: 0, selesai: 0 },
                'Tahap Pelaksanaan': { total: 0, belum: 0, sedang: 0, selesai: 0 },
                'Tahap Evaluasi & Pelaporan': { total: 0, belum: 0, sedang: 0, selesai: 0 },
                'Tahap Pencapaian Hasil/Outcome': { total: 0, belum: 0, sedang: 0, selesai: 0 },
            };

            kkaData.forEach(kka => {
                // HANYA HITUNG JIKA KKA DINILAI (Y)
                if (indicatorStatus[kka['Sub KKA']] === 'Y') {
                    const tahap = kka['Tahap'];
                    if (tahap && tahapStats[tahap]) {
                        tahapStats[tahap].total++;
                        const status = getKKAStatus(kka['Sub KKA']);
                        if (status === 'Selesai') tahapStats[tahap].selesai++;
                        else if (status === 'Sedang Audit') tahapStats[tahap].sedang++;
                        else tahapStats[tahap].belum++;
                    }
                }
            });

            const tahapBody = document.getElementById('tabel-progres-tahap');
            tahapBody.innerHTML = '';
            for (const tahapName in tahapStats) {
                const stats = tahapStats[tahapName];
                tahapBody.innerHTML += `
                    <tr>
                        <td class="px-4 py-2 border border-gray-300 text-left">${tahapName}</td>
                        <td class="px-4 py-2 border border-gray-300">${stats.total}</td>
                        <td class="px-4 py-2 border border-gray-300">${stats.belum}</td>
                        <td class="px-4 py-2 border border-gray-300">${stats.sedang}</td>
                        <td class="px-4 py-2 border border-gray-300">${stats.selesai}</td>
                    </tr>
                `;
            }

            // Berdasarkan Auditor
            const auditorStats = {};
            const assignedAuditors = auditTeam.filter(m => m.role === 'Anggota');

            assignedAuditors.forEach(auditor => {
                auditorStats[auditor.name] = { total: 0, belum: 0, sedang: 0, selesai: 0 };
            });

            for (const subKka in taskAssignments) {
                const auditorName = taskAssignments[subKka];
                if (auditorStats[auditorName]) {
                    auditorStats[auditorName].total++;
                    const status = getKKAStatus(subKka);
                    if (status === 'Selesai') auditorStats[auditorName].selesai++;
                    else if (status === 'Sedang Audit') auditorStats[auditorName].sedang++;
                    else auditorStats[auditorName].belum++;
                }
            }
            
            const auditorBody = document.getElementById('tabel-progres-auditor');
            auditorBody.innerHTML = '';
            for (const auditorName in auditorStats) {
                const stats = auditorStats[auditorName];
                auditorBody.innerHTML += `
                    <tr>
                        <td class="px-4 py-2 border border-gray-300 text-left">${auditorName}</td>
                        <td class="px-4 py-2 border border-gray-300">${stats.total}</td>
                        <td class="px-4 py-2 border border-gray-300">${stats.belum}</td>
                        <td class="px-4 py-2 border border-gray-300">${stats.sedang}</td>
                        <td class="px-4 py-2 border border-gray-300">${stats.selesai}</td>
                    </tr>
                `;
            }
        }

        function getKualitasKinerja3E(score, aspek) {
            let kategori = `Tidak ${aspek}`; // Default
            if (score > 90) kategori = `Sangat ${aspek}`;
            else if (score > 75) kategori = aspek;
            else if (score > 60) kategori = `Cukup ${aspek}`;
            else if (score > 50) kategori = `Kurang ${aspek}`;
            return kategori;
        }


        function update3EScore() {
            const aspek3E = ['Ekonomis', 'Efisien', 'Efektif'];
            const tabelBody = document.getElementById('tabel-skor-3e');
            tabelBody.innerHTML = '';

            aspek3E.forEach(aspek => {
                let totalHasil = 0;
                let totalBobot = 0;

                const filteredKKA = kkaData.filter(kka => kka['3E'] === aspek && indicatorStatus[kka['Sub KKA']] === 'Y');

                filteredKKA.forEach(kka => {
                    totalBobot += parseFloat(kka['Bobot Aspek Penilaian']) || 0;
                    const finding = auditFindings[kka['Sub KKA']];
                    if (finding && finding.hasil_skor) {
                        totalHasil += parseFloat(String(finding.hasil_skor).replace(',', '.')) || 0;
                    }
                });

                const skor = totalBobot > 0 ? (totalHasil / totalBobot) * 100 : 0;
                const kualitas = getKualitasKinerja3E(skor, aspek);

                const row = `
                    <tr>
                        <td class="px-4 py-2 border border-gray-300 text-left font-medium">${aspek}</td>
                        <td class="px-4 py-2 border border-gray-300">${totalHasil.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        <td class="px-4 py-2 border border-gray-300">${totalBobot.toLocaleString('id-ID', { minimumFractionDigits: 3, maximumFractionDigits: 3 })}</td>
                        <td class="px-4 py-2 border border-gray-300 font-bold">${skor.toFixed(2)}</td>
                        <td class="px-4 py-2 border border-gray-300 font-semibold">${kualitas}</td>
                    </tr>
                `;
                tabelBody.innerHTML += row;
            });
        }

        function updateRekapitulasiKeuangan() {
            let totalAnggaran = 0;
            let totalTemuan = 0;
            let totalTindakLanjut = 0;

            for (const subKka in auditFindings) {
                const finding = auditFindings[subKka];
                if (finding) {
                    totalAnggaran += parseNumber(finding.anggaran_diaudit);
                    totalTemuan += parseNumber(finding.temuan_keuangan);
                    totalTindakLanjut += parseNumber(finding.tindak_lanjut);
                }
            }

            const totalSaldo = totalTemuan - totalTindakLanjut;

            document.getElementById('rekap-anggaran-diaudit').textContent = `Rp ${formatNumber(totalAnggaran)}`;
            document.getElementById('rekap-temuan-keuangan').textContent = `Rp ${formatNumber(totalTemuan)}`;
            document.getElementById('rekap-tindak-lanjut').textContent = `Rp ${formatNumber(totalTindakLanjut)}`;
            document.getElementById('rekap-saldo').textContent = `Rp ${formatNumber(totalSaldo)}`;
        }
        
        function exportLhaToWord() {
            const content = document.getElementById('lha-content').innerHTML;
            const converted = htmlDocx.asBlob(content, {orientation: 'portrait'});
            const url = URL.createObjectURL(converted);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'LHA.docx';
            a.click();
            URL.revokeObjectURL(url);
        }

function formatDate(dateString) {
            if (!dateString || isNaN(new Date(dateString))) {
                return '................';
            }
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            const date = new Date(dateString);
            return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
        }

function handleSignOut() {
            if (isDataDirty) {
                // Jika ada perubahan, gunakan modal yang sudah ada
                navigationTarget = { menuId: 'signout', element: null }; // Gunakan target khusus
                document.getElementById('unsaved-changes-modal').style.display = 'flex';
            } else {
                // Jika tidak ada perubahan, langsung reload halaman
                window.location.reload();
            }
        }

        function renderLHA() {
            const lhaContainer = document.getElementById('lha-content');
            lhaContainer.innerHTML = '<p>Membuat laporan...</p>';

            const dataUmum = collectDataUmum();
            const skorKinerja = document.getElementById('skor-kinerja').textContent;
            
            const kualitas3E = {};
            ['Ekonomis', 'Efisien', 'Efektif'].forEach(aspek => {
                let totalHasil = 0;
                let totalBobot = 0;
                const filteredKKA = kkaData.filter(kka => kka['3E'] === aspek && indicatorStatus[kka['Sub KKA']] === 'Y');
                filteredKKA.forEach(kka => {
                    totalBobot += parseFloat(kka['Bobot Aspek Penilaian']) || 0;
                    const finding = auditFindings[kka['Sub KKA']];
                    if (finding && finding.hasil_skor) {
                        totalHasil += parseFloat(String(finding.hasil_skor).replace(',', '.')) || 0;
                    }
                });
                const skor = totalBobot > 0 ? (totalHasil / totalBobot) * 100 : 0;
                kualitas3E[aspek] = getKualitasKinerja3E(skor, aspek);
            });

            const penanggungJawab = auditTeam.find(m => m.role === 'Penanggung Jawab');

            const groupedByTahap = kkaData.reduce((acc, kka) => {
                if(indicatorStatus[kka['Sub KKA']] !== 'Y') return acc;
                const tahap = kka['Tahap'];
                const fungsi = kka['Kode KKA'];
                if (!acc[tahap]) acc[tahap] = {};
                if (!acc[tahap][fungsi]) acc[tahap][fungsi] = [];
                acc[tahap][fungsi].push(kka);
                return acc;
            }, {});

            let rincianHasilAuditHtml = '<table class="lha-table" style="width: 100%; margin-top: 1rem;">';
            rincianHasilAuditHtml += `
                <thead>
                    <tr>
                        <th rowspan="2" style="width: 10%;">Nomor</th>
                        <th rowspan="2">Fungsi/Sub Fungsi</th>
                        <th colspan="2">Bobot Penilaian</th>
                    </tr>
                    <tr>
                        <th style="width: 15%;">Bobot</th>
                        <th style="width: 15%;">Hasil</th>
                    </tr>
                </thead>
                <tbody>
            `;

            const tahapMapping = {
                'Tahap Perencanaan': 'A',
                'Tahap Pelaksanaan': 'B',
                'Tahap Evaluasi & Pelaporan': 'C',
                'Tahap Pencapaian Hasil/Outcome': 'D'
            };

            for (const tahap in groupedByTahap) {
                rincianHasilAuditHtml += `
                    <tr>
                        <td style="font-weight: bold; text-align: center;">${tahapMapping[tahap] || ''}</td>
                        <td style="font-weight: bold; text-align: left;" colspan="3">${tahap}</td>
                    </tr>
                `;

                for (const fungsi in groupedByTahap[tahap]) {
                    const subKkaList = groupedByTahap[tahap][fungsi];
                    const firstSubKka = subKkaList[0]; 

                    let totalBobotFungsi = 0;
                    let totalHasilFungsi = 0;

                    subKkaList.forEach(kka => {
                        totalBobotFungsi += parseFloat(kka['Bobot Aspek Penilaian'] || 0);
                        const finding = auditFindings[kka['Sub KKA']];
                        if (finding && finding.hasil_skor) {
                            totalHasilFungsi += parseFloat(String(finding.hasil_skor).replace(',', '.')) || 0;
                        }
                    });
                    
                    const fungsiText = (firstSubKka['Fungsi/Tugas (PMA Pasal)'] || '').replace(/\(Pasal.*?\)/g, '').trim();

                    rincianHasilAuditHtml += `
                        <tr>
                            <td style="text-align: center;">${fungsi}</td>
                            <td style="text-align: left;">${fungsiText}</td>
                            <td style="text-align: center;">${totalBobotFungsi > 0 ? String(totalBobotFungsi.toFixed(3)).replace('.', ',') : '-'}</td>
                            <td style="text-align: center;">${totalBobotFungsi > 0 ? String(totalHasilFungsi.toFixed(3)).replace('.', ',') : '-'}</td>
                        </tr>
                    `;
                }
            }

            const totalBobotRekap = parseFloat(document.getElementById('rekap-bobot-total').textContent) || 100;
            const totalHasilRekap = parseFloat(document.getElementById('rekap-hasil-total').textContent.replace(',', '.')) || 0;

            rincianHasilAuditHtml += `
                    <tr>
                        <td colspan="2" style="font-weight: bold; text-align: center;">JUMLAH</td>
                        <td style="font-weight: bold; text-align: center;">${totalBobotRekap.toLocaleString('id-ID')}</td>
                        <td style="font-weight: bold; text-align: center;">${totalHasilRekap.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    </tr>
                </tbody>
            </table>
            `;
            
            // --- PERBAIKAN UTAMA: Menambahkan penomoran bertingkat ---
            let faktaAuditHtml = '';
            let tahapCounter = 1;
            for (const tahap in groupedByTahap) {
                const totalBobotTahap = parseFloat(document.getElementById(`rekap-bobot-${tahap.split(' ')[1].toLowerCase()}`).textContent) || 0;
                const totalHasilTahap = parseFloat(document.getElementById(`rekap-hasil-${tahap.split(' ')[1].toLowerCase()}`).textContent.replace(',','.')) || 0;
                
                faktaAuditHtml += `
                    <h4 style="font-weight: bold; margin-top: 1.5rem; text-indent: -1rem; padding-left: 1rem;">${tahapCounter}. ${tahap}</h4>
                    <p>Tahap ${tahap.toLowerCase().replace('tahap ','')} memperoleh nilai capaian kinerja ${totalHasilTahap.toFixed(2)} dari hasil maksimal ${totalBobotTahap.toFixed(2)}.</p>
                    <p>Tahap ${tahap.toLowerCase().replace('tahap ','')} mengukur ${Object.keys(groupedByTahap[tahap]).length} fungsi yaitu:</p>
                `;

                let fungsiCounter = 0;
                for (const fungsi in groupedByTahap[tahap]) {
                    const kkaFungsi = groupedByTahap[tahap][fungsi][0];
                    const fungsiText = (kkaFungsi['Fungsi/Tugas (PMA Pasal)'] || '').replace(/\(Pasal.*?\)/g, '').trim();

                    faktaAuditHtml += `
                        <div style="margin-left: 1rem;">
                            <h5 style="font-weight: bold; margin-top: 1rem; text-indent: -1rem; padding-left: 1rem;">${String.fromCharCode(97 + fungsiCounter)}. Fungsi ${fungsiText} (${fungsi})</h5>
                            <p>Berdasarkan hasil pengujian dokumen, wawancara, dan konfirmasi dengan pihak terkait, pelaksanaan kerja fungsi ${fungsiText} pada ${dataUmum.nama_satuan_kerja}, dapat digambarkan hasilnya sebagai berikut:</p>
                        </div>
                    `;
                    
                    let indikatorCounter = 1;
                    groupedByTahap[tahap][fungsi].forEach(kka => {
                        const finding = auditFindings[kka['Sub KKA']];
                        if (finding && finding.kondisi_negatif) {
                            faktaAuditHtml += `
                                <div style="margin-left: 2rem;">
                                    <p style="margin-top: 1rem; text-indent: -1.5rem; padding-left: 1.5rem;">${indikatorCounter}) ${kka['Indikator Kinerja Aspek Penilaian Audit']} (${kka['Sub KKA']})</p>
                                    <p>${finding.kondisi_negatif || '...'}</p>
                                    <p style="font-weight: bold;">Kondisi tersebut tidak sesuai dengan:</p>
                                    <p>${finding.kriteria || '...'}</p>
                                    <p style="font-weight: bold;">Akibatnya:</p>
                                    <p>${finding.akibat || '...'}</p>
                                    <p style="font-weight: bold;">Kondisi tersebut disebabkan oleh:</p>
                                    <p>${finding.sebab || '...'}</p>
                                </div>
                            `;
                            indikatorCounter++;
                        }
                    });
                    fungsiCounter++;
                }
                tahapCounter++;
            }
            // --- AKHIR PERBAIKAN ---
            
            let rekomendasiHtml = '';
            for (const tahap in groupedByTahap) {
                 rekomendasiHtml += `
                    <h4 style="font-weight: bold; margin-top: 1.5rem;">${tahap}</h4>
                    <p>Terhadap temuan pada tahap ${tahap.toLowerCase().replace('tahap ','')}:</p>
                    <ol style="list-style-type: decimal; padding-left: 2rem;">
                `;
                for (const fungsi in groupedByTahap[tahap]) {
                    groupedByTahap[tahap][fungsi].forEach(kka => {
                         const finding = auditFindings[kka['Sub KKA']];
                         if (finding && finding.rekomendasi) {
                             rekomendasiHtml += `<li>${finding.rekomendasi}</li>`;
                         }
                    });
                }
                rekomendasiHtml += `</ol>`;
            }

            const lhaHtml = `
                <div style="text-align: left; margin-bottom: 2rem;">
                    <p>Nomor : .................... &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ${formatDate(new Date())}</p>
                    <p>Sifat : Rahasia</p>
                    <p>Lampiran : Satu berkas</p>
                    <p>Hal : Laporan Hasil Audit Kinerja Pada ${dataUmum.nama_satuan_kerja || '(Satuan Kerja)'} Tahun Anggaran ${new Date(dataUmum.periode_audit_selesai).getFullYear() || '20xx'}</p>
                </div>
                <div style="margin-bottom: 2rem;">
                    <p>Yth. (Atasan Langsung Satuan Kerja)</p>
                    <p>Kementerian Agama RI</p>
                    <p>Jakarta</p>
                </div>
                <p>Berdasarkan hasil audit kinerja Tim Inspektorat Jenderal Kementerian Agama pada ${dataUmum.nama_satuan_kerja || '........'} Tahun Anggaran ${new Date(dataUmum.periode_audit_selesai).getFullYear() || '20xx'}, sesuai dengan Surat Tugas Inspektur Jenderal Kementerian Agama Nomor: ${dataUmum.no_st || '......'} tanggal ${formatDate(dataUmum.tgl_st)}, dengan ini kami sampaikan pokok-pokok hasil audit.</p>
                
                <h3 style="font-weight: bold; text-align: left; margin-top: 1.5rem;">Simpulan Hasil Audit</h3>
                <p>Nilai capaian kinerja berdasarkan hasil audit kinerja pada ${dataUmum.nama_satuan_kerja || '...'} adalah ${skorKinerja} dengan kualitas kinerja "${kualitas3E['Ekonomis'] || '...'}" dalam pengelolaan keuangan dan BMN, "${kualitas3E['Efisien'] || '...'}" dalam kinerja fungsi perencanaan, pelaksanaan, dan evaluasi pelaporan, serta "${kualitas3E['Efektif'] || '...'}" dalam pencapaian hasil (outcome).</p>
                
                <h3 style="font-weight: bold; text-align: left; margin-top: 1.5rem;">Rekomendasi</h3>
                <p>Dari hasil audit, Inspektorat Jenderal memberikan rekomendasi kepada (Atasan Langsung Satuan Kerja) agar memerintahkan ${dataUmum.jabatan_pimpinan || '(Jabatan Pimpinan)'}, untuk melakukan langkah-langkah perbaikan sesuai dengan uraian rekomendasi yang ada di BAB III.</p>
                
                <div style="page-break-before: always;"></div>

                <h2 style="font-weight: bold; text-align: center;">BAB I<br/>GAMBARAN UMUM</h2>
                
                <h3 style="font-weight: bold; margin-top: 1.5rem;">A. DATA AUDITI</h3>
                <table style="width: 100%; border-collapse: collapse;">
                    <tr><td style="width: 25%; vertical-align: top;">Nama Auditi</td><td style="vertical-align: top;">: ${dataUmum.nama_satuan_kerja || '...'}</td></tr>
                    <tr><td style="vertical-align: top;">Alamat</td><td style="vertical-align: top;">: ${dataUmum.alamat || '...'}</td></tr>
                    <tr><td colspan="2" style="padding-top: 0.5rem;">Pimpinan</td></tr>
                    <tr><td style="padding-left: 1rem; vertical-align: top;">Nama</td><td style="vertical-align: top;">: ${dataUmum.nama_pimpinan || '...'}</td></tr>
                    <tr><td style="padding-left: 1rem; vertical-align: top;">Jabatan</td><td style="vertical-align: top;">: ${dataUmum.jabatan_pimpinan || '...'}</td></tr>
                    <tr><td style="padding-left: 1rem; vertical-align: top;">NIP</td><td style="vertical-align: top;">: ${dataUmum.nip_pimpinan || '...'}</td></tr>
                    <tr><td style="padding-left: 1rem; vertical-align: top;">Pangkat/Golongan</td><td style="vertical-align: top;">: ${dataUmum.pangkat_golongan || '...'}</td></tr>
                </table>

                <h3 style="font-weight: bold; margin-top: 1.5rem;">B. TUJUAN AUDIT</h3>
                <ol style="list-style-type: decimal; padding-left: 2rem; margin: 0;">
                    <li>Menilai aspek kehematan, efisiensi dan efektifitas pengelolaan program kerja dan pelaksanaan tugas dan fungsi satuan kerja.</li>
                    <li>Memberikan Informasi hasil audit kepada pimpinan sebagai pertimbangan untuk mengambil Kebijakan.</li>
                    <li>Memberikan rekomendasi untuk perbaikan kinerja.</li>
                </ol>

                <h3 style="font-weight: bold; margin-top: 1.5rem;">C. RUANG LINGKUP</h3>
                <p>Penilaian terhadap fungsi perencanaan, pelaksanaan, pelaporan dan evaluasi, serta pencapaian hasil terhadap pelaksanaan tugas dan fungsi satuan kerja, namun tidak mencakup (hal-hal yang dikecualikan kalau ada).</p>

                <h3 style="font-weight: bold; margin-top: 1.5rem;">D. WAKTU AUDIT</h3>
                <p>Audit dilaksanakan mulai tanggal ${formatDate(dataUmum.waktu_audit_mulai)} sampai dengan tanggal ${formatDate(dataUmum.waktu_audit_selesai)}.</p>

                <h3 style="font-weight: bold; margin-top: 1.5rem;">E. PERIODE AUDIT</h3>
                <p>Periode yang diaudit meliputi masa sejak ${formatDate(dataUmum.periode_audit_mulai)} sampai ${formatDate(dataUmum.periode_audit_selesai)}.</p>
                
                <h3 style="font-weight: bold; margin-top: 1.5rem;">F. STANDAR AUDIT</h3>
                <p>Audit telah dilaksanakan sesuai dengan standar audit yang diterbitkan oleh Asosiasi Auditor Intern Pemerintah Indonesia (AAIPI).</p>
                
                <h3 style="font-weight: bold; margin-top: 1.5rem;">G. METODE AUDIT</h3>
                <p>Audit kinerja ini dilaksanakan dengan metode dengan metode pengukuran Integrated Performance Measurement System (IPMS) yaitu metode pengukuran kinerja yang terintegrasi untuk mengukur kinerja suatu organisasi yang dilakukan secara top-down dengan memperhatikan kebutuhan dari setiap stakeholder.</p>
                <p style="font-weight: bold;">Penetapan Indikator dan Pembobotan</p>
                <p>Penetapan indikator kinerja atau Key Performance Indicator (KPI) didasarkan atas pelaksanaan tugas dan fungsi pada ${dataUmum.nama_satuan_kerja || '(Nama Satuan Kerja)'}. KPI yang ditetapkan merupakan ukuran kualitatif yang dikuantitatifkan atas pelaksanaan tugas dan fungsi untuk mengukur atau membandingkan kinerja dalam hal memenuhi tujuan strategis dan program. Pembobotan masing-masing kegiatan telah ditetapkan pada KPI untuk setiap satker dengan jumlah ${kkaData.filter(kka => indicatorStatus[kka['Sub KKA']] === 'Y').length || '...'} untuk setiap fungsi pada ${dataUmum.nama_satuan_kerja || '...'}.</p>
                <p>Adapun indikator-indikator keberhasilan pelaksanaan tugas dan fungsi pada ${dataUmum.nama_satuan_kerja || '...'} sebagai berikut:</p>
                <table class="lha-table" style="width: 50%; margin-top: 1rem;">
                    <thead><tr><th>No</th><th>Uraian</th><th>Bobot</th></tr></thead>
                    <tbody>
                        <tr><td style="text-align: center;">1.</td><td>Perencanaan</td><td style="text-align: center;">${dataUmum.bobot_perencanaan || '...'}</td></tr>
                        <tr><td style="text-align: center;">2.</td><td>Pelaksanaan</td><td style="text-align: center;">${dataUmum.bobot_pelaksanaan || '...'}</td></tr>
                        <tr><td style="text-align: center;">3.</td><td>Evaluasi dan Pelaporan</td><td style="text-align: center;">${dataUmum.bobot_evaluasi || '...'}</td></tr>
                        <tr><td style="text-align: center;">4.</td><td>Pengukuran Pencapaian Sasaran/Outcome</td><td style="text-align: center;">${dataUmum.bobot_pencapaian || '...'}</td></tr>
                        <tr><td colspan="2" style="font-weight: bold; text-align: center;">TOTAL</td><td style="font-weight: bold; text-align: center;">100</td></tr>
                    </tbody>
                </table>
                <p style="margin-top: 1rem; font-weight: bold;">Tanggapan audit</p>
                <p>Pihak auditi telah menanggapi dan mengakui hasil audit yang dilakukan oleh tim audit Inspektorat Jenderal Kementerian Agama.</p>
                
                <h3 style="font-weight: bold; margin-top: 1.5rem;">H. INFORMASI UMUM</h3>
                <p>Struktur organisasi</p>
                <p>Kekuatan Sumber Daya</p>

                <h3 style="font-weight: bold; margin-top: 1.5rem;">I. REALISASI KEUANGAN</h3>
                <p>Pagu anggaran ${dataUmum.nama_satuan_kerja || '(satuan kerja)'} Tahun ... sebesar Rp... dengan realisasi sebesar Rp... (...%). Tahun ... pagu anggaran sebesar Rp... realisasi sebesar Rp... (...%)</p>
                <p style="margin-top: 1rem; text-align: center; font-weight: bold;">Realisasi Anggaran Tahun ...</p>
                <table class="lha-table" style="width: 100%; margin-top: 1rem; text-align: center;">
                    <thead><tr><th>Jenis Belanja</th><th>Anggaran</th><th>Realisasi</th><th>%</th><th>Sisa</th></tr></thead>
                    <tbody>
                        <tr><td>Belanja Pegawai</td><td>...</td><td>...</td><td>...</td><td>...</td></tr>
                        <tr><td>Belanja Barang</td><td>...</td><td>...</td><td>...</td><td>...</td></tr>
                        <tr><td>Belanja Modal</td><td>...</td><td>...</td><td>...</td><td>...</td></tr>
                        <tr><td>Bantuan Sosial</td><td>...</td><td>...</td><td>...</td><td>...</td></tr>
                        <tr><td style="font-weight: bold;">Jumlah</td><td style="font-weight: bold;">...</td><td style="font-weight: bold;">...</td><td style="font-weight: bold;">...</td><td style="font-weight: bold;">...</td></tr>
                    </tbody>
                </table>

                <div style="page-break-before: always;"></div>
                
                <h2 style="font-weight: bold; text-align: center;">BAB II<br/>URAIAN HASIL AUDIT</h2>
                <h3 style="font-weight: bold;">A. SIMPULAN HASIL AUDIT</h3>
                <p>Nilai capaian kinerja berdasarkan hasil audit kinerja pada ${dataUmum.nama_satuan_kerja} adalah ${skorKinerja} dengan kualitas kinerja ${kualitas3E['Ekonomis']} dalam pengelolaan keuangan dan BMN, ${kualitas3E['Efisien']} dalam kinerja fungsi perencanaan, pelaksanaan, dan evaluasi pelaporan, serta ${kualitas3E['Efektif']} dalam pencapaian hasil (outcome), dengan nilai rinci sebagai berikut:</p>
                ${rincianHasilAuditHtml}
                <h3 style="font-weight: bold; margin-top: 1.5rem;">B. FAKTA AUDIT</h3>
                ${faktaAuditHtml}

                <div style="page-break-before: always;"></div>

                <h2 style="font-weight: bold; text-align: center;">BAB III<br/>REKOMENDASI</h2>
                <p>Dari hasil audit yang telah diuraikan, Inspektorat Jenderal memberikan rekomendasi kepada (Atasan Langsung Satuan Kerja) agar memerintahkan ${dataUmum.jabatan_pimpinan || '(Jabatan Pimpinan)'}, untuk melakukan langkah-langkah perbaikan sebagai berikut:</p>
                ${rekomendasiHtml}

                <div style="page-break-before: always;"></div>

                <h2 style="font-weight: bold; text-align: center;">BAB IV<br/>PENUTUP</h2>
                <p>Demikian laporan hasil audit (LHA) ini kami sampaikan untuk ditindaklanjuti selambat-lambatnya dalam waktu 60 (enam puluh) hari sejak diterima, dan hasilnya disampaikan kepada Inspektur Jenderal Kementerian Agama. Atas perhatian dan kerja sama Saudara, kami sampaikan terimakasih.</p>
                <div style="margin-top: 3rem; text-align: center; margin-left: 50%;">
                    <p>a.n Inspektur Jenderal</p>
                    <p>Inspektur ....</p>
                    <br/><br/><br/>
                    <p>(${penanggungJawab ? penanggungJawab.name : '.......................'})</p>
                </div>
            `;
            lhaContainer.innerHTML = lhaHtml;
        }
        // Sisipkan semua fungsi baru ini di dalam tag <script>

        async function fetchAllAuditsDataAndRenderDashboard() {
            showLoading("Mengambil semua data audit...");
            try {
                // --- PERBAIKAN UTAMA: Mengambil SEMUA data via POST untuk mengatasi CORS ---

                // Langkah 1: Ambil Master KKA terlebih dahulu via POST
                const kkaPayload = { action: 'getAllMasterKKA' };
                const kkaResponse = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(kkaPayload),
                    redirect: 'follow'
                });
                if (!kkaResponse.ok) throw new Error(`HTTP error! Gagal mengambil KKA Master: ${kkaResponse.status}`);
                const kkaResult = await kkaResponse.json();
                if (kkaResult.error) throw new Error(kkaResult.error);
                fullMasterKKA = kkaResult.masterKKA || [];

                // Langkah 2: Ambil semua data audit via POST
                const auditsPayload = { action: 'getAllAuditsData' };
                const auditsResponse = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(auditsPayload),
                    redirect: 'follow'
                });

                if (!auditsResponse.ok) throw new Error(`HTTP error! Gagal mengambil data audit: ${auditsResponse.status}`);
                const data = await auditsResponse.json();
                if (data.error) throw new Error(data.error);
                
                allAuditsData = data.allAudits; // Simpan data di state global

                // Isi filter Satker sekali saja, sekarang dengan data yang valid
                const uniqueSatkers = [...new Set(allAuditsData.map(audit => audit.dataUmum.nama_satuan_kerja || audit.dataUmum.satuan_kerja).filter(Boolean))];
                dashboardFilterSatker.innerHTML = '<option value="semua">Semua Satker</option>';
                uniqueSatkers.sort().forEach(satker => {
                    dashboardFilterSatker.innerHTML += `<option value="${satker}">${satker}</option>`;
                });
                
                // Aktifkan filter
                dashboardFilterSatker.disabled = false;
                dashboardFilterTahap.disabled = false;

                renderDashboard(); // Render dashboard untuk pertama kali
            } catch (error) {
                console.error("Gagal mengambil semua data audit:", error);
                alert("Gagal mengambil data untuk dashboard. Coba lagi.");
            } finally {
                hideLoading();
            }
        }

function stopPollingForUpdates() {
            if (pollingIntervalId) {
                clearInterval(pollingIntervalId);
                pollingIntervalId = null;
            }
        }

        function startPollingForUpdates() {
            // Hentikan polling yang mungkin sudah berjalan sebelum memulai yang baru
            stopPollingForUpdates();

            const nomorST = document.getElementById('no_st').value;
            if (!nomorST) return; // Jangan lakukan polling jika tidak ada audit yang dimuat

            pollingIntervalId = setInterval(async () => {
                try {
                    // Meminta pembaruan status yang ringan dari server
                    const response = await fetch(`${GAS_URL}?action=getAuditStatusUpdates&nomor_st=${encodeURIComponent(nomorST)}`);
                    if (!response.ok) return; // Gagal secara diam-diam jika ada masalah jaringan

                    const data = await response.json();
                    if (data.error) {
                        console.error("Kesalahan saat polling:", data.error);
                        stopPollingForUpdates(); // Hentikan jika ada error dari server
                        return;
                    }
                    
                    // Bandingkan data baru dengan data lama untuk melihat apakah ada perubahan
                    const hasChanges = JSON.stringify(data.statusAudit.reviewNotes) !== JSON.stringify(reviewNotes) ||
                                     JSON.stringify(data.statusAudit.reviewApprovalStatus) !== JSON.stringify(reviewApprovalStatus);

                    if (hasChanges) {
                        // Jika ada perubahan, perbarui state global di browser
                        const allStatus = data.statusAudit || {};
                        reviewNotes = allStatus.reviewNotes || {};
                        reviewState = allStatus.reviewState || {};
                        reviewApprovalStatus = allStatus.reviewApprovalStatus || {};

                        // Render ulang tabel notisi untuk menampilkan data baru
                        const selectedAuditor = (currentUserRole === 'Anggota') ? loggedInUser.nama : document.getElementById('anggota-selector-notisi').value;
                        renderNoticeTable(selectedAuditor, currentUserRole);
                    }

                } catch (error) {
                    // Jangan hentikan polling jika hanya error jaringan, mungkin akan pulih
                    console.error("Error saat mengambil data polling:", error);
                }
            }, 15000); // Lakukan polling setiap 15 detik
        }

function renderDashboard() {
            // 1. Filter data berdasarkan pilihan dropdown
            const selectedSatker = dashboardFilterSatker.value;
            const selectedTahap = dashboardFilterTahap.value;

            let filteredAudits = allAuditsData;
            if (selectedSatker !== 'semua') {
                // MODIFIKASI: Menggunakan nama_satuan_kerja untuk filter yang lebih andal
                filteredAudits = filteredAudits.filter(audit => (audit.dataUmum.nama_satuan_kerja || audit.dataUmum.satuan_kerja) === selectedSatker);
            }

            // 2. Proses dan agregasi data yang sudah difilter
            const processedData = filteredAudits.map(audit => {
                const hasil = { perencanaan: 0, pelaksanaan: 0, evaluasi: 0, pencapaian: 0 };
                const bobot = { 
                    perencanaan: parseFloat(audit.dataUmum.bobot_perencanaan) || 0,
                    pelaksanaan: parseFloat(audit.dataUmum.bobot_pelaksanaan) || 0,
                    evaluasi: parseFloat(audit.dataUmum.bobot_evaluasi) || 0,
                    pencapaian: parseFloat(audit.dataUmum.bobot_pencapaian) || 0
                };

                // --- PERBAIKAN UTAMA DIMULAI DI SINI ---
                // Logika sekarang menggunakan `fullMasterKKA` global yang sudah di-fetch sebelumnya.
                if (fullMasterKKA && Array.isArray(fullMasterKKA)) {
                    for (const subKka in audit.temuanAudit) {
                        const finding = audit.temuanAudit[subKka];
                        // Menggunakan master KKA global untuk mencari data KKA yang relevan
                        const task = fullMasterKKA.find(k => k['Sub KKA'] === subKka);
                        
                        if (finding && task && finding.hasil_skor) {
                            const hasilSkor = parseFloat(String(finding.hasil_skor).replace(',', '.')) || 0;
                            if (task.Tahap === 'Tahap Perencanaan') hasil.perencanaan += hasilSkor;
                            else if (task.Tahap === 'Tahap Pelaksanaan') hasil.pelaksanaan += hasilSkor;
                            else if (task.Tahap === 'Tahap Evaluasi & Pelaporan') hasil.evaluasi += hasilSkor;
                            else if (task.Tahap === 'Tahap Pencapaian Hasil/Outcome') hasil.pencapaian += hasilSkor;
                        }
                    }
                }
                // --- AKHIR PERBAIKAN ---
                
                const totalHasil = hasil.perencanaan + hasil.pelaksanaan + hasil.evaluasi + hasil.pencapaian;
                
                let totalAnggaran = 0, totalTemuan = 0, totalTindakLanjut = 0;
                for (const subKka in audit.temuanAudit) {
                    const f = audit.temuanAudit[subKka];
                    totalAnggaran += parseNumber(f.anggaran_diaudit);
                    totalTemuan += parseNumber(f.temuan_keuangan);
                    totalTindakLanjut += parseNumber(f.tindak_lanjut);
                }

                return {
                    satker: audit.dataUmum.nama_satuan_kerja || audit.dataUmum.satuan_kerja,
                    hasil: hasil,
                    bobot: bobot,
                    totalHasil: totalHasil,
                    kategori: getCategoryForScore(Math.round(totalHasil)),
                    keuangan: {
                        anggaran: totalAnggaran,
                        temuan: totalTemuan,
                        tindakLanjut: totalTindakLanjut,
                        saldo: totalTemuan - totalTindakLanjut
                    }
                };
            });

            // 3. Update Scorecards & Rekapitulasi dengan filter tahap
            updateScorecards(processedData, selectedTahap);
            updateDashboardRekapitulasi(processedData, selectedTahap);

            // 4. Update Charts
            updateCharts(processedData);

            // 5. Update Tables
            updateTables(processedData);
        }

function updateScorecards(data, selectedTahap) {
    if (data.length === 0) {
        scorecardTotal.textContent = '-';
        scorecardPerencanaan.textContent = '-';
        scorecardPelaksanaan.textContent = '-';
        scorecardEvaluasi.textContent = '-';
        scorecardPencapaian.textContent = '-';
        return;
    }

    // Hitung total rata-rata berdasarkan filter tahap
    const totalAvg = data.reduce((sum, item) => {
        let itemTotal = 0;
        if (selectedTahap === 'semua') {
            itemTotal = item.totalHasil;
        } else if (selectedTahap === 'Tahap Perencanaan') {
            itemTotal = item.hasil.perencanaan;
        } else if (selectedTahap === 'Tahap Pelaksanaan') {
            itemTotal = item.hasil.pelaksanaan;
        } else if (selectedTahap === 'Tahap Evaluasi & Pelaporan') {
            itemTotal = item.hasil.evaluasi;
        } else if (selectedTahap === 'Tahap Pencapaian Hasil/Outcome') {
            itemTotal = item.hasil.pencapaian;
        }
        return sum + itemTotal;
    }, 0) / data.length;

    scorecardTotal.textContent = Math.round(totalAvg) || 0;
    
    // Hitung rata-rata per tahap (selalu dibutuhkan)
    const calcTahapHasilAvg = (tahap) => {
        const totalHasilTahap = data.reduce((sum, item) => sum + item.hasil[tahap], 0);
        return data.length > 0 ? totalHasilTahap / data.length : 0;
    };

    // Tampilkan skor per tahap berdasarkan filter
    scorecardPerencanaan.textContent = (selectedTahap === 'semua' || selectedTahap === 'Tahap Perencanaan') ? calcTahapHasilAvg('perencanaan').toFixed(2) : '-';
    scorecardPelaksanaan.textContent = (selectedTahap === 'semua' || selectedTahap === 'Tahap Pelaksanaan') ? calcTahapHasilAvg('pelaksanaan').toFixed(2) : '-';
    scorecardEvaluasi.textContent = (selectedTahap === 'semua' || selectedTahap === 'Tahap Evaluasi & Pelaporan') ? calcTahapHasilAvg('evaluasi').toFixed(2) : '-';
    scorecardPencapaian.textContent = (selectedTahap === 'semua' || selectedTahap === 'Tahap Pencapaian Hasil/Outcome') ? calcTahapHasilAvg('pencapaian').toFixed(2) : '-';
}

function updateCharts(data) {
    const ctxKinerja = document.getElementById('chart-kinerja-satker').getContext('2d');
    const ctxTemuan = document.getElementById('chart-temuan-keuangan').getContext('2d');
    const ctxCapaian = document.getElementById('chart-capaian-tahap').getContext('2d');

    // Chart 1: Kinerja per Satker
    if (chartKinerjaSatker) chartKinerjaSatker.destroy();
    chartKinerjaSatker = new Chart(ctxKinerja, {
        type: 'bar',
        data: {
            labels: data.map(d => d.satker),
            datasets: [{
                label: 'Skor Kinerja Total',
                data: data.map(d => Math.round(d.totalHasil)),
                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                borderColor: 'rgba(59, 130, 246, 1)',
                borderWidth: 1
            }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true, max: 100 } } }
    });

    // Chart 2: Temuan Keuangan
    const temuanData = data.filter(d => d.keuangan.temuan > 0);
    if (chartTemuanKeuangan) chartTemuanKeuangan.destroy();
    chartTemuanKeuangan = new Chart(ctxTemuan, {
        type: 'doughnut',
        data: {
            labels: temuanData.map(d => d.satker),
            datasets: [{
                data: temuanData.map(d => d.keuangan.temuan),
                backgroundColor: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#6366F1'],
            }]
        },
        options: { responsive: true }
    });
    
    // Chart 3: Capaian per Tahap
    const avgCapaian = {
        perencanaan: data.length > 0 ? data.reduce((sum, d) => sum + (d.bobot.perencanaan > 0 ? d.hasil.perencanaan / d.bobot.perencanaan : 0), 0) / data.length * 100 : 0,
        pelaksanaan: data.length > 0 ? data.reduce((sum, d) => sum + (d.bobot.pelaksanaan > 0 ? d.hasil.pelaksanaan / d.bobot.pelaksanaan : 0), 0) / data.length * 100 : 0,
        evaluasi: data.length > 0 ? data.reduce((sum, d) => sum + (d.bobot.evaluasi > 0 ? d.hasil.evaluasi / d.bobot.evaluasi : 0), 0) / data.length * 100 : 0,
        pencapaian: data.length > 0 ? data.reduce((sum, d) => sum + (d.bobot.pencapaian > 0 ? d.hasil.pencapaian / d.bobot.pencapaian : 0), 0) / data.length * 100 : 0,
    };
    if (chartCapaianTahap) chartCapaianTahap.destroy();
    chartCapaianTahap = new Chart(ctxCapaian, {
        type: 'polarArea',
        data: {
            labels: ['Perencanaan', 'Pelaksanaan', 'Evaluasi', 'Pencapaian'],
            datasets: [{
                data: [avgCapaian.perencanaan, avgCapaian.pelaksanaan, avgCapaian.evaluasi, avgCapaian.pencapaian],
                backgroundColor: ['rgba(59, 130, 246, 0.5)', 'rgba(16, 185, 129, 0.5)', 'rgba(245, 158, 11, 0.5)', 'rgba(239, 68, 68, 0.5)'],
            }]
        },
        options: { responsive: true }
    });
}

function updateTables(data) {
    tableKinerjaBody.innerHTML = '';
    data.forEach(d => {
        tableKinerjaBody.innerHTML += `
            <tr>
                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${d.satker}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${d.hasil.perencanaan.toFixed(2)}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${d.hasil.pelaksanaan.toFixed(2)}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${d.hasil.evaluasi.toFixed(2)}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${d.hasil.pencapaian.toFixed(2)}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 text-center font-bold">${Math.round(d.totalHasil)}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${d.kategori}</td>
            </tr>
        `;
    });

    tableKeuanganBody.innerHTML = '';
    data.forEach(d => {
        tableKeuanganBody.innerHTML += `
            <tr>
                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${d.satker}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 text-right">Rp ${formatNumber(d.keuangan.anggaran)}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 text-right">Rp ${formatNumber(d.keuangan.temuan)}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 text-right">Rp ${formatNumber(d.keuangan.tindakLanjut)}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 text-right font-bold">Rp ${formatNumber(d.keuangan.saldo)}</td>
            </tr>
        `;
    });
}

function updateDashboardRekapitulasi(data, selectedTahap) {
    const perencanaanEl = document.getElementById('rekap-avg-hasil-perencanaan');
    const pelaksanaanEl = document.getElementById('rekap-avg-hasil-pelaksanaan');
    const evaluasiEl = document.getElementById('rekap-avg-hasil-evaluasi');
    const pencapaianEl = document.getElementById('rekap-avg-hasil-pencapaian');
    const totalEl = document.getElementById('rekap-avg-hasil-total');
    const skorEl = document.getElementById('skor-kinerja-avg');
    const kategoriContainer = document.getElementById('kategori-container-avg');
    const kategoriText = document.getElementById('kategori-kinerja-avg');

    if (data.length === 0) {
        perencanaanEl.textContent = '0,00';
        pelaksanaanEl.textContent = '0,00';
        evaluasiEl.textContent = '0,00';
        pencapaianEl.textContent = '0,00';
        totalEl.textContent = '0,00';
        skorEl.textContent = '0';
        kategoriText.textContent = '-';
        kategoriContainer.className = 'w-1/2 p-4 border border-gray-300 rounded-lg flex items-center justify-center bg-gray-100';
        kategoriText.className = 'text-4xl font-bold text-gray-500';
        return;
    }

    const totalHasil = data.reduce((acc, curr) => {
        acc.perencanaan += curr.hasil.perencanaan;
        acc.pelaksanaan += curr.hasil.pelaksanaan;
        acc.evaluasi += curr.hasil.evaluasi;
        acc.pencapaian += curr.hasil.pencapaian;
        return acc;
    }, { perencanaan: 0, pelaksanaan: 0, evaluasi: 0, pencapaian: 0 });

    const avgHasil = {
        perencanaan: totalHasil.perencanaan / data.length,
        pelaksanaan: totalHasil.pelaksanaan / data.length,
        evaluasi: totalHasil.evaluasi / data.length,
        pencapaian: totalHasil.pencapaian / data.length,
    };

    let totalAvg = 0;
    let maxScore = 100; // Bobot maksimal untuk penentuan kategori

    if (selectedTahap === 'semua') {
        totalAvg = avgHasil.perencanaan + avgHasil.pelaksanaan + avgHasil.evaluasi + avgHasil.pencapaian;
        perencanaanEl.textContent = avgHasil.perencanaan.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        pelaksanaanEl.textContent = avgHasil.pelaksanaan.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        evaluasiEl.textContent = avgHasil.evaluasi.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        pencapaianEl.textContent = avgHasil.pencapaian.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    } else {
        perencanaanEl.textContent = (selectedTahap === 'Tahap Perencanaan') ? avgHasil.perencanaan.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0,00';
        pelaksanaanEl.textContent = (selectedTahap === 'Tahap Pelaksanaan') ? avgHasil.pelaksanaan.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0,00';
        evaluasiEl.textContent = (selectedTahap === 'Tahap Evaluasi & Pelaporan') ? avgHasil.evaluasi.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0,00';
        pencapaianEl.textContent = (selectedTahap === 'Tahap Pencapaian Hasil/Outcome') ? avgHasil.pencapaian.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0,00';

        if (selectedTahap === 'Tahap Perencanaan') { totalAvg = avgHasil.perencanaan; maxScore = 15; }
        else if (selectedTahap === 'Tahap Pelaksanaan') { totalAvg = avgHasil.pelaksanaan; maxScore = 65; }
        else if (selectedTahap === 'Tahap Evaluasi & Pelaporan') { totalAvg = avgHasil.evaluasi; maxScore = 10; }
        else if (selectedTahap === 'Tahap Pencapaian Hasil/Outcome') { totalAvg = avgHasil.pencapaian; maxScore = 10; }
    }
    
    const skorKinerjaAvg = Math.round(totalAvg);
    const percentageScore = (totalAvg / maxScore) * 100;

    totalEl.textContent = totalAvg.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    skorEl.textContent = skorKinerjaAvg;

    // Logika untuk menentukan kategori dan warna
    kategoriContainer.className = 'w-1/2 p-4 border rounded-lg flex items-center justify-center';
    kategoriText.className = 'text-4xl font-bold';
    let kategori = 'BURUK';
    if (percentageScore > 90) {
        kategori = 'SANGAT BAIK';
        kategoriContainer.classList.add('bg-green-100', 'border-green-400');
        kategoriText.classList.add('text-green-700');
    } else if (percentageScore > 75) {
        kategori = 'BAIK';
        kategoriContainer.classList.add('bg-blue-100', 'border-blue-400');
        kategoriText.classList.add('text-blue-700');
    } else if (percentageScore > 60) {
        kategori = 'CUKUP BAIK';
        kategoriContainer.classList.add('bg-yellow-100', 'border-yellow-400');
        kategoriText.classList.add('text-yellow-700');
    } else if (percentageScore > 50) {
        kategori = 'KURANG BAIK';
        kategoriContainer.classList.add('bg-orange-100', 'border-orange-400');
        kategoriText.classList.add('text-orange-700');
    } else {
        kategoriContainer.classList.add('bg-red-100', 'border-red-400');
        kategoriText.classList.add('text-red-700');
    }
    kategoriText.textContent = kategori;
}

async function handleAiSummaryGeneration() {
    aiSummaryTextarea.value = '';
    aiSummarySpinner.classList.remove('hidden');
    btnGenerateSummary.disabled = true;

    // 1. Ambil dan validasi tanggal dari input baru
    const startDateString = document.getElementById('report-start-date').value;
    const endDateString = document.getElementById('report-end-date').value;

    if (!startDateString || !endDateString) {
        alert("Harap tentukan tanggal mulai dan tanggal selesai untuk laporan.");
        aiSummarySpinner.classList.add('hidden');
        btnGenerateSummary.disabled = false;
        return;
    }

    const startDate = new Date(startDateString);
    const endDate = new Date(endDateString);
    endDate.setHours(23, 59, 59, 999); // Agar inklusif sampai akhir hari

    // 2. Filter data audit global berdasarkan rentang tanggal
    const dateFilteredAudits = allAuditsData.filter(audit => {
        const auditDateString = audit.dataUmum.waktu_audit_selesai;
        if (!auditDateString) return false;
        const auditDate = new Date(auditDateString);
        return auditDate >= startDate && auditDate <= endDate;
    });

    if (dateFilteredAudits.length === 0) {
        aiSummaryTextarea.value = `Tidak ditemukan data audit dalam rentang tanggal ${startDate.toLocaleDateString('id-ID')} hingga ${endDate.toLocaleDateString('id-ID')}.`;
        aiSummarySpinner.classList.add('hidden');
        btnGenerateSummary.disabled = false;
        return;
    }

    // 3. Proses data yang sudah difilter untuk dikirim ke AI
    const kinerjaData = dateFilteredAudits.map(audit => {
        let totalHasil = 0;
        for (const subKka in audit.temuanAudit) {
            const finding = audit.temuanAudit[subKka];
            if (finding && finding.hasil_skor) {
                totalHasil += parseFloat(String(finding.hasil_skor).replace(',', '.')) || 0;
            }
        }
        const skorBulat = Math.round(totalHasil);
        return {
            satker: audit.dataUmum.nama_satuan_kerja || audit.dataUmum.satuan_kerja,
            skor_total: skorBulat,
            kategori: getCategoryForScore(skorBulat)
        };
    });

    const keuanganData = dateFilteredAudits.map(audit => {
        let totalTemuan = 0, totalSaldo = 0;
        for (const subKka in audit.temuanAudit) {
            const f = audit.temuanAudit[subKka];
            const temuan = parseNumber(f.temuan_keuangan);
            const tindakLanjut = parseNumber(f.tindak_lanjut);
            totalTemuan += temuan;
            totalSaldo += (temuan - tindakLanjut);
        }
        return {
            satker: audit.dataUmum.nama_satuan_kerja || audit.dataUmum.satuan_kerja,
            temuan: `Rp ${formatNumber(totalTemuan)}`,
            saldo: `Rp ${formatNumber(totalSaldo)}`
        };
    });

    const avgCapaianData = {
        perencanaan: scorecardPerencanaan.textContent,
        pelaksanaan: scorecardPelaksanaan.textContent,
        evaluasi: scorecardEvaluasi.textContent,
        pencapaian: scorecardPencapaian.textContent
    };

    // 4. Prompt AI yang diperbarui dengan konteks tanggal
    const prompt = `
        Anda adalah seorang Auditor Muda pada inspektorat jenderal kementerian agama yang bertugas menyusun Laporan Hasil Audit Kinerja Konsolidasi untuk periode **${startDate.toLocaleDateString('id-ID', {day: '2-digit', month: 'long', year: 'numeric'})} hingga ${endDate.toLocaleDateString('id-ID', {day: '2-digit', month: 'long', year: 'numeric'})}**. Berdasarkan data terfilter berikut, buatlah laporan yang komprehensif, padat, dan jelas dalam format Markdown.

        **Data Kinerja (Periode Laporan):**
        ${JSON.stringify(kinerjaData, null, 2)}

        **Data Keuangan (Periode Laporan):**
        ${JSON.stringify(keuanganData, null, 2)}

        **Data Rata-rata Nilai Hasil per Tahap (Sebagai Pembanding Umum):**
        ${JSON.stringify(avgCapaianData, null, 2)}

        Struktur laporan HARUS mengikuti kerangka berikut dengan menggunakan heading Markdown:

        ### **1. Ringkasan Eksekutif**
        - Sebutkan periode laporan.
        - Sebutkan skor kinerja rata-rata dan kategori kinerja yang paling dominan untuk audit dalam periode ini.
        - Soroti kekuatan dan kelemahan sistemik berdasarkan data rata-rata nilai hasil per tahap.
        - Sebutkan total saldo temuan keuangan dari seluruh satker dalam periode ini.
        - Berikan 1-2 rekomendasi kunci yang paling mendesak berdasarkan temuan periode ini.

        ### **2. Analisis Kinerja Keseluruhan (Periode Laporan)**
        - Identifikasi satker dengan kinerja tertinggi (best practice) dan terendah (area for improvement) dari data kinerja periode ini.
        - Berikan komentar singkat mengenai sebaran kinerja antar satker dalam periode ini.

        ### **3. Identifikasi Area Kunci (Key Findings) (Periode Laporan)**
        - **Analisis Tematik:** Berdasarkan data yang ada, apakah ada pola kinerja yang muncul pada periode ini?
        - **Analisis Keuangan:** Identifikasi satker dengan saldo temuan keuangan terbesar pada periode ini dan berikan komentar mengenai risiko yang mungkin timbul.

        ### **4. Rekomendasi Strategis (Periode Laporan)**
        - Berikan 2-3 rekomendasi strategis yang dapat ditindaklanjuti untuk mengatasi temuan pada periode ini.
        - Sarankan adopsi praktik terbaik dari satker berkinerja tinggi pada periode ini.
        - Berikan rekomendasi terkait percepatan penyelesaian temuan keuangan yang teridentifikasi pada periode ini.
    `;

    try {
        const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
        const apiKey = "AIzaSyBp2bF8al-3Wg9Tk-n93Nr91i87ttMzJEc"; // Dikosongkan sesuai instruksi
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const result = await response.json();
        
        if (result.candidates && result.candidates[0].content.parts[0].text) {
            aiSummaryTextarea.value = result.candidates[0].content.parts[0].text;
        } else {
            throw new Error("Respons AI tidak valid.");
        }
    } catch (error) {
        console.error("AI Summary Error:", error);
        aiSummaryTextarea.value = "Gagal menghasilkan laporan. Terjadi kesalahan saat menghubungi layanan AI.";
    } finally {
        aiSummarySpinner.classList.add('hidden');
        btnGenerateSummary.disabled = false;
    }
}
        // --- EVENT LISTENERS TAMBAHAN ---
        formTimAudit.addEventListener('submit', handleTeamFormSubmit);
        tabelPembagianTugasBody.addEventListener('change', (event) => {
            if (event.target.classList.contains('auditor-assign-select') || event.target.classList.contains('dinilai-select')) {
                handleAssignmentChange(event);
            }
        });
        
        // --- PERBAIKAN DI SINI: Menambahkan }); yang hilang ---
        anggotaSelector.addEventListener('change', (e) => {
            renderWorksheetTable(e.target.value, true);
        });
        
        anggotaSelectorNotisi.addEventListener('change', (e) => {
            renderNoticeTable(e.target.value, currentUserRole);
        });

        document.querySelectorAll('.stage-weight-input').forEach(input => {
            input.addEventListener('change', recalculateAndRenderBobot);
        });
        saveProgressBtn.addEventListener('click', handleSaveProgress);
        finishAuditBtn.addEventListener('click', handleFinishAudit);
        
        // --- FUNGSI BARU DITAMBAHKAN DI SINI ---
        function handleEditAudit() {
            const subKkaCode = modal.dataset.currentSubKka;
            if (!subKkaCode) return;

            // Set status kembali ke in-progress agar bisa diedit
            auditStatus[subKkaCode] = 'in-progress';
            
            // Panggil updateModalState untuk menerapkan status baru dan membuka kunci input
            updateModalState(subKkaCode, false, 'Anggota', 'kertas_kerja');
        }
        
        // --- PERBAIKAN: Listener untuk tombol edit sekarang diarahkan ke fungsi yang benar ---
        editAuditBtn.addEventListener('click', handleEditAudit);

        closeModalBtn.addEventListener('click', () => modal.style.display = 'none');
        closeModalFooterBtn.addEventListener('click', () => modal.style.display = 'none');
        window.addEventListener('click', (event) => {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        });
        btnOpenPrintSelection.addEventListener('click', openPrintSelectionModal);
        closePrintSelectionModalBtn.addEventListener('click', () => printSelectionModal.style.display = 'none');
        btnGeneratePrintPreview.addEventListener('click', handlePrintSelection);
        closePrintPreviewModalBtn.addEventListener('click', () => printPreviewModal.style.display = 'none');

        const searchInput = document.getElementById('nama_auditor_search');
        const hiddenNameInput = document.getElementById('nama_auditor');
        const nipInput = document.getElementById('nip_auditor');
        const userListDiv = document.getElementById('nama_auditor_list');

        searchInput.addEventListener('focus', () => {
            renderUserDropdown(allUsers);
            userListDiv.classList.remove('hidden');
        });

        searchInput.addEventListener('input', () => {
            const query = searchInput.value.toLowerCase();
            if (query === '') {
                hiddenNameInput.value = '';
                nipInput.value = '';
                nipInput.readOnly = false;
            }
            const filteredUsers = allUsers.filter(user => user.nama.toLowerCase().includes(query));
            renderUserDropdown(filteredUsers);
            userListDiv.classList.remove('hidden');
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.searchable-dropdown')) {
                userListDiv.classList.add('hidden');
            }
        });
        
        function renderUserDropdown(users) {
            userListDiv.innerHTML = '';
            if (users.length === 0) {
                userListDiv.innerHTML = `<div class="searchable-dropdown-item text-gray-500">Tidak ditemukan</div>`;
                return;
            }
            users.forEach(user => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'searchable-dropdown-item';
                itemDiv.textContent = `${user.nama} (${user.nip})`;
                
                itemDiv.addEventListener('mousedown', () => {
                    searchInput.value = user.nama;
                    hiddenNameInput.value = user.nama;
                    nipInput.value = user.nip;
                    nipInput.readOnly = true;
                    userListDiv.classList.add('hidden');
                    handleDataChange();
                });
                userListDiv.appendChild(itemDiv);
            });
        }

        formTimAudit.addEventListener('reset', () => {
            setTimeout(() => { 
                searchInput.value = '';
                hiddenNameInput.value = '';
                nipInput.readOnly = false;
            }, 0);
        });

        dashboardFilterSatker.addEventListener('change', renderDashboard);
        dashboardFilterTahap.addEventListener('change', renderDashboard);
        btnGenerateSummary.addEventListener('click', handleAiSummaryGeneration);
        
    // --- FUNGSI UNTUK PRESENTASI AI ---

    async function handleGeneratePresentation() {
        const lhaContentEl = document.getElementById('lha-content');
        if (!lhaContentEl || !lhaContentEl.innerText.trim()) {
            alert("Tidak ada konten LHA untuk dibuatkan presentasi.");
            return;
        }

        const lhaText = lhaContentEl.innerText;
        showLoading("AI sedang menyusun presentasi...");

        const prompt = `
            Anda adalah seorang auditor ahli muda pada Inspektorat Jenderal Kementerian Agama yang bertugas menyusun bahan paparan PowerPoint berdasarkan draf Laporan Hasil Audit (LHA) berikut.

            DRAF LHA:
            ---
            ${lhaText}
            ---

            TUGAS ANDA:
            Susun ringkasan poin-poin utama dari LHA untuk sebuah presentasi "Expose Hasil Audit". Buat paparan yang fokus, jelas, dan strategis.

            STRUKTUR PAPARAN YANG DIMINTA:
            1.  **Simpulan Umum**: 1 slide berisi kesimpulan umum audit, menyoroti kekuatan dan kelemahan fundamental.
            2.  **Kelemahan Perencanaan**: 1-2 slide merinci kelemahan utama pada tahap perencanaan (misal: ketidakselarasan dokumen, perencanaan tidak berbasis kebutuhan, inefisiensi).
            3.  **Kelemahan Pelaksanaan**: 1-2 slide merinci isu material pada tahap pelaksanaan (misal: akuntabilitas, dokumentasi, pengelolaan anggaran/aset).
            4.  **Kelemahan Evaluasi & Pelaporan**: 1 slide tentang kelemahan proses evaluasi (misal: laporan bersifat kompilatif, proses tidak terstruktur).
            5.  **Kelemahan Pencapaian Hasil (Outcome)**: 1 slide tentang hasil akhir yang belum optimal (misal: Nilai AKIP stagnan).
            6.  **Temuan Keuangan**: 1-2 slide khusus merangkum temuan material bernilai rupiah dan temuan non-rupiah yang signifikan (misal: inefisiensi, indikasi kecurangan).
            7.  **Rekomendasi**: 1-2 slide khusus yang merangkum rekomendasi yang bersifat stratesi dan rekomendasi bersifat teknis.
            Pastikan paparan mengalir dengan mulus, menjelaskan temuan-temuan signifikan, material dan strategis pada tahap perencanaan, pelaksanaan, evaluasi dan pelaporan, serta pencapaian hasil/outcome
            INSTRUKSI FORMAT OUTPUT:
            Respons HARUS dalam format array JSON yang valid. Setiap objek dalam array mewakili satu slide konten. Setiap objek HARUS memiliki properti "title" (string untuk judul slide, contoh: "Simpulan Umum" atau "Kelemahan Tahap Perencanaan") dan "content" (sebuah array of strings, di mana setiap string adalah satu bullet point untuk isi slide). Jangan sertakan teks atau penjelasan lain di luar array JSON.
            `;

        try {
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "title": { "type": "STRING" },
                                "content": {
                                    "type": "ARRAY",
                                    "items": { "type": "STRING" }
                                }
                            },
                            required: ["title", "content"]
                        }
                    }
                }
            };

            const apiKey = "AIzaSyBp2bF8al-3Wg9Tk-n93Nr91i87ttMzJEc"; // Dikosongkan sesuai instruksi
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`API request failed with status ${response.status}`);
            }

            const result = await response.json();

            if (result.candidates && result.candidates[0].content.parts[0].text) {
                const content = result.candidates[0].content.parts[0].text;
                const parsedSlides = JSON.parse(content);
                renderPresentation(parsedSlides);
            } else {
                throw new Error("Respons AI tidak valid atau kosong.");
            }

        } catch (error) {
            console.error("Gagal membuat presentasi AI:", error);
            alert(`Terjadi kesalahan saat membuat presentasi: ${error.message}`);
        } finally {
            hideLoading();
        }
    }

    function renderPresentation(slidesData) {
        if (!slidesData || slidesData.length === 0) {
            alert("AI tidak menghasilkan slide. Coba lagi.");
            return;
        }

        const satkerName = document.getElementById('nama_satuan_kerja').value || '(Nama Satuan Kerja)';
        const teamHtml = auditTeam.map(member => `<div>${member.name}</div>`).join('');

        slideContainer.innerHTML = ''; // Hapus slide sebelumnya

        // 1. Buat Slide Judul
        const titleSlide = document.createElement('div');
        titleSlide.className = 'slide slide-titlepage';
        titleSlide.id = 'slide-0';
        titleSlide.innerHTML = `
            <div>
                <h1>EXPOSE HASIL AUDIT</h1>
                <h2>Pada ${satkerName}</h2>
                <div class="team-list">${teamHtml}</div>
            </div>
        `;
        slideContainer.appendChild(titleSlide);

        // 2. Buat Slide Konten dari AI
        slidesData.forEach((slide, index) => {
            const contentHtml = slide.content.map(point => `<li>${point}</li>`).join('');
            const slideElement = document.createElement('div');
            slideElement.className = 'slide';
            slideElement.id = `slide-${index + 1}`; // Index dimulai dari 1
            slideElement.innerHTML = `
                <div class="slide-content-layout">
                    <h2 class="slide-title">${slide.title}</h2>
                    <div class="slide-content">
                        <ul>${contentHtml}</ul>
                    </div>
                </div>
            `;
            slideContainer.appendChild(slideElement);
        });

        // 3. Buat Slide Terima Kasih
        const thankYouSlide = document.createElement('div');
        thankYouSlide.className = 'slide slide-thankyou';
        thankYouSlide.id = `slide-${slidesData.length + 1}`;
        thankYouSlide.innerHTML = `<h1>Terima Kasih</h1>`;
        slideContainer.appendChild(thankYouSlide);
        
        // 4. Atur state untuk navigasi
        presentationSlides = [{}, ...slidesData, {}]; // Array dummy untuk menyesuaikan panjang
        currentSlideIndex = 0;
        presentationModal.style.display = 'flex';
        updateSlideView();
    }

    function updateSlideView() {
        document.querySelectorAll('.slide').forEach((slide, index) => {
            slide.classList.toggle('active', index === currentSlideIndex);
        });

        slideCounter.textContent = `Slide ${currentSlideIndex + 1} dari ${presentationSlides.length}`;
        prevSlideBtn.disabled = currentSlideIndex === 0;
        nextSlideBtn.disabled = currentSlideIndex === presentationSlides.length - 1;
    }

    function showNextSlide() {
        if (currentSlideIndex < presentationSlides.length - 1) {
            currentSlideIndex++;
            updateSlideView();
        }
    }

    function showPreviousSlide() {
        if (currentSlideIndex > 0) {
            currentSlideIndex--;
            updateSlideView();
        }
    }            

    </script>
    
<!-- ======================================================= -->
<!-- MULAI: Kode Notifikasi Pembaruan Aplikasi             -->
<!-- ======================================================= -->

    <script>
    const notification = document.getElementById('notification');
    const notificationTitle = document.getElementById('notification-title');
    const notificationMessage = document.getElementById('notification-message');
    const closeButton = document.getElementById('close-notification');
    const restartButton = document.getElementById('restart-app');

    if (window.electronAPI) {
    
        // Saat pengecekan dimulai
        window.electronAPI.onUpdateChecking(() => {
            notificationTitle.textContent = 'Memeriksa Pembaruan';
            notificationMessage.textContent = 'Menghubungi server untuk memeriksa versi terbaru...';
            restartButton.style.display = 'none'; // Sembunyikan tombol restart
            closeButton.textContent = 'Tutup';
            notification.style.display = 'flex';
        });

        // Saat tidak ada pembaruan ditemukan
        window.electronAPI.onUpdateNotAvailable(() => {
            notificationTitle.textContent = 'Tidak Ada Pembaruan';
            notificationMessage.textContent = 'Anda sudah menggunakan versi aplikasi yang terbaru.';
            restartButton.style.display = 'none';
            closeButton.textContent = 'OK';
            notification.style.display = 'flex';
            // Sembunyikan notifikasi setelah 3 detik
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        });
        
        // Saat pembaruan ditemukan dan sedang diunduh
        window.electronAPI.onUpdateAvailable(() => {
            notificationTitle.textContent = 'Pembaruan Ditemukan';
            notificationMessage.textContent = 'Mengunduh versi baru di latar belakang. Anda akan diberi tahu jika sudah selesai.';
            restartButton.style.display = 'none';
            closeButton.textContent = 'OK';
            notification.style.display = 'flex';
        });

        // Saat pembaruan telah selesai diunduh
        window.electronAPI.onUpdateDownloaded(() => {
            notificationTitle.textContent = 'Pembaruan Siap Diinstal';
            notificationMessage.textContent = 'Versi baru telah diunduh. Mulai ulang aplikasi untuk menerapkan pembaruan.';
            restartButton.style.display = 'inline-flex'; // Tampilkan kembali tombol restart
            closeButton.textContent = 'Nanti';
            notification.style.display = 'flex';
        });

        // Saat terjadi error
        window.electronAPI.onUpdateError((error) => {
            notificationTitle.textContent = 'Gagal Memperbarui';
            notificationMessage.textContent = 'Terjadi kesalahan saat memeriksa pembaruan. Silakan periksa koneksi internet Anda.';
            restartButton.style.display = 'none';
            closeButton.textContent = 'Tutup';
            notification.style.display = 'flex';
            console.error('Update error:', error);
        });

        // Logika untuk tombol
        closeButton.addEventListener('click', () => {
            notification.style.display = 'none';
        });

        restartButton.addEventListener('click', () => {
            window.electronAPI.restartApp();
        });
    }

    </script>
</body>
</html>
...im...


